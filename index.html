<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Things to Do ‚Äî Jordan</title>
    <style>
        /* --- 1. Variables y Dise√±o Global (Tokens) --- */
        :root {
            --font-sans: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;

            /* Paleta de Colores (Modo Oscuro) */
            --bg: #111827;        /* Fondo principal (m√°s oscuro) */
            --panel: #1f2937;     /* Paneles y tarjetas (un poco m√°s claro) */
            --border: #374151;   /* Bordes y separadores */
            --text: #f3f4f6;      /* Texto principal */
            --muted: #9ca3af;     /* Texto secundario y placeholders */
            --input: #111827;     /* Fondo de inputs */
            
            --primary: #60a5fa;   /* Azul primario */
            --primary-focus: #3b82f6;
            --accent: #34d399;    /* Verde menta */
            --danger: #f87171;    /* Rojo suave */
            --warning: #fbbf24;   /* √Åmbar */
            
            --shadow-color: 22, 29, 44;
            --shadow-sm: 0 1px 2px 0 rgb(var(--shadow-color) / 0.15);
            --shadow-md: 0 4px 6px -1px rgb(var(--shadow-color) / 0.15), 0 2px 4px -2px rgb(var(--shadow-color) / 0.15);
            --shadow-lg: 0 10px 15px -3px rgb(var(--shadow-color) / 0.2), 0 4px 6px -4px rgb(var(--shadow-color) / 0.2);

            /* M√©tricas de Dise√±o */
            --spacing-unit: 8px;
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .light {
            /* Paleta de Colores (Modo Claro) */
            --bg: #f9fafb;
            --panel: #ffffff;
            --border: #e5e7eb;
            --text: #1f2937;
            --muted: #6b7280;
            --input: #f3f4f6;

            --primary: #3b82f6;
            --primary-focus: #2563eb;
            --accent: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;

            --shadow-color: 180, 190, 210;
        }

        /* --- 2. Reseteo y Estilos Base --- */
        *, *::before, *::after { box-sizing: border-box; }
        html, body { height: 100%; }
        body {
            margin: 0;
            font-family: var(--font-sans);
            background-color: var(--bg);
            color: var(--text);
            transition: background-color var(--transition-base), color var(--transition-base);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        h1, h2, h3, h4, p, ul { margin: 0; padding: 0; }
        ul { list-style: none; }
        button, input, select, textarea { font: inherit; color: inherit; }
        :focus-visible {
            outline: 2px solid var(--primary-focus);
            outline-offset: 2px;
            border-radius: var(--radius-sm);
        }

        /* --- 3. Estructura y Layout Principal --- */
        .app {
            display: grid;
            grid-template-columns: 340px 1fr;
            gap: calc(var(--spacing-unit) * 2);
            max-width: 1400px;
            margin: 0 auto;
            padding: calc(var(--spacing-unit) * 2);
        }

        header.appbar {
            grid-column: 1 / -1;
            background-color: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 2);
            position: sticky;
            top: var(--spacing-unit);
            z-index: 10;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-unit) * 2);
            transition: background-color var(--transition-base), border-color var(--transition-base);
        }
        
        aside {
            position: sticky;
            top: 86px; /* Altura de appbar + gap */
            align-self: start;
            display: grid;
            gap: calc(var(--spacing-unit) * 2);
        }

        main {
            display: grid;
            gap: calc(var(--spacing-unit) * 2);
            align-content: start;
        }

        footer {
            grid-column: 1 / -1;
            text-align: center;
            color: var(--muted);
            padding: var(--spacing-unit);
            font-size: 0.8rem;
        }

        /* --- 4. Componentes Reutilizables --- */
        
        /* Card */
        .card {
            background-color: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: calc(var(--spacing-unit) * 2);
            box-shadow: var(--shadow-md);
            transition: all var(--transition-base);
        }
        .card-header {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: calc(var(--spacing-unit) * 2);
        }

        /* Botones */
        .btn, .iconbtn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-unit);
            height: 40px;
            padding: 0 calc(var(--spacing-unit) * 2);
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-base);
            user-select: none;
            border: 1px solid transparent;
        }
        .iconbtn { width: 40px; padding: 0; flex-shrink: 0; }
        .btn:active, .iconbtn:active { transform: scale(0.97); }
        .btn:disabled, .iconbtn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn.primary { background-color: var(--primary); color: white; border-color: var(--primary); }
        .btn.primary:hover { background-color: var(--primary-focus); border-color: var(--primary-focus); }
        
        .btn.secondary { background-color: var(--accent); color: white; border-color: var(--accent); }
        .btn.secondary:hover { background-color: color-mix(in srgb, var(--accent), #000 10%); border-color: color-mix(in srgb, var(--accent), #000 10%);}

        .btn.ghost, .iconbtn { background-color: transparent; color: var(--muted); border-color: var(--border); }
        .btn.ghost:hover, .iconbtn:hover { background-color: var(--border); color: var(--text); }
        
        .btn.danger { background-color: var(--danger); color: white; border-color: var(--danger); }
        .btn.danger:hover { background-color: color-mix(in srgb, var(--danger), #000 10%); border-color: color-mix(in srgb, var(--danger), #000 10%);}

        /* Formularios */
        .form-group { margin-bottom: calc(var(--spacing-unit) * 1.5); }
        .form-group label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--muted);
            margin-bottom: var(--spacing-unit);
        }
        .form-control {
            width: 100%;
            height: 40px;
            background-color: var(--input);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 0 calc(var(--spacing-unit) * 1.5);
            outline: none;
            transition: all var(--transition-base);
        }
        textarea.form-control { height: auto; min-height: 80px; padding-top: var(--spacing-unit); resize: vertical; }
        .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary), transparent 70%); }
        .form-row { display: flex; gap: var(--spacing-unit); align-items: flex-end; }
        .form-row > * { flex: 1; }

        /* Pill / Badge */
        .pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            background-color: var(--input);
            border: 1px solid var(--border);
            color: var(--muted);
        }
        .dot { width: 8px; height: 8px; border-radius: 50%; }

        /* --- 5. Componentes Espec√≠ficos de la App --- */
        
        /* Appbar */
        .brand { display: flex; align-items: center; gap: 10px; font-weight: 600; font-size: 1.1rem; }
        .brand svg { width: 28px; height: 28px; color: var(--primary); }
        .search { flex: 1; position: relative; min-width: 150px; }
        .search .form-control { padding-left: 40px; }
        .search svg { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; opacity: 0.5; }
        .appbar-actions { display: flex; align-items: center; gap: var(--spacing-unit); }

        /* Lista de Tareas */
        .tasks-list { display: grid; gap: 10px; }
        .task {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background-color: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            transition: all var(--transition-base);
            animation: fadeIn 0.3s ease forwards;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .task[draggable="true"] { cursor: grab; }
        .task.dragging { opacity: 0.5; box-shadow: var(--shadow-lg); }
        .task.over { outline: 2px dashed var(--primary); }

        .task.completed { opacity: 0.6; }
        .task.completed .task-title, .task.completed .task-desc { text-decoration: line-through; color: var(--muted); }

        .checkbox {
            width: 22px; height: 22px;
            border-radius: var(--radius-sm);
            border: 2px solid var(--border);
            display: grid;
            place-items: center;
            background-color: var(--input);
            cursor: pointer;
            transition: all var(--transition-base);
        }
        .checkbox svg { width: 16px; height: 16px; opacity: 0; transform: scale(0.5); transition: all var(--transition-base); }
        .task.completed .checkbox { background-color: var(--accent); border-color: var(--accent); }
        .task.completed .checkbox svg { opacity: 1; transform: scale(1); color: white; }
        
        .task-main { display: grid; gap: 4px; }
        .task-title { font-weight: 600; line-height: 1.3; }
        .task-desc { color: var(--muted); font-size: 0.85rem; }
        [contenteditable="true"] { outline: 2px solid var(--primary); border-radius: var(--radius-sm); padding: 2px 4px; }

        .meta { display: flex; align-items: center; gap: var(--spacing-unit); flex-wrap: wrap; margin-top: 8px; }
        .prio.high { background-color: color-mix(in srgb, var(--danger), transparent 85%); color: var(--danger); }
        .prio.medium { background-color: color-mix(in srgb, var(--warning), transparent 85%); color: var(--warning); }
        .prio.low { background-color: color-mix(in srgb, var(--accent), transparent 85%); color: var(--accent); }
        .due.overdue { color: var(--danger); font-weight: 700; }
        .due.soon { color: var(--warning); font-weight: 700; }

        .task-actions { display: flex; gap: 6px; align-items: center; }
        .task-actions .iconbtn { width: 32px; height: 32px; }
        .task-actions .handle { cursor: grab; opacity: 0.4; }

        /* Filtros y Estad√≠sticas (Aside) */
        fieldset {
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 1.5) calc(var(--spacing-unit) * 1.5);
            margin: 0;
        }
        legend {
            padding: 0 8px;
            color: var(--muted);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: .05em;
        }
        .filter-radios { display: flex; gap: var(--spacing-unit); flex-wrap: wrap; }
        .filter-radios label { display: flex; align-items: center; gap: 6px; font-size: 0.9rem; }

        .stats .stat-row { display: flex; justify-content: space-between; align-items: baseline; font-size: 0.9rem; margin-bottom: var(--spacing-unit); }
        .stats .stat-row strong { font-size: 1rem; font-weight: 600; }
        .progress { height: 12px; border-radius: 999px; background-color: var(--input); border: 1px solid var(--border); overflow: hidden; margin-bottom: 12px; }
        .progress > div { height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); transition: width 0.5s ease; }
        .catbars { display: grid; gap: 8px; }
        .catbar { display: grid; grid-template-columns: 100px 1fr auto; gap: 8px; align-items: center; font-size: 0.8rem; }
        .catbar .bar { height: 8px; border-radius: 999px; background-color: var(--input); border: 1px solid var(--border); overflow: hidden; }
        .catbar .bar > div { height: 100%; transition: width 0.5s ease; }
        .achievements { display: flex; gap: 8px; flex-wrap: wrap; }
        .badge-ach {
            display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px;
            border-radius: 999px; border: 1px dashed var(--border);
            background-color: var(--input); font-size: 0.8rem;
        }

        /* Toolbar (Main) */
        .toolbar { 
            display: flex; 
            flex-wrap: wrap;
            align-items: flex-end; 
            justify-content: space-between; 
            gap: var(--spacing-unit); 
        }
        .toolbar-group {
            display: flex;
            gap: var(--spacing-unit);
            align-items: flex-end;
            flex-wrap: wrap;
        }

        /* Vista por Fecha */
        .group { display: grid; gap: var(--spacing-unit); }
        .group h3 {
            margin: var(--spacing-unit) 0;
            font-size: 0.8rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: .08em;
            font-weight: 600;
        }

        /* DatePicker */
        .dp-wrapper { position: relative; }
        .dp-popover {
            position: absolute; z-index: 20; top: 100%; left: 0;
            margin-top: 6px; background-color: var(--panel); border: 1px solid var(--border);
            border-radius: var(--radius-lg); padding: 12px; box-shadow: var(--shadow-lg);
            width: 320px; animation: popIn 0.2s ease forwards;
        }
        @keyframes popIn { from { opacity: 0; transform: translateY(-10px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .dp { display: grid; gap: 10px; }
        .dp-header { display: flex; align-items: center; justify-content: space-between; }
        .dp-title { font-weight: 600; }
        .dp-nav { width: 32px; height: 32px; }
        .dp-week { font-size: 0.75rem; color: var(--muted); display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; }
        .dp-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .dp-day {
            aspect-ratio: 1/1; display: grid; place-items: center; padding: 0;
            border: 1px solid transparent; background-color: var(--input);
            border-radius: var(--radius-md); cursor: pointer;
        }
        .dp-day:hover { background-color: var(--border); }
        .dp-day.today { border-color: var(--primary); }
        .dp-day.selected { background-color: var(--primary); color: white; border-color: var(--primary); }
        .dp-day.outside { opacity: 0.35; pointer-events: none; }
        .dp-time { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr) auto auto; 
            gap: var(--spacing-unit); 
            align-items: flex-end; 
        }

        /* Toasts */
        .toasts { position: fixed; right: 16px; bottom: 16px; display: grid; gap: 8px; z-index: 999; }
        .toast {
            background-color: var(--panel); border: 1px solid var(--border); color: var(--text);
            padding: 12px 16px; border-radius: var(--radius-md); box-shadow: var(--shadow-lg);
            animation: slideInUp 0.3s ease, fadeOut 0.3s 2.2s ease forwards;
        }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(15px) } to { opacity: 1; transform: translateY(0) } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; transform: translateY(5px); } }

        /* --- 6. Clases de Utilidad y Responsividad --- */
        .sr-only {
            position: absolute !important; width: 1px !important; height: 1px !important;
            padding: 0 !important; margin: -1px !important; overflow: hidden !important;
            clip: rect(0, 0, 0, 0) !important; white-space: nowrap !important; border: 0 !important;
        }
        .hidden { display: none !important; }

        @media (max-width: 960px) {
            .app { grid-template-columns: 1fr; }
            aside { position: static; top: auto; }
            header.appbar { position: static; }
        }
        @media (max-width: 640px) {
            .app { padding: var(--spacing-unit); }
            header.appbar { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>

    <div class="app" id="app">
        <header class="appbar" role="banner">
            <div class="brand">
                <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2Zm1 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0Zm-3 3h4a1 1 0 0 1 1 1v8h-2v-3h-2v3H8v-8a1 1 0 0 1 1-1Z"/></svg>
                <span>Things to Do</span>
                <span class="pill" id="summaryPill" aria-live="polite">0 pendientes</span>
            </div>
            <div class="search" role="search">
                <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 5 1.5-1.5-5-5ZM9.5 14A4.5 4.5 0 1 1 14 9.5 4.505 4.505 0 0 1 9.5 14Z"/></svg>
                <label class="sr-only" for="searchInput">Buscar tareas</label>
                <input id="searchInput" class="form-control" type="text" placeholder="Buscar tareas..." />
            </div>
            <div class="appbar-actions">
                <button class="iconbtn" id="notifBtn" aria-label="Notificaciones de vencimiento" title="Notificaciones">
                    <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 22a2 2 0 0 0 2-2h-4a2 2 0 0 0 2 2Zm6-6V9a6 6 0 1 0-12 0v7l-2 2v1h16v-1l-2-2Z"/></svg>
                    <span id="notifCount" class="pill hidden">0</span>
                </button>
                <button class="iconbtn" id="themeToggle" aria-pressed="false" aria-label="Cambiar tema" title="Cambiar tema">
                    <svg id="themeIcon" viewBox="0 0 24 24"></svg>
                </button>
            </div>
        </header>

        <aside aria-label="Panel lateral">
            <form id="addForm" class="card" aria-labelledby="addTitle">
                <h2 id="addTitle" class="card-header">Nueva Tarea</h2>
                <div class="form-group">
                    <label for="title">T√≠tulo *</label>
                    <input class="form-control" id="title" type="text" required placeholder="Ej. Estudiar cap√≠tulo..." />
                </div>
                <div class="form-group">
                    <label for="description">Descripci√≥n</label>
                    <textarea id="description" class="form-control" placeholder="Detalles adicionales..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="category">Categor√≠a</label>
                        <div class="form-row">
                            <select id="category" class="form-control"></select>
                            <button type="button" id="addCategoryBtn" class="iconbtn" title="Nueva categor√≠a">
                                <svg viewBox="0 0 24 24"><path fill="currentColor" d="M11 11V6h2v5h5v2h-5v5h-2v-5H6v-2h5Z"/></svg>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="priority">Prioridad</label>
                        <select id="priority" class="form-control">
                            <option value="high">Alta</option>
                            <option value="medium" selected>Media</option>
                            <option value="low">Baja</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="dueDate">Fecha L√≠mite</label>
                    <div class="dp-wrapper">
                        <input id="dueDate" type="text" class="form-control" placeholder="Opcional..." autocomplete="off" />
                        <button type="button" id="openCalendar" class="iconbtn" aria-label="Abrir calendario">
                            <svg viewBox="0 0 24 24"><path fill="currentColor" d="M7 2h2v2h6V2h2v2h3a1 1 0 0 1 1 1v3H3V5a1 1 0 0 1 1-1h3V2Zm14 7H3v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9ZM7 13h4v4H7v-4Z"/></svg>
                        </button>
                    </div>
                    <div id="dpPopover" class="dp-popover" role="dialog" hidden></div>
                </div>
                <div class="form-group">
                    <label for="tags">Etiquetas (separadas por comas)</label>
                    <input id="tags" class="form-control" type="text" placeholder="ej. examen, cardio" />
                </div>
                <div class="form-row" style="align-items: center;">
                    <button class="btn primary" type="submit">Agregar Tarea</button>
                    <button type="button" class="btn ghost" id="clearForm">Limpiar</button>
                </div>
            </form>

            <div class="card">
                <h2 class="card-header">Filtros</h2>
                <div class="form-group">
                    <fieldset>
                        <legend>Estado</legend>
                        <div class="filter-radios" role="radiogroup">
                            <label><input type="radio" name="state" value="all" checked> Todas</label>
                            <label><input type="radio" name="state" value="pending"> Pendientes</label>
                            <label><input type="radio" name="state" value="completed"> Completadas</label>
                        </div>
                    </fieldset>
                </div>
                <div class="form-row">
                     <div class="form-group">
                        <label for="filterCategory">Categor√≠a</label>
                        <select id="filterCategory" class="form-control"></select>
                    </div>
                     <div class="form-group">
                        <label for="filterPriority">Prioridad</label>
                        <select id="filterPriority" class="form-control">
                            <option value="all">Todas</option> <option value="high">Alta</option>
                            <option value="medium">Media</option> <option value="low">Baja</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="card stats" aria-live="polite">
                <h2 class="card-header">Estad√≠sticas</h2>
                <div class="stat-row"><strong>Progreso</strong><span id="progressText">0%</span></div>
                <div class="progress"><div id="progressBar"></div></div>
                <div id="catBars" class="catbars"></div>
                <h3 class="card-header" style="font-size: 1rem; margin-top: 16px;">Logros</h3>
                <div class="achievements" id="achievements"></div>
            </div>
        </aside>

        <main>
            <div class="card toolbar">
                <div class="toolbar-group">
                    <div class="form-group" style="margin:0;">
                        <label for="orderMode">Ordenar por</label>
                        <select id="orderMode" class="form-control">
                            <option value="auto" selected>Autom√°tico</option>
                            <option value="manual">Manual</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin:0;">
                        <label for="viewMode">Vista</label>
                        <select id="viewMode" class="form-control">
                            <option value="list" selected>Lista</option>
                            <option value="date">Por fecha</option>
                        </select>
                    </div>
                </div>
                 <div class="toolbar-group">
                    <button class="btn ghost" id="exportBtn">Exportar</button>
                    <label class="btn ghost" for="importFile">Importar</label>
                    <input id="importFile" type="file" accept=".json" class="sr-only" />
                    <button class="btn danger" id="clearAllBtn">Vaciar</button>
                </div>
            </div>

            <div id="listContainer" aria-label="Lista de tareas">
                </div>
        </main>

        <footer>
            <small>Hecho con ‚ù§Ô∏è para Jordan ‚Ä¢ 100% LocalStorage ‚Ä¢ Sin dependencias</small>
        </footer>
    </div>

    <div class="toasts" id="toasts" aria-live="polite" aria-atomic="true"></div>
    <div class="sr-only" id="a11yLive" aria-live="polite"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        const App = {
            state: {},
            elements: {},
            config: {
                STORAGE_KEY: 'ttd_jordan_v3', // Versi√≥n actualizada para evitar conflictos
                DEFAULT_DATA: {
                    tasks: [],
                    categories: [
                        { name: 'Personal', color: '#8b5cf6' }, { name: 'Estudio', color: '#22c55e' },
                        { name: 'Trabajo', color: '#3b82f6' }, { name: 'Salud', color: '#f97316' }
                    ],
                    settings: { theme: 'dark', orderMode: 'auto', viewMode: 'list' },
                    stats: { completedTotal: 0, streak: 0, lastCompleteDate: null, earlyCompletions: 0 }
                }
            },

            init() {
                this.cacheElements();
                this.loadState();
                this.applyTheme();
                this.ensureCategoryOptions();
                this.bindEvents();
                this.render();
                
                try {
                    this.datePicker = new DatePicker(this.elements.dueDate, this.elements.dpPopover, {
                        onSelect: () => this.utils.toast('Fecha establecida üìÖ'),
                        onClear: () => this.utils.toast('Fecha borrada')
                    });
                } catch(e) { console.error("Error inicializando DatePicker:", e); }
                
                setTimeout(() => this.showDueNotifications(), 600);
            },
            
            cacheElements() {
                this.elements = {
                    app: this.utils.$('#app'),
                    themeToggle: this.utils.$('#themeToggle'),
                    themeIcon: this.utils.$('#themeIcon'),
                    addForm: this.utils.$('#addForm'),
                    listContainer: this.utils.$('#listContainer'),
                    summaryPill: this.utils.$('#summaryPill'),
                    notifBtn: this.utils.$('#notifBtn'),
                    notifCount: this.utils.$('#notifCount'),
                    searchInput: this.utils.$('#searchInput'),
                    filterState: this.utils.$$('input[name="state"]'),
                    filterCategory: this.utils.$('#filterCategory'),
                    filterPriority: this.utils.$('#filterPriority'),
                    orderMode: this.utils.$('#orderMode'),
                    viewMode: this.utils.$('#viewMode'),
                    dueDate: this.utils.$('#dueDate'),
                    dpPopover: this.utils.$('#dpPopover')
                };
            },

            loadState() {
                try {
                    const data = localStorage.getItem(this.config.STORAGE_KEY);
                    this.state = data ? JSON.parse(data) : JSON.parse(JSON.stringify(this.config.DEFAULT_DATA));
                } catch {
                    this.state = JSON.parse(JSON.stringify(this.config.DEFAULT_DATA));
                }
            },

            saveState() {
                localStorage.setItem(this.config.STORAGE_KEY, JSON.stringify(this.state));
            },

            render() {
                this.renderTasks();
                this.renderStats();
                this.updateUIState();
            },
            
            renderTasks() {
                const tasks = this.getFilteredTasks();
                const view = this.state.settings.viewMode;
                this.elements.listContainer.innerHTML = '';
                
                const buildTaskHTML = (t) => {
                    const cat = this.state.categories.find(c => c.name === t.category) || { color: '#64748b' };
                    const overdue = this.utils.isOverdue(t.dueDate), soon = this.utils.isSoon(t.dueDate);
                    const tagsHTML = (t.tags || []).map(tag => `<span class="pill">#${this.utils.escapeHTML(tag)}</span>`).join('');
                    
                    return `
                        <div class="task ${t.completed ? 'completed' : ''}" data-id="${t.id}" role="listitem" ${this.state.settings.orderMode === 'manual' ? 'draggable="true"' : ''}>
                            <button class="checkbox" aria-label="Marcar como completada">
                                <svg viewBox="0 0 24 24"><path fill="currentColor" d="M20 7 9 18l-5-5 1.5-1.5L9 15l9.5-9.5L20 7Z"/></svg>
                            </button>
                            <div class="task-main">
                                <div class="task-title">${this.utils.escapeHTML(t.title)}</div>
                                ${t.description ? `<div class="task-desc">${this.utils.escapeHTML(t.description)}</div>` : ''}
                                <div class="meta">
                                    <span class="pill" title="Categor√≠a"><span class="dot" style="background:${cat.color}"></span>${this.utils.escapeHTML(t.category || 'General')}</span>
                                    <span class="pill prio ${t.priority}">${t.priority}</span>
                                    ${t.dueDate ? `<span class="pill due ${overdue ? 'overdue' : (soon ? 'soon' : '')}">${this.utils.niceDate(t.dueDate)}</span>` : ''}
                                    ${tagsHTML}
                                </div>
                            </div>
                            <div class="task-actions">
                                <button class="iconbtn deleteBtn" title="Eliminar"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M6 7h12l-1 14H7L6 7Zm3-4h6l1 3H8l1-3Z"/></svg></button>
                                ${this.state.settings.orderMode === 'manual' ? `<span class="handle" title="Arrastrar"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M10 4h4v2h-4V4Zm0 14h4v2h-4v-2ZM10 9h4v2h-4V9Zm0 5h4v2h-4v-2Z"/></svg></span>` : ''}
                            </div>
                        </div>`;
                };

                if (view === 'list') {
                    const list = document.createElement('div');
                    list.className = 'tasks-list';
                    tasks.forEach(t => list.innerHTML += buildTaskHTML(t));
                    this.elements.listContainer.appendChild(list);
                } else {
                    this.renderTasksByDate(tasks, buildTaskHTML);
                }
            },
            
            renderTasksByDate(tasks, buildTaskHTML) {
                const groups = [
                    { title: 'Vencidas', filter: t => !t.completed && this.utils.isOverdue(t.dueDate) },
                    { title: 'Hoy', filter: t => !t.completed && this.utils.isToday(t.dueDate) },
                    { title: 'Ma√±ana', filter: t => !t.completed && this.utils.isTomorrow(t.dueDate) },
                    { title: 'Pr√≥ximos 7 d√≠as', filter: t => !t.completed && this.utils.isNext7Days(t.dueDate) },
                    { title: 'Futuro', filter: t => !t.completed && this.utils.isFuture(t.dueDate) },
                    { title: 'Sin Fecha', filter: t => !t.completed && !t.dueDate },
                    { title: 'Completadas', filter: t => t.completed }
                ];

                groups.forEach(group => {
                    const filtered = tasks.filter(group.filter);
                    if (filtered.length > 0) {
                        const groupEl = document.createElement('div');
                        groupEl.className = 'group';
                        groupEl.innerHTML = `<h3>${group.title}</h3>`;
                        const list = document.createElement('div');
                        list.className = 'tasks-list';
                        filtered.forEach(t => list.innerHTML += buildTaskHTML(t));
                        groupEl.appendChild(list);
                        this.elements.listContainer.appendChild(groupEl);
                    }
                });
            },

            renderStats() {
                const { tasks } = this.state;
                const total = tasks.length;
                const completed = tasks.filter(t => t.completed).length;
                const pending = total - completed;
                const pct = total ? Math.round((completed / total) * 100) : 0;
                
                this.utils.$('#progressText').textContent = `${pct}%`;
                this.utils.$('#progressBar').style.width = `${pct}%`;
                this.elements.summaryPill.textContent = `${pending} pendiente${pending !== 1 ? 's' : ''}`;
                
                const catCounts = tasks.reduce((acc, t) => {
                    const cat = t.category || 'General';
                    acc[cat] = (acc[cat] || 0) + 1;
                    return acc;
                }, {});

                const catBarsEl = this.utils.$('#catBars');
                catBarsEl.innerHTML = '';
                for (const catName in catCounts) {
                    const count = catCounts[catName];
                    const catData = this.state.categories.find(c => c.name === catName) || { color: '#64748b' };
                    const width = total ? (count / total) * 100 : 0;
                    catBarsEl.innerHTML += `
                        <div class="catbar">
                            <span class="pill"><span class="dot" style="background:${catData.color}"></span>${this.utils.escapeHTML(catName)}</span>
                            <div class="bar"><div style="width:${width}%; background:${catData.color}"></div></div>
                            <strong>${count}</strong>
                        </div>`;
                }
                
                this.renderAchievements();
            },

            renderAchievements() {
                const container = this.utils.$('#achievements');
                container.innerHTML = '';
                const { stats } = this.state;
                const achievements = [
                    { icon: 'üöÄ', text: '¬°A por ello!', earned: stats.completedTotal > 0 },
                    { icon: '‚úÖ', text: '5 Tareas', earned: stats.completedTotal >= 5 },
                    { icon: 'üèÜ', text: '25 Tareas', earned: stats.completedTotal >= 25 },
                    { icon: 'üî•', text: `Racha ${stats.streak} d√≠as`, earned: stats.streak >= 3 },
                    { icon: '‚è∞', text: `${stats.earlyCompletions} a tiempo`, earned: stats.earlyCompletions >= 5 }
                ].filter(a => a.earned);

                if (achievements.length === 0) {
                    container.innerHTML = `<span class="badge-ach">üå± ¬°Completa tu primera tarea!</span>`;
                } else {
                    achievements.forEach(a => {
                        container.innerHTML += `<span class="badge-ach">${a.icon} ${a.text}</span>`;
                    });
                }
            },
            
            updateUIState() {
                this.elements.orderMode.value = this.state.settings.orderMode;
                this.elements.viewMode.value = this.state.settings.viewMode;
            },

            applyTheme() {
                const isLight = this.state.settings.theme === 'light';
                document.body.classList.toggle('light', isLight);
                this.elements.themeToggle.setAttribute('aria-pressed', isLight);
                this.elements.themeIcon.innerHTML = isLight
                    ? '<path fill="currentColor" d="M12 4a8 8 0 1 0 8 8 8.009 8.009 0 0 0-8-8Z"/>'
                    : '<path fill="currentColor" d="M9.37 5.51A7 7 0 1 0 18.49 14.63 8 8 0 0 1 9.37 5.51Z"/>';
            },

            ensureCategoryOptions() {
                const catSel = this.utils.$('#category');
                const filterCat = this.utils.$('#filterCategory');
                const opts = [{ name: '(Sin categor√≠a)', value: '' }, ...this.state.categories]
                    .map(c => `<option value="${this.utils.escapeHTML(c.name)}">${this.utils.escapeHTML(c.name)}</option>`).join('');
                
                catSel.innerHTML = opts;
                filterCat.innerHTML = '<option value="all">Todas</option>' + this.state.categories
                    .map(c => `<option value="${this.utils.escapeHTML(c.name)}">${this.utils.escapeHTML(c.name)}</option>`).join('');
            },
            
            showDueNotifications() {
                const dueSoon = this.state.tasks.filter(t => !t.completed && (this.utils.isOverdue(t.dueDate) || this.utils.isSoon(t.dueDate)));
                this.elements.notifCount.textContent = dueSoon.length;
                this.elements.notifCount.classList.toggle('hidden', dueSoon.length === 0);
                if (dueSoon.length > 0) {
                    this.utils.toast(`${dueSoon.length} tarea${dueSoon.length > 1 ? 's' : ''} pr√≥xima${dueSoon.length > 1 ? 's' : ''} a vencer.`);
                }
            },

            bindEvents() {
                this.elements.themeToggle.addEventListener('click', () => this.handleThemeToggle());
                this.elements.addForm.addEventListener('submit', (e) => this.handleAddTask(e));
                this.utils.$('#clearForm').addEventListener('click', () => this.elements.addForm.reset());
                this.utils.$('#addCategoryBtn').addEventListener('click', () => this.handleAddCategory());
                this.utils.$('#exportBtn').addEventListener('click', () => this.handleExport());
                this.utils.$('#importFile').addEventListener('change', (e) => this.handleImport(e));
                this.utils.$('#clearAllBtn').addEventListener('click', () => this.handleClearAll());
                this.elements.notifBtn.addEventListener('click', () => this.showDueNotifications());
                
                this.elements.listContainer.addEventListener('click', (e) => this.handleListClick(e));
                this.elements.listContainer.addEventListener('dragstart', (e) => this.handleDragStart(e));
                this.elements.listContainer.addEventListener('dragover', (e) => this.handleDragOver(e));
                this.elements.listContainer.addEventListener('dragleave', (e) => this.handleDragLeave(e));
                this.elements.listContainer.addEventListener('drop', (e) => this.handleDrop(e));
                
                this.elements.searchInput.addEventListener('input', this.utils.debounce(() => this.render(), 200));
                this.elements.filterState.forEach(r => r.addEventListener('change', () => this.render()));
                this.elements.filterCategory.addEventListener('change', () => this.render());
                this.elements.filterPriority.addEventListener('change', () => this.render());
                this.elements.orderMode.addEventListener('change', (e) => this.handleSettingChange('orderMode', e.target.value));
                this.elements.viewMode.addEventListener('change', (e) => this.handleSettingChange('viewMode', e.target.value));
                this.utils.$('#openCalendar').addEventListener('click', () => this.datePicker.open());
            },

            handleThemeToggle() {
                this.state.settings.theme = this.state.settings.theme === 'light' ? 'dark' : 'light';
                this.applyTheme();
                this.saveState();
            },
            
            handleAddTask(e) {
                e.preventDefault();
                const form = e.target;
                const title = form.title.value.trim();
                if (!title) {
                    this.utils.toast('El t√≠tulo es obligatorio', 'warning');
                    form.title.focus(); return;
                }
                const now = new Date().toISOString();
                const task = {
                    id: this.utils.uid(), title, completed: false,
                    description: form.description.value.trim(), category: form.category.value,
                    priority: form.priority.value,
                    dueDate: form.dueDate.value ? new Date(form.dueDate.value).toISOString() : null,
                    tags: form.tags.value.split(',').map(t => t.trim()).filter(Boolean),
                    createdAt: now, updatedAt: now, orderIndex: Date.now()
                };
                this.state.tasks.push(task);
                this.saveState(); this.render();
                this.utils.toast('Tarea agregada ‚úÖ');
                form.reset(); form.title.focus();
            },
            
            handleAddCategory() {
                const name = prompt('Nombre de la nueva categor√≠a:');
                if (!name) return;
                const exists = this.state.categories.some(c => c.name.toLowerCase() === name.toLowerCase());
                if (exists) return this.utils.toast('Esa categor√≠a ya existe', 'warning');
                this.state.categories.push({ name, color: this.utils.randomColor() });
                this.saveState(); this.ensureCategoryOptions();
                this.utils.$('#category').value = name; this.utils.toast('Categor√≠a creada');
            },

            handleListClick(e) {
                const taskEl = e.target.closest('.task'); if (!taskEl) return;
                const id = taskEl.dataset.id;
                if (e.target.closest('.checkbox')) this.handleToggleComplete(id);
                if (e.target.closest('.deleteBtn')) this.handleDeleteTask(id);
            },

            handleToggleComplete(id) {
                const task = this.state.tasks.find(t => t.id === id); if (!task) return;
                task.completed = !task.completed;
                task.updatedAt = new Date().toISOString();
                if (task.completed) this.updateCompletionStats(task);
                this.saveState(); this.render();
            },
            
            handleDeleteTask(id) {
                const task = this.state.tasks.find(t => t.id === id);
                if (confirm(`¬øSeguro que quieres eliminar "${task.title}"?`)) {
                    this.state.tasks = this.state.tasks.filter(t => t.id !== id);
                    this.saveState(); this.render(); this.utils.toast('Tarea eliminada üóëÔ∏è');
                }
            },
            
            handleExport() {
                const blob = new Blob([JSON.stringify(this.state, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'things-to-do.json'; a.click(); URL.revokeObjectURL(url);
            },

            handleImport(e) {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (!data || !Array.isArray(data.tasks)) throw new Error('Archivo inv√°lido');
                        this.state = data;
                        this.saveState(); this.applyTheme(); this.ensureCategoryOptions(); this.render();
                        this.utils.toast('Datos importados con √©xito ‚úÖ');
                    } catch (err) { this.utils.toast('Error al importar el archivo', 'danger'); }
                };
                reader.readAsText(file); e.target.value = '';
            },

            handleClearAll() {
                if (confirm('¬øELIMINAR TODAS LAS TAREAS? Esta acci√≥n es irreversible.')) {
                    this.state.tasks = [];
                    this.state.stats = JSON.parse(JSON.stringify(this.config.DEFAULT_DATA.stats));
                    this.saveState(); this.render(); this.utils.toast('Todas las tareas han sido eliminadas.');
                }
            },
            
            handleSettingChange(key, value) {
                this.state.settings[key] = value;
                this.saveState(); this.render();
            },

            draggedEl: null,
            handleDragStart(e) {
                if (this.state.settings.orderMode !== 'manual') return;
                this.draggedEl = e.target.closest('.task');
                this.draggedEl.classList.add('dragging');
            },
            handleDragOver(e) {
                e.preventDefault(); if (this.state.settings.orderMode !== 'manual') return;
                const overEl = e.target.closest('.task');
                if (overEl && overEl !== this.draggedEl) {
                    this.utils.$$('.task.over').forEach(el => el.classList.remove('over'));
                    overEl.classList.add('over');
                }
            },
            handleDragLeave(e) { const el = e.target.closest('.task'); if (el) el.classList.remove('over'); },
            handleDrop(e) {
                e.preventDefault(); if (!this.draggedEl) return;
                const dropTarget = e.target.closest('.task');
                this.draggedEl.classList.remove('dragging');
                this.utils.$$('.task.over').forEach(el => el.classList.remove('over'));
                if (dropTarget && dropTarget !== this.draggedEl) {
                    const srcId = this.draggedEl.dataset.id, dstId = dropTarget.dataset.id;
                    const tasks = this.state.tasks;
                    const srcIdx = tasks.findIndex(t => t.id === srcId), dstIdx = tasks.findIndex(t => t.id === dstId);
                    const [item] = tasks.splice(srcIdx, 1); tasks.splice(dstIdx, 0, item);
                    tasks.forEach((t, i) => t.orderIndex = i);
                    this.saveState(); this.render();
                }
                this.draggedEl = null;
            },
            
            getFilteredTasks() {
                let tasks = [...this.state.tasks];
                const q = this.elements.searchInput.value.toLowerCase();
                const stateFilter = this.utils.$('input[name="state"]:checked').value;
                const cat = this.elements.filterCategory.value;
                const pr = this.elements.filterPriority.value;
                if (q) tasks = tasks.filter(t => [t.title, t.description, ...(t.tags || [])].join(' ').toLowerCase().includes(q));
                if (stateFilter === 'pending') tasks = tasks.filter(t => !t.completed);
                if (stateFilter === 'completed') tasks = tasks.filter(t => t.completed);
                if (cat !== 'all') tasks = tasks.filter(t => t.category === cat);
                if (pr !== 'all') tasks = tasks.filter(t => t.priority === pr);

                if (this.state.settings.orderMode === 'manual') {
                    tasks.sort((a, b) => (a.orderIndex || 0) - (b.orderIndex || 0));
                } else {
                    tasks.sort((a, b) => {
                        if (a.completed !== b.completed) return a.completed ? 1 : -1;
                        const prio = { high: 3, medium: 2, low: 1 };
                        if (prio[b.priority] !== prio[a.priority]) return prio[b.priority] - prio[a.priority];
                        const da = a.dueDate ? new Date(a.dueDate) : Infinity, db = b.dueDate ? new Date(b.dueDate) : Infinity;
                        if (da !== db) return da - db;
                        return new Date(a.createdAt) - new Date(b.createdAt);
                    });
                }
                return tasks;
            },
            
            updateCompletionStats(task) {
                const { stats } = this.state;
                const today = new Date();
                const ymd = today.toISOString().slice(0, 10);
                if (stats.lastCompleteDate) {
                    const prev = new Date(stats.lastCompleteDate);
                    const diffDays = Math.floor((today - prev) / 864e5);
                    if (diffDays === 1) stats.streak++; else if (diffDays > 1) stats.streak = 1;
                } else { stats.streak = 1; }
                stats.lastCompleteDate = ymd;
                stats.completedTotal++;
                if (task.dueDate && new Date(task.dueDate) > new Date()) { stats.earlyCompletions++; }
            },
            
            utils: {
                $: (sel, el = document) => el.querySelector(sel),
                $$: (sel, el = document) => Array.from(el.querySelectorAll(sel)),
                uid: () => Math.random().toString(36).slice(2) + Date.now().toString(36),
                escapeHTML: (str = '') => str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', '\'': '&#39;' }[m])),
                niceDate: (iso) => !iso ? '‚Äî' : new Intl.RelativeTimeFormat('es', { numeric: 'auto' }).format(Math.round((new Date(iso)-new Date())/864e5), 'day'),
                isOverdue: iso => iso && new Date(iso) < new Date(),
                isSoon: iso => iso && (new Date(iso) - new Date() <= 864e5 && new Date(iso) > new Date()),
                isToday: iso => iso && new Date(iso).toDateString() === new Date().toDateString(),
                isTomorrow: iso => { if (!iso) return false; const t = new Date(); t.setDate(t.getDate() + 1); return new Date(iso).toDateString() === t.toDateString(); },
                isNext7Days: iso => iso && new Date(iso) > new Date() && new Date(iso) - new Date() <= 7 * 864e5,
                isFuture: iso => iso && new Date(iso) - new Date() > 7 * 864e5,
                toast(msg, type = 'success') {
                    const t = document.createElement('div');
                    t.className = `toast ${type}`; t.textContent = msg;
                    document.getElementById('toasts').appendChild(t);
                    document.getElementById('a11yLive').textContent = msg;
                    setTimeout(() => t.remove(), 2500);
                },
                debounce(fn, wait) { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); }; },
                randomColor: () => `hsl(${Math.floor(Math.random() * 360)}, 70%, 60%)`
            }
        };
        
        class DatePicker {
            constructor(inputEl, popoverEl, options = {}) {
                this.input = inputEl; this.popover = popoverEl; this.options = options;
                this.visible = false; this.build(); this.bind();
            }
            format(d) { return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}T${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`; }
            parse(s) { const d = new Date(s); return isNaN(d) ? null : d; }
            build() {
                this.popover.innerHTML = `
                    <div class="dp">
                        <div class="dp-header">
                            <button class="iconbtn dp-nav prev" aria-label="Mes anterior">‚óÄ</button>
                            <div class="dp-title"></div>
                            <button class="iconbtn dp-nav next" aria-label="Mes siguiente">‚ñ∂</button>
                        </div>
                        <div class="dp-week">Lu Ma Mi Ju Vi Sa Do</div>
                        <div class="dp-grid"></div>
                        <div class="dp-time">
                            <div class="form-group" style="margin:0;"><label>Hora</label><input class="form-control" type="number" min="0" max="23" id="dpHour"></div>
                            <div class="form-group" style="margin:0;"><label>Min</label><input class="form-control" type="number" min="0" max="59" step="5" id="dpMin"></div>
                            <button class="btn ghost clearBtn" type="button">Limpiar</button>
                            <button class="btn primary setBtn" type="button">OK</button>
                        </div>
                    </div>`;
                this.grid = this.popover.querySelector('.dp-grid');
                this.titleEl = this.popover.querySelector('.dp-title');
                this.hourEl = this.popover.querySelector('#dpHour');
                this.minEl = this.popover.querySelector('#dpMin');
            }
            renderGrid() {
                const y = this.viewDate.getFullYear(), m = this.viewDate.getMonth();
                const first = new Date(y, m, 1);
                const startDay = (first.getDay() + 6) % 7;
                const startDate = new Date(first); startDate.setDate(1 - startDay);
                
                const title = new Intl.DateTimeFormat('es', { month: 'long', year: 'numeric' }).format(first);
                this.titleEl.textContent = title.charAt(0).toUpperCase() + title.slice(1);

                let html = '';
                for (let i = 0; i < 42; i++) {
                    const d = new Date(startDate); d.setDate(startDate.getDate() + i);
                    const classes = ['dp-day'];
                    if (d.getMonth() !== m) classes.push('outside');
                    if (d.toDateString() === new Date().toDateString()) classes.push('today');
                    if (this.selDate && d.toDateString() === this.selDate.toDateString()) classes.push('selected');
                    html += `<button class="${classes.join(' ')}" data-date="${d.toISOString()}">${d.getDate()}</button>`;
                }
                this.grid.innerHTML = html;
            }
            bind() {
                this.popover.addEventListener('click', e => {
                    const dayBtn = e.target.closest('.dp-day');
                    if (dayBtn) { this.selDate = new Date(dayBtn.dataset.date); this.updateTime(); this.renderGrid(); }
                    if (e.target.closest('.setBtn')) this.setDate();
                    if (e.target.closest('.prev')) this.navigateMonth(-1);
                    if (e.target.closest('.next')) this.navigateMonth(1);
                    if (e.target.closest('.clearBtn')) this.clear();
                });
                
                [this.hourEl, this.minEl].forEach(el => el.addEventListener('change', () => this.updateTime()));
                document.addEventListener('keydown', this._escHandler = e => { if (this.visible && e.key === 'Escape') this.close(); });
                document.addEventListener('click', this._outsideHandler = e => {
                    if (this.visible && !this.popover.contains(e.target) && !this.input.contains(e.target) && e.target.closest('#openCalendar') === null) {
                        this.close();
                    }
                });
            }
            setDate() {
                if (!this.selDate) this.selDate = new Date();
                this.updateTime();
                this.input.value = this.format(this.selDate);
                if (this.options.onSelect) this.options.onSelect();
                this.close();
            }
            updateTime() {
                if (!this.selDate) return;
                const h = parseInt(this.hourEl.value) || 0;
                const m = parseInt(this.minEl.value) || 0;
                this.selDate.setHours(h, m);
            }
            navigateMonth(dir) { this.viewDate.setMonth(this.viewDate.getMonth() + dir); this.renderGrid(); }
            clear() {
                this.input.value = ''; this.selDate = null;
                if (this.options.onClear) this.options.onClear();
                this.close();
            }
            open() {
                const seed = this.parse(this.input.value) || new Date();
                this.selDate = this.parse(this.input.value);
                this.viewDate = new Date(seed.getFullYear(), seed.getMonth(), 1);
                this.hourEl.value = String(seed.getHours()).padStart(2,'0');
                this.minEl.value = String(seed.getMinutes() - (seed.getMinutes()%5)).padStart(2,'0');
                this.renderGrid(); this.popover.hidden = false; this.visible = true;
            }
            close() { this.popover.hidden = true; this.visible = false; }
        }

        App.init();
    });
    </script>
</body>
</html>
