<!DOCTYPE html>
<html lang="es" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamService Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .view { display: none; }
        .view.active { display: block; }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        .dark ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }

        .custom-checkbox {
            appearance: none; width: 18px; height: 18px; border: 2px solid #d1d5db;
            border-radius: 4px; background-color: white; position: relative;
            cursor: pointer; transition: all 0.2s;
        }
        .dark .custom-checkbox { border-color: #4b5563; background-color: #374151; }
        .custom-checkbox:checked { background-color: #3b82f6; border-color: #3b82f6; }
        .custom-checkbox:checked::after {
            content: '✓'; color: white; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); font-size: 12px; font-weight: bold;
        }
        
        #sidebar {
            transition: width 0.3s ease-in-out;
        }
        #sidebar.collapsed {
            width: 5rem;
        }
        #sidebar.collapsed .nav-text, #sidebar.collapsed .sidebar-toggle-text {
            display: none;
        }
        #sidebar.collapsed .nav-link, #sidebar.collapsed #sidebar-toggle {
            justify-content: center;
        }
        #sidebar #sidebar-toggle-icon {
            transition: transform 0.3s ease-in-out;
        }
        #sidebar.collapsed #sidebar-toggle-icon {
            transform: rotate(180deg);
        }
        main {
            transition: margin-left 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200">
    <div id="app-loader" class="fixed inset-0 bg-slate-100 dark:bg-slate-900 flex flex-col items-center justify-center z-50 transition-opacity duration-300">
        <svg class="animate-spin h-10 w-10 text-blue-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-lg">Conectando a la base de datos...</p>
    </div>

    <div id="app-content" class="flex h-screen opacity-0 transition-opacity duration-300">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-white dark:bg-slate-800/50 border-r border-slate-200 dark:border-slate-700 flex flex-col flex-shrink-0">
            <div class="p-4 border-b border-slate-200 dark:border-slate-700 flex-shrink-0">
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white"><span class="nav-text">StreamService Pro</span></h1>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <a href="#dashboard" class="nav-link flex items-center px-3 py-2 rounded-md font-medium bg-slate-200 dark:bg-slate-700">
                    <svg class="h-6 w-6 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                    <span class="nav-text">Dashboard</span>
                </a>
                <a href="#clients" class="nav-link flex items-center px-3 py-2 rounded-md font-medium hover:bg-slate-200 dark:hover:bg-slate-700">
                     <svg class="h-6 w-6 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197M15 21a6 6 0 006-6v-1a3 3 0 00-3-3H9a3 3 0 00-3 3v1a6 6 0 006 6z"/></svg>
                     <span class="nav-text">Clientes</span>
                </a>
                <a href="#settings" class="nav-link flex items-center px-3 py-2 rounded-md font-medium hover:bg-slate-200 dark:hover:bg-slate-700">
                    <svg class="h-6 w-6 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    <span class="nav-text">Ajustes</span>
                </a>
            </nav>
            <div class="p-4 border-t border-slate-200 dark:border-slate-700 space-y-4 flex-shrink-0">
                 <button id="sidebar-toggle" class="w-full flex items-center px-3 py-2 rounded-md font-medium text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700">
                    <svg id="sidebar-toggle-icon" class="h-6 w-6 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" /></svg>
                    <span class="sidebar-toggle-text">Contraer</span>
                </button>
                <label for="dark-mode-toggle" class="flex items-center cursor-pointer">
                    <div class="relative">
                        <input type="checkbox" id="dark-mode-toggle" class="sr-only">
                        <div class="block bg-slate-300 dark:bg-slate-600 w-14 h-8 rounded-full"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div>
                    </div>
                    <div class="ml-3 font-medium nav-text">Modo Oscuro</div>
                </label>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto">
            <!-- Vistas se renderizarán aquí -->
        </main>
    </div>

    <!-- Notificación -->
    <div id="notificacion" class="fixed top-4 right-4 z-50"></div>
    
    <!-- Modales -->
    <div id="client-modal" class="fixed inset-0 z-40 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0"></div><div class="modal-content bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-md m-4 relative max-h-full overflow-y-auto"><form id="client-form" class="p-6"><h3 id="client-modal-title" class="text-xl font-semibold mb-4"></h3><div class="space-y-4"><div><label class="block text-sm font-medium mb-1">Nombre del Cliente</label><input type="text" name="name" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent" required></div><div><label class="block text-sm font-medium mb-1">WhatsApp (Ej: 5076...)</label><input type="tel" name="phone" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"></div><div><label class="block text-sm font-medium mb-1">Crédito Previo ($)</label><input type="number" name="credit" value="0.00" step="0.01" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"></div><div><label class="block text-sm font-medium mb-1">Notas Adicionales</label><textarea name="notes" rows="3" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"></textarea></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">Estado</label><select name="status" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"><option value="activo">Activo</option><option value="moroso">Moroso</option><option value="suspendido">Suspendido</option></select></div><div><label class="block text-sm font-medium mb-1">Etiquetas (coma)</label><input type="text" name="tags" placeholder="VIP, prueba" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"></div></div><div><label class="block text-sm font-medium mb-1">Link de pago</label><input type="url" name="payment_link" placeholder="https://..." class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"></div></div><div class="flex justify-end gap-3 mt-6"><button type="button" id="modal-cancel-btn" class="bg-slate-200 dark:bg-slate-700 font-medium py-2 px-4 rounded-md">Cancelar</button><button type="submit" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-md">Guardar</button></div></form></div></div>
    <div id="service-modal" class="fixed inset-0 z-40 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0"></div><div class="modal-content bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-lg m-4 relative"><form id="service-form" class="p-6"><h3 class="text-xl font-semibold mb-4">Añadir Servicio</h3><div class="space-y-4"><div><label class="block text-sm font-medium mb-1">Servicio</label><select name="serviceId" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent" required></select></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">Precio por Perfil ($)</label><input type="number" name="price" step="0.01" placeholder="0.00" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent" required></div><div><label class="block text-sm font-medium mb-1">Fecha de Inicio de Ciclo</label><input type="date" name="date" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent" required></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label class="block text-sm font-medium mb-1">Cantidad de perfiles</label><input type="number" name="qty_profiles" value="1" min="1" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"></div><div class="md:col-span-2"><label class="block text-sm font-medium mb-1">Distribución</label><p class="text-xs text-slate-500">Se sugiere automáticamente según disponibilidad. Puedes ajustar por perfil.</p></div></div><div id="profiles-dynamic" class="mt-3 space-y-3 max-h-60 overflow-y-auto pr-2"></div><div id="master-account-suggestion" class="hidden p-3 bg-slate-50 dark:bg-slate-900/40 border border-slate-200 dark:border-slate-700 rounded-md"><p class="text-sm font-medium mb-2">Cuentas disponibles por servicio:</p><div id="accounts-availability" class="max-h-32 overflow-y-auto"></div></div></div><div class="flex justify-end gap-3 mt-6"><button type="button" id="service-modal-cancel-btn" class="bg-slate-200 dark:bg-slate-700 font-medium py-2 px-4 rounded-md">Cancelar</button><button type="submit" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-md">Guardar</button></div></form></div></div>
    <div id="invoice-modal" class="fixed inset-0 z-40 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0"></div><div class="modal-content bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-2xl m-4 relative max-h-full flex flex-col"><div class="p-6 border-b border-slate-200 dark:border-slate-700"><h3 class="text-xl font-semibold">Generar Factura de Liquidación</h3></div><div class="p-6 flex-1 overflow-y-auto"><div id="invoice-options" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><label class="flex items-center"><input type="checkbox" id="inv-explicacion" class="custom-checkbox mr-2"><span class="text-sm">Incluir explicación de cese</span></label><label class="flex items-center"><input type="checkbox" id="inv-netflix-cobro" class="custom-checkbox mr-2"><span class="text-sm">Netflix: No Pagó (Cobro)</span></label><label class="flex items-center"><input type="checkbox" id="inv-netflix-recordatorio" class="custom-checkbox mr-2"><span class="text-sm">Netflix: Recordatorio (Dev.)</span></label><label class="flex items-center"><input type="checkbox" id="inv-netflix-prorrateo" class="custom-checkbox mr-2"><span class="text-sm">Netflix: Prorratear si &lt; 66%</span></label></div><div id="invoice-result" class="hidden"><div class="flex justify-between items-center mb-2"><h4 class="font-semibold">Mensaje Generado</h4><div class="flex gap-2"><button id="copy-invoice-btn" class="bg-blue-500 text-white text-xs font-medium py-1 px-3 rounded hover:bg-blue-600">📋 Copiar</button><a id="whatsapp-invoice-btn" href="#" target="_blank" class="hidden bg-green-500 text-white text-xs font-medium py-1 px-3 rounded hover:bg-green-600">📱 WhatsApp</a></div></div><textarea id="generated-invoice-message" readonly class="w-full h-80 p-3 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-md text-sm resize-none"></textarea></div></div><div class="flex justify-end gap-3 p-6 border-t border-slate-200 dark:border-slate-700"><button type="button" id="invoice-modal-cancel-btn" class="bg-slate-200 dark:bg-slate-700 font-medium py-2 px-4 rounded-md">Cancelar</button><button id="generate-invoice-action-btn" class="bg-amber-500 text-white font-medium py-2 px-4 rounded-md">Generar</button></div></div></div>
    <div id="master-account-modal" class="fixed inset-0 z-40 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0"></div><div class="modal-content bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-md m-4 relative"><form id="master-account-form" class="p-6"><h3 id="master-account-modal-title" class="text-xl font-semibold mb-4"></h3><div class="space-y-4"><div><label class="block text-sm font-medium mb-1">Servicio</label><select name="serviceId" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent" required></select></div><div><label class="block text-sm font-medium mb-1">Email de la Cuenta</label><div class="relative"><input type="email" name="login_email" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent" required><button type="button" data-role="copy-email" class="absolute inset-y-0 right-0 px-3 flex items-center text-slate-500 hover:text-blue-600" title="Copiar email"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg></button></div></div><div><label class="block text-sm font-medium mb-1">Contraseña</label><div class="relative"><input type="password" name="password" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"><button type="button" data-role="toggle-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-slate-500 hover:text-blue-600" title="Mostrar contraseña"><svg class="w-5 h-5 eye-open" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg><svg class="w-5 h-5 eye-closed hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 1.274-4.057 5.064-7 9.542-7 .847 0 1.673.12 2.468.355M7.125 7.125A3 3 0 009 9m3 3a3 3 0 00-3-3m-3.875 5.25A10.025 10.025 0 0112 15c4.478 0 8.268-2.943 9.542-7a10.025 10.025 0 00-4.03-4.38M1 1l22 22"></path></svg></button></div><p class="text-xs text-slate-500 mt-1">La contraseña se muestra para tu referencia. Edita este campo para actualizarla.</p></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">Estado</label><select name="status" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"><option value="activa">Activa</option><option value="pausada">Pausada</option><option value="bloqueada">Bloqueada</option></select></div><div><label class="block text-sm font-medium mb-1">Plazas (override)</label><input type="number" name="seat_limit_override" min="0" placeholder="(Opcional)" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"></div></div></div><div class="flex justify-end gap-3 mt-6"><button type="button" id="master-account-modal-cancel-btn" class="bg-slate-200 dark:bg-slate-700 font-medium py-2 px-4 rounded-md">Cancelar</button><button type="submit" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-md">Guardar</button></div></form></div></div>
    <div id="invoice-view-modal" class="fixed inset-0 z-40 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0"></div><div class="modal-content bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-2xl m-4 relative max-h-full flex flex-col"><div class="p-6 border-b border-slate-200 dark:border-slate-700"><h3 class="text-xl font-semibold">Detalle de la Factura</h3></div><div class="p-6 flex-1 overflow-y-auto"><textarea id="invoice-view-content" readonly class="w-full h-96 p-3 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-md text-sm resize-none"></textarea></div><div class="flex justify-end gap-3 p-6 border-t border-slate-200 dark:border-slate-700"><button type="button" id="invoice-view-close-btn" class="bg-slate-200 dark:bg-slate-700 font-medium py-2 px-4 rounded-md">Cerrar</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, setDoc, deleteDoc, updateDoc, arrayUnion, runTransaction, getDoc, getDocs, query, where, orderBy, limit, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const app = {
            appId: typeof __app_id !== 'undefined' ? __app_id : 'default-app-id',
            currentView: 'dashboard',
            selectedClientId: null,
            clients: [],
            services: [],
            masterAccounts: [],
            ui: {}
        };
        
        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', async () => {
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            if (!firebaseConfig.apiKey) { showFirebaseError(); return; }

            try {
                app.firebaseApp = initializeApp(firebaseConfig);
                app.auth = getAuth(app.firebaseApp);
                app.db = getFirestore(app.firebaseApp);
                
                const authUser = await new Promise((resolve, reject) => {
                    const unsubscribe = onAuthStateChanged(app.auth, async (user) => {
                        unsubscribe();
                        if (user) return resolve(user);
                        try {
                            const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                            const creds = token ? await signInWithCustomToken(app.auth, token) : await signInAnonymously(app.auth);
                            resolve(creds.user);
                        } catch(e) { reject(e); }
                    }, reject);
                });

                if (authUser) {
                    app.userId = authUser.uid;
                    initializeAppUI();
                } else { throw new Error("Authentication failed."); }
            } catch (error) { showFirebaseError(error); }
        });

        function initializeAppUI() {
            app.ui.mainContent = document.querySelector('main');
            setupNavigation();
            setupDarkMode();
            setupSidebar();
            setupClientModal();
            setupServiceModal();
            setupInvoiceModal();
            setupMasterAccountModal();
            setupInvoiceViewModal();
            setupRealtimeListeners();
            setupGlobalEventListeners();
            
            renderView('dashboard');

            document.getElementById('app-loader').classList.add('opacity-0');
            document.getElementById('app-content').classList.remove('opacity-0');
            setTimeout(() => document.getElementById('app-loader').style.display = 'none', 300);
        }
        
        // --- VISTAS Y NAVEGACIÓN ---
        function setupNavigation() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const viewName = link.getAttribute('href').substring(1);
                    renderView(viewName);
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('bg-slate-200', 'dark:bg-slate-700'));
                    link.classList.add('bg-slate-200', 'dark:bg-slate-700');
                });
            });
        }
        
        function renderView(viewName, params = {}) {
            app.currentView = viewName;
            const contentWrapper = `<div class="max-w-7xl mx-auto p-6 lg:p-8"></div>`;
            app.ui.mainContent.innerHTML = contentWrapper;
            const container = app.ui.mainContent.firstChild;

            switch(viewName) {
                case 'dashboard':
                    container.innerHTML = getDashboardViewHTML();
                    updateDashboard();
                    break;
                case 'clients':
                    app.selectedClientId = params.clientId || null;
                    renderClientsView(container);
                    break;
                case 'settings':
                    container.innerHTML = getSettingsViewHTML();
                    attachSettingsEventListeners();
                    populateServicesSettings();
                    populateMasterAccountsSettings();
                    break;
            }
        }
        
        // --- DATOS (FIRESTORE) ---
        function setupRealtimeListeners() {
            onSnapshot(query(collection(app.db,'artifacts',app.appId,'users',app.userId,'clients'), orderBy('name')), (snapshot) => {
                app.clients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (app.currentView === 'dashboard') updateDashboard();
                if (app.currentView === 'clients') renderClientsView(app.ui.mainContent.firstChild);
            });

            onSnapshot(collection(app.db, 'artifacts', app.appId, 'users', app.userId, 'services'), (snapshot) => {
                app.services = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (app.currentView === 'settings') renderView('settings');
                if (app.currentView === 'clients' && app.selectedClientId) renderClientsView(app.ui.mainContent.firstChild);
            });

            onSnapshot(collection(app.db, 'artifacts', app.appId, 'users', app.userId, 'master_accounts'), (snapshot) => {
                app.masterAccounts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (app.currentView === 'settings') populateMasterAccountsSettings();
            });
        }
        
        // --- VISTA: DASHBOARD ---
        function getDashboardViewHTML() {
            return `<div class="flex justify-between items-center mb-6"> <h2 class="text-3xl font-bold">Dashboard</h2> <button data-role="open-fullscreen" class="bg-slate-200 dark:bg-slate-700 font-medium py-2 px-4 rounded-md flex items-center gap-2">⤢ <span class="hidden sm:inline">Abrir en pantalla completa</span></button></div> <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"> <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700"> <h3 class="text-lg font-medium text-slate-500 dark:text-slate-400">Clientes Activos</h3> <p id="db-active-clients" class="text-4xl font-bold mt-2">0</p> </div> <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700"> <h3 class="text-lg font-medium text-slate-500 dark:text-slate-400">Cuentas por Cobrar</h3> <p id="db-accounts-receivable" class="text-4xl font-bold mt-2">$0.00</p> </div> <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700"> <h3 class="text-lg font-medium text-slate-500 dark:text-slate-400">Crédito por Devolver</h3> <p id="db-credit-to-return" class="text-4xl font-bold mt-2">$0.00</p> </div> <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700"> <h3 class="text-lg font-medium text-slate-500 dark:text-slate-400">Próximos Vencimientos</h3> <p id="db-upcoming-renewals" class="text-4xl font-bold mt-2">0</p> </div> </div> <div class="mt-8 bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700"> <h3 class="text-lg font-medium mb-4">Clientes con Vencimientos Próximos (7 días)</h3> <div id="db-upcoming-renewals-list" class="max-h-96 overflow-y-auto"></div> </div>`;
        }
        
        async function updateDashboard() {
            const active = document.getElementById('db-active-clients');
            if (active) active.textContent = app.clients?.length || 0;

            const arEl = document.getElementById('db-accounts-receivable');
            if (arEl) arEl.textContent = `$${(await computeAccountsReceivable()).toFixed(2)}`;

            const creditEl = document.getElementById('db-credit-to-return');
            if(creditEl) creditEl.textContent = `$${computeCreditToReturn().toFixed(2)}`;

            const upEl = document.getElementById('db-upcoming-renewals');
            if (upEl) upEl.textContent = countUpcomingRenewals(7);
        }
        
        // --- VISTA: CLIENTES ---
        function renderClientsView(container) {
            if (app.selectedClientId) {
                renderClientProfileView(container, app.selectedClientId);
            } else {
                renderClientListView(container);
            }
        }
        
        function renderClientListView(container) {
            container.innerHTML = `<div class="flex justify-between items-center mb-6"> <h2 class="text-3xl font-bold">Clientes</h2><div class="flex gap-2"><button id="add-client-btn" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-md hover:bg-blue-700">Añadir Cliente</button><button data-role="open-fullscreen" class="bg-slate-200 dark:bg-slate-700 font-medium py-2 px-4 rounded-md flex items-center gap-2">⤢</button></div> </div> <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700"> <div class="p-4"><input type="text" id="client-search" placeholder="Buscar por nombre, tel, notas o etiqueta..." class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"></div> <div class="overflow-x-auto"> <table class="w-full text-left"> <thead class="bg-slate-50 dark:bg-slate-700/50"> <tr> <th class="p-4 font-semibold">Nombre</th> <th class="p-4 font-semibold">Contacto</th> <th class="p-4 font-semibold text-center">Servicios Activos</th> <th class="p-4 font-semibold">Próximo Vencimiento</th> </tr> </thead> <tbody id="clients-table-body"></tbody> </table> </div> </div>`;
            document.getElementById('add-client-btn').addEventListener('click', () => openClientModal());
            document.getElementById('client-search').addEventListener('input', (e) => populateClientsTable(e.target.value));
            populateClientsTable();
        }

        function populateClientsTable(filter = '') {
            const tableBody = document.getElementById('clients-table-body');
            const lowerCaseFilter = filter.toLowerCase();
            const filteredClients = app.clients.filter(c => {
                const bag = [ c.name, c.phone, c.notes, ...(c.tags||[]) ].join(' ').toLowerCase();
                return bag.includes(lowerCaseFilter);
            });
            if (filteredClients.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-slate-500">No se encontraron clientes.</td></tr>`;
                return;
            }
            tableBody.innerHTML = filteredClients.map(client => {
                const serviceCount = client.services ? Object.keys(client.services).length : 0;
                let nextDueDate = 'N/A';
                if (serviceCount > 0) {
                    const dates = Object.values(client.services).map(s => s.date).filter(Boolean);
                    if (dates.length > 0) {
                        const nextDates = dates.map(d_str => {
                            let next = new Date(d_str + 'T00:00:00');
                            while (next < new Date()) next.setMonth(next.getMonth() + 1);
                            return next;
                        });
                        nextDueDate = formatDate(new Date(Math.min.apply(null, nextDates)));
                    }
                }
                const chips = (client.tags||[]).slice(0,2).map(t=>`<span class="text-[10px] bg-slate-200 dark:bg-slate-700 px-2 py-0.5 rounded">${t}</span>`).join(' ');
                const statusChip = client.status==='moroso' ? 'bg-red-100 text-red-700' : client.status==='suspendido' ? 'bg-yellow-100 text-yellow-700' : 'bg-emerald-100 text-emerald-700';
                return `<tr class="border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50 cursor-pointer" data-id="${client.id}"> <td class="p-4 font-medium">${client.name} <span class="ml-2 text-[10px] ${statusChip} px-2 py-0.5 rounded">${client.status||'activo'}</span> <span class="ml-1">${chips}</span></td> <td class="p-4 text-slate-500">${client.phone || 'No registrado'}</td> <td class="p-4 text-slate-500 text-center">${serviceCount}</td> <td class="p-4 text-slate-500 font-mono">${nextDueDate}</td> </tr>`;
            }).join('');
            tableBody.querySelectorAll('tr').forEach(row => row.addEventListener('click', () => renderView('clients', {
                clientId: row.dataset.id
            })));
        }

        function renderClientProfileView(container, clientId) {
            const client = app.clients.find(c => c.id === clientId);
            if (!client) {
                renderView('clients');
                return;
            }
            container.innerHTML = `<div class="mb-6"> <button id="back-to-clients" class="text-sm font-medium text-blue-600 hover:underline">&larr; Volver</button> <div class="flex justify-between items-start mt-2"> <div> <h2 class="text-3xl font-bold">${client.name}</h2> <p class="text-slate-500">${client.phone || 'Sin WhatsApp'}</p> <p class="text-sm text-slate-500 mt-2 whitespace-pre-wrap">${client.notes || 'Sin notas.'}</p> </div><div class="flex items-center gap-2"><button type="button" data-role="quick-wa" class="bg-green-600 text-white font-medium py-2 px-3 rounded-md">WhatsApp</button><button type="button" data-role="toggle-suspend" class="bg-yellow-500 text-white font-medium py-2 px-3 rounded-md">Suspender/Reactivar</button><button id="edit-client-btn" class="bg-slate-200 dark:bg-slate-700 font-medium py-2 px-4 rounded-md">Editar</button> <button id="delete-client-btn" class="bg-red-600 text-white font-medium py-2 px-4 rounded-md">Eliminar</button></div></div> </div> <div class="grid grid-cols-1 lg:grid-cols-3 gap-6"> <div class="lg:col-span-2 space-y-6"> <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-6"> <div class="flex justify-between items-center mb-4"> <h3 class="text-xl font-semibold">Servicios Contratados</h3> <button id="add-service-to-client-btn" class="text-sm bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300 font-medium py-1 px-3 rounded-md">Añadir Servicio</button> </div> <div id="client-services-list" class="space-y-3"></div> </div> <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-6"> <h3 class="text-xl font-semibold mb-4">Facturación de Liquidación</h3> <p class="text-sm text-slate-500 mb-4">Genera una factura combinada de todos los servicios.</p> <button id="generate-special-invoice-btn" class="bg-amber-500 text-white font-medium py-2 px-4 rounded-md">Generar Factura</button> </div> </div> <div class="space-y-6"> <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-6"> <h3 class="text-xl font-semibold mb-4">Historial de Facturas</h3> <div id="client-invoice-history" class="max-h-96 overflow-y-auto"></div> </div> </div> </div>`;
            document.getElementById('back-to-clients').addEventListener('click', () => renderView('clients'));
            document.getElementById('edit-client-btn').addEventListener('click', () => openClientModal(client));
            document.getElementById('delete-client-btn').addEventListener('click', () => handleDeleteClient(client));
            document.getElementById('add-service-to-client-btn').addEventListener('click', () => openServiceModal(client));
            document.getElementById('generate-special-invoice-btn').addEventListener('click', () => openInvoiceModal(client));
            populateClientServices(client);
            populateClientInvoices(client);
        }

        async function handleDeleteClient(client) {
            if (confirm(`¿Eliminar a ${client.name}?`)) {
                await deleteDoc(doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'clients', client.id));
                renderView('clients');
            }
        }
        
        function populateClientServices(client) {
            const container = document.getElementById('client-services-list');
            const clientServices = client.services || {};
            if (Object.keys(clientServices).length === 0) {
                container.innerHTML = `<p class="text-center text-slate-500 py-4">Sin servicios activos.</p>`;
                return;
            }
            container.innerHTML = Object.entries(clientServices).map(([serviceId, serviceData]) => {
                const serviceInfo = app.services.find(s => s.id === serviceId);
                if (!serviceInfo) return '';
                
                const profiles = Array.isArray(serviceData.profiles) ? serviceData.profiles : [];
                // Compatibility for old data model
                if (!serviceData.profiles && serviceData.credentials) {
                    profiles.push({
                        profile_id: 'legacy-profile',
                        profile_name: 'Perfil (Heredado)',
                        ...serviceData.credentials
                    });
                }

                const profilesHTML = profiles.length ? `
                <div class="mt-2 space-y-2">
                    ${profiles.map(p => `
                    <div class="flex items-center justify-between p-2 rounded bg-white/50 dark:bg-slate-800/30 border border-slate-200 dark:border-slate-700">
                        <div class="min-w-0">
                        <p class="text-sm font-medium truncate">${p.profile_name || 'Perfil'}</p>
                        <p class="text-xs text-slate-500">Cuenta: ${p.login_email} • PIN: ${p.pin || 'N/A'}</p>
                        </div>
                        <div class="flex items-center gap-2">
                        <button type="button" data-role="remove-client-profile"
                            data-service-id="${serviceId}" data-profile-id="${p.profile_id}"
                            class="text-red-500 hover:text-red-700 text-sm font-medium">Quitar</button>
                        </div>
                    </div>
                    `).join('')}
                </div>
                ` : `<p class="text-xs text-slate-500 mt-1">Sin perfiles asignados.</p>`;
                
                return `
                <div class="p-3 rounded-md bg-slate-100 dark:bg-slate-700/50">
                    <div class="flex items-center justify-between">
                    <div>
                        <p class="font-medium">${serviceInfo.name}</p>
                        <p class="text-sm text-slate-500">
                        Precio x perfil: $${(serviceData.price||0).toFixed(2)} |
                        Ciclo: ${serviceData.date || 'N/A'} |
                        Perfiles: ${profiles.length}
                        </p>
                    </div>
                    <button type="button" data-role="remove-client-service"
                        data-service-id="${serviceId}"
                        class="text-red-500 hover:text-red-700 text-xl font-bold" aria-label="Quitar servicio completo" title="Quitar servicio completo">&times;</button>
                    </div>
                    ${profilesHTML}
                </div>`;

            }).join('');
        }
        
        async function populateClientInvoices(client) {
            const container = document.getElementById('client-invoice-history');
            const invoices = await listInvoices(client.id);
            if (invoices.length === 0) {
                container.innerHTML = `<p class="text-center text-slate-500 py-4">Sin historial.</p>`;
                return;
            }
            container.innerHTML = invoices.map((inv, idx) => `
                <div class="flex items-center justify-between p-2 border-b border-slate-200 dark:border-slate-700">
                <div>
                    <p class="text-sm font-medium">${inv.created_at?.toDate().toLocaleString('es-PA') || ''} — <span class="uppercase text-xs">${inv.status}</span></p>
                    <p class="text-xs text-slate-500 mt-1 whitespace-pre-wrap line-clamp-2">${inv.content}</p>
                </div>
                <div class="flex gap-2">
                    ${inv.payment_link ? `<a href="${inv.payment_link}" target="_blank" class="text-xs bg-emerald-600 text-white py-1 px-2 rounded">Pagar</a>` : ''}
                    <button type="button" data-role="view-invoice" data-invoice-id="${inv.id}" class="text-sm bg-slate-200 dark:bg-slate-700 font-medium py-1 px-3 rounded-md">Ver</button>
                </div>
                </div>
            `).join('');
        }
        
        // --- VISTA: AJUSTES ---
        function getSettingsViewHTML() {
            return `<div class="flex justify-between items-center mb-6"> <h2 class="text-3xl font-bold">Ajustes del Negocio</h2><button data-role="open-fullscreen" class="bg-slate-200 dark:bg-slate-700 font-medium py-2 px-4 rounded-md flex items-center gap-2">⤢ <span class="hidden sm:inline">Abrir en pantalla completa</span></button></div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Catálogo de Servicios -->
                    <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700">
                        <div class="p-6 border-b border-slate-200 dark:border-slate-700">
                            <h3 class="text-xl font-semibold">Catálogo de Servicios</h3>
                            <p class="text-sm text-slate-500 mt-1">Define los tipos de servicios que ofreces y sus reglas.</p>
                        </div>
                        <div id="services-settings-list" class="p-6 space-y-3"></div>
                        <form id="add-service-form" class="p-6 border-t border-slate-200 dark:border-slate-700 space-y-4">
                            <h4 class="font-semibold">Añadir Nuevo Servicio al Catálogo</h4>
                            <div><label class="text-sm font-medium">Nombre del Servicio</label><input type="text" name="name" placeholder="Ej: Disney+" class="mt-1 w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent" required></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-sm font-medium">Límite de Plazas</label><input type="number" name="seat_limit" value="1" min="1" class="mt-1 w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"></div>
                                <div><label class="text-sm font-medium">Longitud del PIN</label><input type="number" name="pin_length" value="4" min="0" class="mt-1 w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"></div>
                            </div>
                            <div><label class="flex items-center"><input type="checkbox" name="isNetflix" class="custom-checkbox mr-2"><span class="text-sm">Es Netflix (Lógica Especial)</span></label></div>
                            <button type="submit" class="w-full bg-blue-600 text-white font-medium py-2 px-4 rounded-md hover:bg-blue-700">Añadir al Catálogo</button>
                        </form>
                    </div>

                    <!-- Inventario de Cuentas Maestras -->
                    <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700">
                         <div class="p-6 border-b border-slate-200 dark:border-slate-700">
                            <h3 class="text-xl font-semibold">Inventario de Cuentas Maestras</h3>
                            <p class="text-sm text-slate-500 mt-1">Registra tus cuentas principales y sus credenciales.</p>
                        </div>
                        <div id="master-accounts-list"></div>
                         <div class="p-6 border-t border-slate-200 dark:border-slate-700">
                            <button id="add-master-account-btn" class="w-full bg-green-600 text-white font-medium py-2 px-4 rounded-md hover:bg-green-700">Añadir Cuenta Maestra</button>
                        </div>
                    </div>
                </div>`;
        }
        
        function attachSettingsEventListeners() {
            document.getElementById('add-service-form').addEventListener('submit', handleAddService);
            document.getElementById('add-master-account-btn').addEventListener('click', () => openMasterAccountModal());
        }

        async function handleAddService(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const name = formData.get('name').trim();
            if (name) {
                await addDoc(collection(app.db, 'artifacts', app.appId, 'users', app.userId, 'services'), { 
                    name: name,
                    seat_limit: parseInt(formData.get('seat_limit')) || 1,
                    pin_length: parseInt(formData.get('pin_length')) || 0,
                    isNetflix: formData.get('isNetflix') === 'on'
                });
                e.target.reset();
            }
        }

        function populateServicesSettings() {
            const container = document.getElementById('services-settings-list');
            if (app.services.length === 0) {
                container.innerHTML = `<p class="text-center text-slate-500 py-4">Aún no has definido servicios en tu catálogo.</p>`; return;
            }
            container.innerHTML = app.services.map(service => `
                <div class="flex items-center justify-between p-3 rounded-md bg-slate-100 dark:bg-slate-700/50">
                    <div>
                        <p class="font-medium">${service.name} ${service.isNetflix ? '<span class="text-xs text-red-500">(Netflix)</span>' : ''}</p>
                        <p class="text-sm text-slate-500">Plazas: ${service.seat_limit} | PIN: ${service.pin_length} dígitos</p>
                    </div>
                    <button type="button" data-role="delete-service-type" data-id="${service.id}" class="text-red-500 hover:text-red-700 text-xl font-bold" aria-label="Eliminar servicio del catálogo" title="Eliminar servicio del catálogo">&times;</button>
                </div>
            `).join('');
        }
        
        function populateMasterAccountsSettings() {
            const container = document.getElementById('master-accounts-list');
            if (!app.masterAccounts.length) {
                container.innerHTML = `<p class="text-center text-slate-500 p-6">No has registrado ninguna cuenta maestra.</p>`;
                return;
            }

            const svcById = {};
            app.services.forEach(s => svcById[s.id] = s);

            const groups = {};
            for (const acc of app.masterAccounts) {
                const sid = acc.serviceId || 'unknown';
                if (!groups[sid]) groups[sid] = [];
                groups[sid].push(acc);
            }

            const searchBoxId = 'master-acc-search';
            const searchHTML = `<div class="p-4"><input type="text" id="${searchBoxId}" placeholder="Buscar por email o estado..." class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"></div>`;

            let html = searchHTML + '<div class="px-4 pb-4">';

            Object.entries(groups).forEach(([serviceId, accounts], idx) => {
                const svc = svcById[serviceId];
                const title = svc ? svc.name : 'Servicio desconocido';
                const groupId = `acc-group-${serviceId}`;
                const limitSum = accounts.reduce((a,acc) => a + effectiveSeatLimit(acc, svc), 0);
                const usedSum  = accounts.reduce((a,acc) => a + (acc.seats_used || 0), 0);

                html += `
                <div class="rounded-lg border border-slate-200 dark:border-slate-700 overflow-hidden mb-3">
                    <button type="button" data-role="toggle-acc-group" data-target="${groupId}" class="w-full flex items-center justify-between px-4 py-3 bg-slate-100 dark:bg-slate-700/50 hover:bg-slate-200 dark:hover:bg-slate-700">
                        <span class="font-semibold">${title}</span>
                        <div class="flex items-center gap-4">
                            <span class="text-xs text-slate-500">${usedSum}/${limitSum} ocupadas</span>
                            <span class="chev transition-transform">&#9656;</span>
                        </div>
                    </button>
                    <div id="${groupId}" class="hidden">
                    <div class="p-3 space-y-2">
                        ${accounts.map(acc => {
                        const limit = effectiveSeatLimit(acc, svc);
                        const used  = acc.seats_used || 0;
                        const pct   = limit ? Math.min(100, Math.round((used / limit) * 100)) : 0;
                        const color = pct > 80 ? 'bg-red-500' : (pct > 50 ? 'bg-yellow-500' : 'bg-green-500');
                        const statusChip = acc.status === 'pausada' ? 'bg-yellow-600' : acc.status === 'bloqueada' ? 'bg-red-600' : 'bg-emerald-600';
                        return `
                            <div class="flex items-center justify-between p-3 rounded-md bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 acc-item"
                                data-search="${(acc.login_email||'').toLowerCase()} ${acc.status||''}">
                            <div class="min-w-0">
                                <p class="font-medium truncate">
                                ${acc.login_email}
                                <span class="text-[10px] text-white ${statusChip} px-2 py-0.5 rounded-full ml-2 uppercase">${acc.status||'activa'}</span>
                                </p>
                                <div class="flex items-center gap-2 mt-1">
                                <div class="w-28 h-2 bg-slate-300 dark:bg-slate-600 rounded-full">
                                    <div class="${color} h-2 rounded-full" style="width:${pct}%"></div>
                                </div>
                                <p class="text-xs text-slate-500">${used} / ${limit} plazas</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 flex-shrink-0">
                                <button type="button" data-role="edit-master-account" data-id="${acc.id}" class="text-blue-600 hover:text-blue-800 text-sm font-medium">Editar</button>
                                <button type="button" data-role="delete-master-account" data-id="${acc.id}" class="text-red-500 hover:text-red-700 text-xl font-bold" aria-label="Eliminar">&times;</button>
                            </div>
                            </div>`;
                        }).join('')}
                    </div>
                    </div>
                </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;

            const search = document.getElementById(searchBoxId);
            if (search) {
                search.addEventListener('input', () => {
                const q = search.value.trim().toLowerCase();
                container.querySelectorAll('.acc-item').forEach(el => {
                    const bag = (el.getAttribute('data-search') || '');
                    el.style.display = bag.includes(q) ? 'flex' : 'none';
                });
                });
            }
        }

        // --- MODALES ---
        let selectedMasterAccountId = null;

        function setupClientModal() { app.ui.clientModal = document.getElementById('client-modal'); app.ui.clientModal.querySelector('.modal-backdrop').addEventListener('click', closeClientModal); document.getElementById('modal-cancel-btn').addEventListener('click', closeClientModal); document.getElementById('client-form').addEventListener('submit', handleClientFormSubmit); }
        async function handleClientFormSubmit(e) { e.preventDefault(); const d = new FormData(e.target); const tagsStr = d.get('tags') || ''; const cd = {name:d.get('name'),phone:d.get('phone'),credit:parseFloat(d.get('credit'))||0,notes:d.get('notes'),status:d.get('status')||'activo',tags:tagsStr?tagsStr.split(',').map(t=>t.trim()).filter(Boolean):[],payment_link: d.get('payment_link') || null,}; try{if(app.selectedClientId){ await updateDoc(doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'clients', app.selectedClientId), cd);}else{cd.services={};cd.invoices=[];await addDoc(collection(app.db, 'artifacts', app.appId, 'users', app.userId, 'clients'), cd);} closeClientModal();}catch(err){console.error(err);}}
        function openClientModal(c=null) { app.selectedClientId = c?c.id:null; const f = document.getElementById('client-form'); f.reset(); document.getElementById('client-modal-title').textContent = c?'Editar Cliente':'Añadir Cliente'; if(c){f.elements.name.value=c.name;f.elements.phone.value=c.phone||'';f.elements.credit.value=c.credit||'0.00';f.elements.notes.value=c.notes||''; f.elements.status.value = c.status || 'activo'; f.elements.tags.value = Array.isArray(c.tags) ? c.tags.join(', ') : ''; f.elements.payment_link.value = c.payment_link || '';} app.ui.clientModal.classList.remove('hidden'); app.ui.clientModal.classList.add('flex');}
        function closeClientModal() { app.ui.clientModal.classList.add('hidden'); app.ui.clientModal.classList.remove('flex');}

        function setupServiceModal() { app.ui.serviceModal = document.getElementById('service-modal'); app.ui.serviceModal.querySelector('.modal-backdrop').addEventListener('click', closeServiceModal); document.getElementById('service-modal-cancel-btn').addEventListener('click', closeServiceModal); document.getElementById('service-form').addEventListener('submit', handleServiceFormSubmit); }
        async function handleServiceFormSubmit(e) {
            e.preventDefault();
            const client = app.clients.find(cl => cl.id === app.selectedClientId);
            if (!client) return;

            const formData = new FormData(e.target);
            const serviceId = formData.get('serviceId');
            const price = parseFloat(formData.get('price'));
            const date = formData.get('date');

            const serviceInfo = app.services.find(s => s.id === serviceId);
            if (!serviceInfo) return;

            // Recoger perfiles
            const names = formData.getAll('profile_name[]');
            const pins = formData.getAll('profile_pin[]');
            const accs = formData.getAll('profile_account[]');
            const profilesRequested = names.map((nm, i) => ({
                name: (nm || `Perfil ${i + 1}`).trim(),
                pin: (pins[i] || '').trim(),
                accountId: accs[i] || null
            })).filter(p => true);

            if (!profilesRequested.length) return mostrarNotificacion("Debes crear al menos 1 perfil.", true);

            const accounts = app.masterAccounts.filter(ma => ma.serviceId === serviceId && ma.status === 'activa');
            const ranked = sortAccountsByAvailability(accounts, serviceInfo);
            for (const p of profilesRequested) {
                if (!p.accountId) {
                    const choice = ranked.find(a => freeSeatsForAccount(a, serviceInfo) > 0);
                    if (choice) p.accountId = choice.id;
                }
            }
            if (profilesRequested.some(p => !p.accountId)) {
                return mostrarNotificacion("No hay suficiente capacidad en cuentas maestras para todos los perfiles.", true);
            }

            const clientRef = doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'clients', client.id);
            const usedAccountIds = [...new Set(profilesRequested.map(p => p.accountId))];
            const accRefs = usedAccountIds.map(id => doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'master_accounts', id));

            await runTransaction(app.db, async (tx) => {
                const clientSnap = await tx.get(clientRef);
                const clientData = clientSnap.data() || {};
                const svcNode = { ...(clientData.services?.[serviceId] || {})};
                const existingProfiles = Array.isArray(svcNode.profiles) ? svcNode.profiles.slice() : [];

                const accSnaps = await Promise.all(accRefs.map(r => tx.get(r)));
                const accMap = {};
                accSnaps.forEach(s => {
                    if (!s.exists()) throw new Error("Una cuenta ya no existe.");
                    accMap[s.id] = s.data();
                });

                const needByAcc = {};
                for (const p of profilesRequested) needByAcc[p.accountId] = (needByAcc[p.accountId] || 0) + 1;
                for (const [accId, need] of Object.entries(needByAcc)) {
                    const acc = accMap[accId];
                    const limit = effectiveSeatLimit(acc, serviceInfo);
                    const used = acc.seats_used || 0;
                    if (used + need > limit) throw new Error(`Capacidad insuficiente en ${acc.login_email}.`);
                }

                const newProfiles = [];
                for (const p of profilesRequested) {
                    const accId = p.accountId;
                    const acc = accMap[accId];
                    const seatsArr = Array.isArray(acc.seats) ? acc.seats.slice() : [];

                    let finalPin = p.pin;
                    if (!finalPin && (serviceInfo.pin_length || 0) > 0) {
                        finalPin = generatePin(serviceInfo.pin_length);
                    }
                    if (finalPin && seatsArr.some(s => s.pin === finalPin)) {
                        finalPin = generatePin(serviceInfo.pin_length || 4);
                    }

                    const seat_uid = `${client.id}-${serviceId}-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
                    seatsArr.push({
                        seat_uid,
                        clientId: client.id,
                        serviceId,
                        assigned_at: new Date().toISOString(),
                        pin: finalPin || null,
                        profile: p.name
                    });

                    tx.update(doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'master_accounts', accId), {
                        seats_used: (acc.seats_used || 0) + 1,
                        seats: seatsArr
                    });

                    newProfiles.push({
                        profile_id: seat_uid,
                        profile_name: p.name,
                        master_account_id: accId,
                        login_email: acc.login_email,
                        pin: finalPin || null,
                        assigned_at: new Date().toISOString()
                    });
                }

                const newServices = { ...(clientData.services || {})};
                svcNode.price = price;
                svcNode.date = date;
                svcNode.profiles = existingProfiles.concat(newProfiles);
                newServices[serviceId] = svcNode;

                tx.update(clientRef, {
                    services: newServices
                });
            });

            mostrarNotificacion("Perfiles asignados correctamente.");
            closeServiceModal();
        }
        function openServiceModal(client) {
            app.selectedClientId = client.id;
            const form = document.getElementById('service-form');
            form.reset();

            form.elements.serviceId.innerHTML = app.services.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

            const svcSelect = form.elements.serviceId;
            const qtyInput  = form.elements.qty_profiles;

            function refresh() {
                const svcId   = svcSelect.value;
                const service = app.services.find(s => s.id === svcId);
                if (!service) { document.getElementById('profiles-dynamic').innerHTML = ''; return; }
                const accounts = app.masterAccounts.filter(ma => ma.serviceId === svcId);
                const n = Math.max(1, parseInt(qtyInput.value,10) || 1);
                renderProfileForms(n, accounts, service);
            }

            svcSelect.addEventListener('change', refresh);
            qtyInput.addEventListener('input', refresh);

            refresh();
            app.ui.serviceModal.classList.remove('hidden');
            app.ui.serviceModal.classList.add('flex');
        }
        function closeServiceModal() { app.ui.serviceModal.classList.add('hidden'); app.ui.serviceModal.classList.remove('flex');}

        function setupInvoiceModal() { app.ui.invoiceModal = document.getElementById('invoice-modal'); app.ui.invoiceModal.querySelector('.modal-backdrop').addEventListener('click', closeInvoiceModal); document.getElementById('invoice-modal-cancel-btn').addEventListener('click', closeInvoiceModal); document.getElementById('generate-invoice-action-btn').addEventListener('click', handleGenerateInvoiceAction); document.getElementById('copy-invoice-btn').addEventListener('click', ()=>{document.getElementById('generated-invoice-message').select();document.execCommand('copy');});}
        function openInvoiceModal(c) { app.selectedClientId = c.id; document.getElementById('invoice-result').classList.add('hidden'); document.getElementById('invoice-options').querySelectorAll('input').forEach(i => i.checked = false); app.ui.invoiceModal.classList.remove('hidden'); app.ui.invoiceModal.classList.add('flex');}
        function closeInvoiceModal() { app.ui.invoiceModal.classList.add('hidden'); app.ui.invoiceModal.classList.remove('flex');}

        function setupInvoiceViewModal() {
            app.ui.invoiceViewModal = document.getElementById('invoice-view-modal');
            app.ui.invoiceViewModal.querySelector('.modal-backdrop').addEventListener('click', closeInvoiceViewModal);
            document.getElementById('invoice-view-close-btn').addEventListener('click', closeInvoiceViewModal);
        }
        function openInvoiceViewModal(invoiceContent) {
            document.getElementById('invoice-view-content').value = invoiceContent;
            app.ui.invoiceViewModal.classList.remove('hidden');
            app.ui.invoiceViewModal.classList.add('flex');
        }
        function closeInvoiceViewModal() {
            app.ui.invoiceViewModal.classList.add('hidden');
            app.ui.invoiceViewModal.classList.remove('flex');
        }
        
        function setupMasterAccountModal() { app.ui.masterAccountModal = document.getElementById('master-account-modal'); app.ui.masterAccountModal.querySelector('.modal-backdrop').addEventListener('click', closeMasterAccountModal); document.getElementById('master-account-modal-cancel-btn').addEventListener('click', closeMasterAccountModal); document.getElementById('master-account-form').addEventListener('submit', handleMasterAccountFormSubmit); }
        async function handleMasterAccountFormSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const payload = {
                serviceId: formData.get('serviceId'),
                login_email: formData.get('login_email'),
                status: formData.get('status') || 'activa',
            };
            const override = parseInt(formData.get('seat_limit_override'), 10);
            if (!isNaN(override) && override > 0) payload.seat_limit_override = override;

            const pwd = formData.get('password');
            if (pwd) payload.password = pwd;

            if (selectedMasterAccountId) {
                const accRef = doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'master_accounts', selectedMasterAccountId);
                await runTransaction(app.db, async (tx) => {
                    const snap = await tx.get(accRef);
                    if (!snap.exists()) throw new Error("La cuenta maestra ya no existe.");
                    const prev = snap.data();
                    payload.seats = Array.isArray(prev.seats) ? prev.seats : [];
                    payload.seats_used = prev.seats_used || 0;
                    const svc = app.services.find(s => s.id === payload.serviceId);
                    const effLimit = effectiveSeatLimit(payload, svc);
                    if (effLimit < payload.seats_used) {
                        throw new Error(`No puedes reducir plazas a ${effLimit} si ya hay ${payload.seats_used} ocupadas.`);
                    }
                    tx.update(accRef, payload);
                });
                mostrarNotificacion("Cuenta maestra actualizada.");
            } else {
                payload.seats = [];
                payload.seats_used = 0;
                payload.created_at = new Date().toISOString();
                await addDoc(collection(app.db, 'artifacts', app.appId, 'users', app.userId, 'master_accounts'), payload);
                mostrarNotificacion("Cuenta maestra añadida.");
            }
            closeMasterAccountModal();
        }
        function openMasterAccountModal(account = null) {
            const form = document.getElementById('master-account-form');
            form.reset();
            form.elements.serviceId.innerHTML = app.services.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

            if (account) {
                selectedMasterAccountId = account.id;
                document.getElementById('master-account-modal-title').textContent = "Editar Cuenta Maestra";
                form.elements.serviceId.value = account.serviceId || '';
                form.elements.login_email.value = account.login_email || '';
                form.elements.password.value = account.password || ''; // SHOW PASSWORD
                form.elements.status.value = account.status || 'activa';
                form.elements.seat_limit_override.value = account.seat_limit_override || '';
            } else {
                selectedMasterAccountId = null;
                document.getElementById('master-account-modal-title').textContent = "Añadir Cuenta Maestra";
            }
            
            // Reset password visibility
            const passwordInput = form.elements.password;
            const toggleBtn = passwordInput.nextElementSibling;
            passwordInput.type = 'password';
            toggleBtn.querySelector('.eye-open').classList.remove('hidden');
            toggleBtn.querySelector('.eye-closed').classList.add('hidden');

            app.ui.masterAccountModal.classList.remove('hidden');
            app.ui.masterAccountModal.classList.add('flex');
        }
        function closeMasterAccountModal() { app.ui.masterAccountModal.classList.add('hidden'); app.ui.masterAccountModal.classList.remove('flex');}

        // --- LÓGICA DE FACTURACIÓN ---
        async function handleGenerateInvoiceAction() {
            const client = app.clients.find(c => c.id === app.selectedClientId);
            if (!client) return;
            const options = {
                explicacion: document.getElementById('inv-explicacion').checked,
                cobro: document.getElementById('inv-netflix-cobro').checked,
                recordatorio: document.getElementById('inv-netflix-recordatorio').checked,
                prorrateo: document.getElementById('inv-netflix-prorrateo').checked
            };
            const { message, total } = generateCombinedInvoice(client, options);
            document.getElementById('invoice-result').classList.remove('hidden');
            document.getElementById('generated-invoice-message').value = message;
            const whatsappBtn = document.getElementById('whatsapp-invoice-btn');
            if (client.phone) {
                whatsappBtn.href = `https://wa.me/${client.phone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
                whatsappBtn.classList.remove('hidden');
            } else {
                whatsappBtn.classList.add('hidden');
            }
            await addInvoice(client.id, {
                content: message,
                total: total,
                status: 'pendiente',
                payment_link: client.payment_link || null
            });
            mostrarNotificacion("Factura generada y guardada.");
        }

        function generateCombinedInvoice(client, options) {
            let message = `**Este es un mensaje generado automáticamente por el sistema de notificaciones de StreamService.**\n\nEstimado/a ${client.name},\n\n`;
            if (options.explicacion) {
                message += `Como es de su conocimiento, el pasado 17 de agosto Netflix realizó cambios que nos impidieron continuar ofreciendo el servicio, obligándonos a cesar las operaciones. Le agradecemos sinceramente por haber sido parte de StreamService.\n\n`;
            }
            let totalGeneral = 0;
            const bloques = [];
            const clientServices = client.services || {};

            for (const serviceId in clientServices) {
                const serviceData = clientServices[serviceId];
                const serviceInfo = app.services.find(s => s.id === serviceId);
                if (!serviceInfo) continue;

                if (serviceInfo.isNetflix) {
                    const {
                        bloqueStr,
                        deuda
                    } = processNetflixLogic(serviceData, options);
                    if (bloqueStr) bloques.push(bloqueStr);
                    totalGeneral += deuda;
                } else {
                    const {
                        bloqueStr,
                        subtotal
                    } = processOtherServiceLogic(serviceInfo, serviceData);
                    if (bloqueStr) bloques.push(bloqueStr);
                    totalGeneral += subtotal;
                }
            }

            message += bloques.join('');
            message += `--- RESUMEN FINAL DE FACTURACIÓN ---\n`;
            message += `Subtotal Servicios: $${totalGeneral.toFixed(2)}\n`;

            let totalAPagar = totalGeneral;
            if (client.credit && client.credit > 0) {
                totalAPagar = Math.max(0, totalGeneral - client.credit);
                message += `Crédito Previo Aplicado: -$${client.credit.toFixed(2)}\n`;
            }
            message += `--------------------------------\n`;
            message += `**Total a Pagar: $${totalAPagar.toFixed(2)}**\n`;
            message += `--------------------------------\n\n`;
            message += `Quedamos atentos para coordinar el pago o la devolución, según corresponda. ¡Gracias!`;

            return {
                message,
                total: totalAPagar
            };
        }

        function processNetflixLogic(serviceData, options) {
            const FECHA_BLOQUEO = new Date('2025-08-17T00:00:00');
            const precio = serviceData.price || 0;
            const fechaCicloStr = serviceData.date;
            const profiles = Array.isArray(serviceData.profiles) ? serviceData.profiles : [];
            const perfilesCount = profiles.length || 1; 

            if (!precio || !fechaCicloStr || !options.cobro) return {
                bloqueStr: '',
                deuda: 0
            };

            let deuda = 0;
            let bloqueStr = "--- Estado de Cuenta: Netflix ---\n";
            const fechaCiclo = new Date(fechaCicloStr + 'T00:00:00');

            let mesesCompletos = 0;
            let detalleMesesStr = "";
            let fechaDeCalculo = new Date(fechaCiclo);

            while (fechaDeCalculo < FECHA_BLOQUEO) {
                let proximoCiclo = new Date(fechaDeCalculo);
                proximoCiclo.setMonth(proximoCiclo.getMonth() + 1);
                if (proximoCiclo > FECHA_BLOQUEO) break;
                
                const mesTotal = precio * perfilesCount;
                detalleMesesStr += `▪️ Período ${formatDate(fechaDeCalculo)} a ${formatDate(proximoCiclo)}: $${precio.toFixed(2)} x ${perfilesCount} perfiles = $${mesTotal.toFixed(2)}\n`;
                mesesCompletos++;
                fechaDeCalculo.setMonth(fechaDeCalculo.getMonth() + 1);
            }
            deuda = mesesCompletos * (precio * perfilesCount);

            if (mesesCompletos > 0) {
                bloqueStr += "**Meses Completos Adeudados:**\n" + detalleMesesStr;
            }
            
            let finUltimoPeriodo = new Date(fechaDeCalculo);
            finUltimoPeriodo.setMonth(finUltimoPeriodo.getMonth() + 1);
            
            let textoUltimoPeriodo = `▪️ Último período (${formatDate(fechaDeCalculo)} a ${formatDate(finUltimoPeriodo)})`;

            const diasTotales = new Date(fechaDeCalculo.getFullYear(), fechaDeCalculo.getMonth() + 1, 0).getDate();
            const diasFuncionales = Math.max(0, Math.floor((FECHA_BLOQUEO - fechaDeCalculo) / (1000 * 60 * 60 * 24)));
            const ratio = diasFuncionales / diasTotales;

            const ultimoMesTotal = precio * perfilesCount;
            if (ratio >= 0.66) {
                deuda += ultimoMesTotal;
                bloqueStr += `\n${textoUltimoPeriodo}: $${precio.toFixed(2)} x ${perfilesCount} perfiles = $${ultimoMesTotal.toFixed(2)}\n`;
            } else {
                bloqueStr += `\n${textoUltimoPeriodo}: Entendiendo los inconvenientes, hemos decidido no facturar este período para asegurar que solo pague por un servicio completamente funcional.\n`;
            }
            bloqueStr += `Subtotal Deuda Netflix: $${deuda.toFixed(2)}\n`;
            bloqueStr += `--------------------------------\n\n`;
            return {
                bloqueStr,
                deuda
            };
        }

        function processOtherServiceLogic(serviceInfo, serviceData) {
            const FECHA_ACTUAL = new Date();
            const precio = serviceData.price || 0;
            const fechaCicloStr = serviceData.date;
            const profiles = Array.isArray(serviceData.profiles) ? serviceData.profiles : [];
            const perfilesCount = profiles.length || 1;

            if (!precio || !fechaCicloStr) return {
                bloqueStr: '',
                subtotal: 0
            };

            let fechaCicloActual = new Date(fechaCicloStr + 'T00:00:00');
            if (isNaN(fechaCicloActual.getTime()) || fechaCicloActual > FECHA_ACTUAL) return {
                bloqueStr: '',
                subtotal: 0
            };

            let mesesFacturados = 0,
                detalleStr = "",
                subtotal = 0;
            while (fechaCicloActual < FECHA_ACTUAL) {
                let proximoCiclo = new Date(fechaCicloActual);
                proximoCiclo.setMonth(proximoCiclo.getMonth() + 1);

                const mesTotal = precio * perfilesCount;
                subtotal += mesTotal;
                detalleStr += `▪️ Período (${formatDate(fechaCicloActual)} a ${formatDate(proximoCiclo)}): $${precio.toFixed(2)} x ${perfilesCount} perfiles = $${mesTotal.toFixed(2)}\n`;
                mesesFacturados++;
                fechaCicloActual.setMonth(fechaCicloActual.getMonth() + 1);
            }

            if (mesesFacturados > 0) {
                let bloqueStr = `--- Resumen: ${serviceInfo.name} ---\n`;
                bloqueStr += detalleStr;
                bloqueStr += `Subtotal ${serviceInfo.name}: $${subtotal.toFixed(2)}\n`;
                bloqueStr += `--------------------------------\n\n`;
                return {
                    bloqueStr,
                    subtotal
                };
            }
            return {
                bloqueStr: '',
                subtotal: 0
            };
        }
        
        // --- UTILIDADES ---
        function generatePin(length = 0) {
            if (!length || length <= 0) return "";
            let s = "";
            for (let i = 0; i < length; i++) s += Math.floor(Math.random() * 10);
            return s;
        }

        function accountAvailability(account, service) {
            const limit = effectiveSeatLimit(account, service);
            const used = account?.seats_used || 0;
            return Math.max(0, limit - used);
        }

        function rankMasterAccounts(accounts, service) {
            return accounts
                .filter(a => a.status === 'activa' && accountAvailability(a, service) > 0)
                .sort((a, b) => {
                    const freeA = accountAvailability(a, service);
                    const freeB = accountAvailability(b, service);
                    if (freeB !== freeA) return freeB - freeA;
                    const occA = a.seats_used || 0,
                        occB = b.seats_used || 0;
                    if (occA !== occB) return occA - occB;
                    return (a.created_at || 0) - (b.created_at || 0);
                });
        }
        
        function freeSeatsForAccount(acc, service) {
            const limit = effectiveSeatLimit(acc, service);
            const used  = acc.seats_used || 0;
            return Math.max(0, limit - used);
        }

        function sortAccountsByAvailability(accounts, service) {
            return accounts
                .filter(a => a.status === 'activa' && freeSeatsForAccount(a, service) > 0)
                .sort((a,b) => freeSeatsForAccount(b,service) - freeSeatsForAccount(a,service));
        }

        function distributeProfiles(accounts, service, count) {
            const dist = {}; 
            if (count <= 0) return dist;
            const pool = accounts.map(a => ({ id:a.id, free: freeSeatsForAccount(a, service), acc:a }))
                                .filter(x => x.free > 0);
            if (pool.length === 0) return dist;

            for (let i=0; i<count; i++) {
                pool.sort((x,y)=> y.free - x.free);
                if (!pool[0] || pool[0].free <= 0) break;
                dist[pool[0].id] = (dist[pool[0].id] || 0) + 1;
                pool[0].free -= 1;
            }
            return dist;
        }

        function renderAccountsAvailability(container, accounts, service) {
            container.innerHTML = accounts.map(a => {
                const free = freeSeatsForAccount(a, service);
                const limit = effectiveSeatLimit(a, service);
                const pct   = limit? Math.round(((limit - free)/limit)*100) : 0;
                const bar = pct>80?'bg-red-500':pct>50?'bg-yellow-500':'bg-green-500';
                return `
                <div class="flex items-center justify-between p-2 rounded border border-slate-200 dark:border-slate-700 mb-2">
                    <div class="min-w-0">
                    <p class="text-sm font-medium truncate">${a.login_email}</p>
                    <div class="flex items-center gap-2 mt-1">
                        <div class="w-28 h-2 bg-slate-300 dark:bg-slate-600 rounded-full">
                        <div class="${bar} h-2 rounded-full" style="width:${pct}%"></div>
                        </div>
                        <p class="text-xs text-slate-500">${limit - free} / ${limit} usadas · libres: ${free}</p>
                    </div>
                    </div>
                    ${free<=1?`<span class="text-xs text-red-600">⚠︎ al límite</span>`:''}
                </div>`;
            }).join('');
        }

        function renderProfileForms(n, accounts, service) {
            const container = document.getElementById('profiles-dynamic');
            const ranked = sortAccountsByAvailability(accounts, service);
            const dist   = distributeProfiles(accounts, service, n);

            const optionsHTML = ranked.map(a => {
                const free = freeSeatsForAccount(a, service);
                return `<option value="${a.id}">${a.login_email} — libres: ${free}</option>`;
            }).join('');

            container.innerHTML = '';
            let cursor = [];
            Object.entries(dist).forEach(([accId, k]) => {
                for (let i=0;i<k;i++) cursor.push(accId);
            });
            while (cursor.length < n) cursor.push('');

            for (let i=0;i<n;i++) {
                const suggested = cursor[i] || '';
                container.insertAdjacentHTML('beforeend', `
                <div class="p-3 rounded-md bg-slate-100 dark:bg-slate-700/40">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                    <div class="md:col-span-2">
                        <label class="block text-xs mb-1">Nombre del perfil</label>
                        <input type="text" name="profile_name[]" placeholder="Perfil ${i+1}"
                        class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent">
                    </div>
                    <div>
                        <label class="block text-xs mb-1">PIN</label>
                        <input type="text" name="profile_pin[]"
                        class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent" maxlength="10">
                    </div>
                    <div>
                        <label class="block text-xs mb-1">Cuenta maestra</label>
                        <select name="profile_account[]" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent">
                        <option value="">(Elegir)</option>
                        ${optionsHTML}
                        </select>
                    </div>
                    </div>
                </div>
                `);
                const selects = container.querySelectorAll('select[name="profile_account[]"]');
                const sel = selects[selects.length-1];
                if (suggested) sel.value = suggested;
            }

            const availBox = document.getElementById('accounts-availability');
            const suggBox  = document.getElementById('master-account-suggestion');
            renderAccountsAvailability(availBox, ranked, service);
            suggBox.classList.toggle('hidden', ranked.length===0);
        }

        async function handleRemoveClientProfile(serviceId, profileId) {
            const client = app.clients.find(cl => cl.id === app.selectedClientId);
            const serviceInfo = app.services.find(s => s.id === serviceId);
            if (!client || !serviceInfo) return;

            const svc = (client.services||{})[serviceId];
            const profiles = Array.isArray(svc?.profiles) ? svc.profiles.slice() : [];
            const p = profiles.find(x => x.profile_id === profileId);
            if (!p) return;

            if (!confirm(`¿Quitar el perfil "${p.profile_name}"?`)) return;

            const accRef = doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'master_accounts', p.master_account_id);
            const clientRef = doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'clients', client.id);

            await runTransaction(app.db, async (tx) => {
                const [accSnap, clientSnap] = await Promise.all([tx.get(accRef), tx.get(clientRef)]);
                if (accSnap.exists()) {
                     const acc = accSnap.data();
                    const used = acc.seats_used || 0;
                    let seatsArr = Array.isArray(acc.seats) ? acc.seats.slice() : [];
                    seatsArr = seatsArr.filter(s => s.seat_uid !== profileId);
                    tx.update(accRef, { seats_used: Math.max(0, used - 1), seats: seatsArr });
                }

                const cd = clientSnap.data() || {};
                const svcNode = { ...(cd.services?.[serviceId] || {}) };
                const newProfiles = profiles.filter(x => x.profile_id !== profileId);
                svcNode.profiles = newProfiles;
                const newServices = { ...(cd.services || {}) };
                if (newProfiles.length === 0) {
                delete newServices[serviceId];
                } else {
                newServices[serviceId] = svcNode;
                }
                tx.update(clientRef, { services: newServices });
            });

            mostrarNotificacion("Perfil eliminado.");
        }

        async function handleRemoveServiceById(serviceIdToRemove) {
            const client = app.clients.find(cl => cl.id === app.selectedClientId);
            const serviceInfo = app.services.find(s => s.id === serviceIdToRemove);
            if (!client || !serviceInfo) return;

            if (!confirm(`¿Quitar ${serviceInfo.name} y todos sus perfiles de ${client.name}?`)) return;
            
            const currentService = (client.services || {})[serviceIdToRemove];
            const profiles = Array.isArray(currentService.profiles) ? currentService.profiles : [];

            for (const profile of profiles) {
                 if (profile.master_account_id) {
                    const accRef = doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'master_accounts', profile.master_account_id);
                    await runTransaction(app.db, async (tx) => {
                        const snap = await tx.get(accRef);
                        if (!snap.exists()) return;
                        const acc = snap.data();
                        const used = acc.seats_used || 0;
                        let seatsArr = Array.isArray(acc.seats) ? acc.seats.slice() : [];
                        seatsArr = seatsArr.filter(s => !(s.clientId === client.id && s.seat_uid === profile.profile_id));
                        tx.update(accRef, { seats_used: Math.max(0, used - 1), seats: seatsArr });
                    });
                }
            }

            const updatedServices = { ...(client.services || {}) };
            delete updatedServices[serviceIdToRemove];

            await updateDoc(doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'clients', client.id), {
                services: updatedServices
            });

            mostrarNotificacion("Servicio eliminado.");
        }

        async function handleDeleteServiceType(serviceDocId) {
            const inUse = app.clients.some(c => c.services && c.services[serviceDocId]);
            if (inUse) {
                return mostrarNotificacion("No puedes eliminar: hay clientes usando este servicio.", true);
            }
            if (!confirm("¿Eliminar este servicio del catálogo?")) return;
            await deleteDoc(doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'services', serviceDocId));
            mostrarNotificacion("Servicio eliminado del catálogo.");
        }

        async function handleDeleteMasterAccount(masterAccId) {
            if (!confirm("¿Eliminar esta cuenta maestra?")) return;
            await deleteDoc(doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'master_accounts', masterAccId));
            mostrarNotificacion("Cuenta maestra eliminada.");
        }
        function effectiveSeatLimit(account, service) {
            return account?.seat_limit_override > 0 ? account.seat_limit_override : (service?.seat_limit || 0);
        }
        function formatDate(date) {
            if (!date || isNaN(date.getTime())) return 'N/A';
            const d = date.getDate().toString().padStart(2, '0');
            const m = (date.getMonth() + 1).toString().padStart(2, '0');
            const y = date.getFullYear();
            return `${d}/${m}/${y}`;
        }
        function setupSidebar() {
            const s = document.getElementById('sidebar');
            const t = document.getElementById('sidebar-toggle');
            if (localStorage.getItem('sidebarCollapsed') === 'true') {
                s.classList.add('collapsed');
            }
            t.addEventListener('click', () => {
                s.classList.toggle('collapsed');
                localStorage.setItem('sidebarCollapsed', s.classList.contains('collapsed'));
            });
        }
        function showFirebaseError(e) {
            console.error("Firebase error:", e);
            document.getElementById('app-loader').innerHTML = `<div class="text-center p-4"><p class="text-red-500 font-bold mb-2">Error de Conexión</p><p>No se pudo conectar a la base de datos.</p></div>`;
        }
        function setupDarkMode() {
            const t = document.getElementById('dark-mode-toggle');
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                t.checked = true;
            }
            t.addEventListener('change', () => {
                document.documentElement.classList.toggle('dark');
                localStorage.theme = t.checked ? 'dark' : 'light';
            });
        }
        function mostrarNotificacion(m, e = false) {
            const c = document.getElementById('notificacion');
            const b = e ? 'bg-red-500' : 'bg-green-600';
            const el = document.createElement('div');
            el.className = `${b} text-white px-4 py-2 rounded-lg shadow-lg flex items-center text-sm animate-pulse`;
            el.innerHTML = `<span>${e ? '❌' : '✅'}</span><span class="ml-2">${m}</span>`;
            c.appendChild(el);
            setTimeout(() => {
                el.classList.remove('animate-pulse');
                setTimeout(() => el.remove(), 3000);
            }, 500);
        }
        
        function invoicesColRef(clientId) {
            return collection(app.db, 'artifacts', app.appId, 'users', app.userId, 'clients', clientId, 'invoices');
        }
        async function addInvoice(clientId, invoice) {
            await addDoc(invoicesColRef(clientId), {
                ...invoice,
                created_at: Timestamp.now()
            });
        }
        async function listInvoices(clientId, max=50) {
            const qRef = query(invoicesColRef(clientId), orderBy('created_at','desc'), limit(max));
            const snap = await getDocs(qRef);
            return snap.docs.map(d => ({ id:d.id, ...d.data() }));
        }
        async function computeAccountsReceivable() {
            let total = 0;
            for (const c of app.clients) {
                const qRef = query(invoicesColRef(c.id), where('status','==','pendiente'));
                const snap = await getDocs(qRef);
                snap.forEach(d => total += Number(d.data().total || 0));
            }
            return total;
        }
        function computeCreditToReturn() {
            return app.clients.reduce((total, client) => total + (client.credit || 0), 0);
        }
        function computeMRR() {
            let total = 0;
            for (const c of app.clients) {
                const sv = c.services || {};
                Object.values(sv).forEach(s => total += Number(s.price||0) * (s.profiles?.length || 1));
            }
            return total;
        }
        function countUpcomingRenewals(days=7){
            const today = new Date(); today.setHours(0,0,0,0);
            const horizon = new Date(today); horizon.setDate(horizon.getDate()+days);
            let count = 0;
            for (const c of app.clients) {
                const sv = c.services || {};
                for (const s of Object.values(sv)) {
                if(!s.date) continue;
                let next = new Date(s.date+'T00:00:00');
                while (next < today) next.setMonth(next.getMonth()+1);
                if (next <= horizon) { count++; break; }
                }
            }
            return count;
        }

        function setupGlobalEventListeners() {
            document.addEventListener('click', async (e) => {
                const btn = e.target.closest('[data-role]');
                if (!btn) return;

                const role = btn.getAttribute('data-role');
                
                try {
                    if (role === 'remove-client-profile') {
                        e.preventDefault(); e.stopPropagation();
                        const serviceId = btn.getAttribute('data-service-id');
                        const profileId = btn.getAttribute('data-profile-id');
                        await handleRemoveClientProfile(serviceId, profileId);
                    }
                    else if (role === 'remove-client-service') {
                        e.preventDefault(); e.stopPropagation();
                        const serviceId = btn.getAttribute('data-service-id');
                        await handleRemoveServiceById(serviceId);
                    }
                    else if (role === 'delete-service-type') {
                        e.preventDefault(); e.stopPropagation();
                        const id = btn.getAttribute('data-id');
                        await handleDeleteServiceType(id);
                    }
                    else if (role === 'delete-master-account') {
                        e.preventDefault(); e.stopPropagation();
                        const id = btn.getAttribute('data-id');
                        await handleDeleteMasterAccount(id);
                    }
                    else if (role === 'edit-master-account') {
                        e.preventDefault(); e.stopPropagation();
                        const id = btn.getAttribute('data-id');
                        const acc = app.masterAccounts.find(a => a.id === id);
                        openMasterAccountModal(acc);
                    }
                    else if (role === 'toggle-acc-group') {
                        e.preventDefault(); e.stopPropagation();
                        const target = document.getElementById(btn.getAttribute('data-target'));
                        if (target) target.classList.toggle('hidden');
                        btn.querySelector('.chev')?.classList.toggle('rotate-90');
                    }
                    else if (role === 'toggle-password') {
                        e.preventDefault(); e.stopPropagation();
                        const input = btn.previousElementSibling;
                        const eyeOpen = btn.querySelector('.eye-open');
                        const eyeClosed = btn.querySelector('.eye-closed');
                        if (input.type === 'password') {
                            input.type = 'text';
                            eyeOpen.classList.add('hidden');
                            eyeClosed.classList.remove('hidden');
                        } else {
                            input.type = 'password';
                            eyeOpen.classList.remove('hidden');
                            eyeClosed.classList.add('hidden');
                        }
                    }
                     else if (role === 'copy-email') {
                        e.preventDefault(); e.stopPropagation();
                        const input = btn.previousElementSibling;
                        navigator.clipboard.writeText(input.value).then(() => {
                           mostrarNotificacion("Email copiado.");
                        });
                    } else if (role === 'view-invoice') {
                        e.preventDefault(); e.stopPropagation();
                        const client = app.clients.find(c => c.id === app.selectedClientId);
                        if (!client) return;
                        const invoiceId = btn.getAttribute('data-invoice-id');
                        const invoices = await listInvoices(client.id);
                        const invoice = invoices.find(i => i.id === invoiceId);
                        if (invoice) {
                            openInvoiceViewModal(invoice.content);
                        }
                    } else if (role === 'quick-wa') {
                        const c = app.clients.find(x=>x.id===app.selectedClientId);
                        if(!c?.phone) return mostrarNotificacion("Sin WhatsApp.", true);
                        const msg = `Hola ${c.name}, ¿en qué puedo ayudarte?`;
                        window.open(`https://wa.me/${c.phone.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`, '_blank');
                    } else if (role === 'toggle-suspend') {
                        const c = app.clients.find(x=>x.id===app.selectedClientId);
                        if(!c) return;
                        const next = (c.status==='suspendido')?'activo':'suspendido';
                        await updateDoc(doc(app.db,'artifacts',app.appId,'users',app.userId,'clients',c.id),{ status: next });
                        mostrarNotificacion(`Cliente ${next}.`);
                    } else if (role === 'open-fullscreen') {
                        window.open(window.location.href, '_blank');
                    }
                } catch(err) {
                    console.error(err);
                    mostrarNotificacion(err.message || 'Acción fallida', true);
                }
            });
        }

    </script>
</body>
</html>

