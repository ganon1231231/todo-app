<!DOCTYPE html>
<html lang="es" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamService Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .view { display: none; }
        .view.active { display: block; }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        .dark ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }

        .custom-checkbox {
            appearance: none; width: 18px; height: 18px; border: 2px solid #d1d5db;
            border-radius: 4px; background-color: white; position: relative;
            cursor: pointer; transition: all 0.2s;
        }
        .dark .custom-checkbox { border-color: #4b5563; background-color: #374151; }
        .custom-checkbox:checked { background-color: #3b82f6; border-color: #3b82f6; }
        .custom-checkbox:checked::after {
            content: '‚úì'; color: white; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); font-size: 12px; font-weight: bold;
        }
        
        #sidebar {
            transition: width 0.3s ease-in-out;
        }
        #sidebar.collapsed {
            width: 5rem;
        }
        #sidebar.collapsed .nav-text, #sidebar.collapsed .sidebar-toggle-text {
            display: none;
        }
        #sidebar.collapsed .nav-link, #sidebar.collapsed #sidebar-toggle {
            justify-content: center;
        }
        #sidebar #sidebar-toggle-icon {
            transition: transform 0.3s ease-in-out;
        }
        #sidebar.collapsed #sidebar-toggle-icon {
            transform: rotate(180deg);
        }
        main {
            transition: margin-left 0.3s ease-in-out;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200">
    <div id="app-loader" class="fixed inset-0 bg-slate-100 dark:bg-slate-900 flex flex-col items-center justify-center z-50 transition-opacity duration-300">
        <svg class="animate-spin h-10 w-10 text-blue-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-lg">Conectando a la base de datos...</p>
    </div>

    <div id="app-content" class="flex h-screen opacity-0 transition-opacity duration-300">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-white dark:bg-slate-800/50 border-r border-slate-200 dark:border-slate-700 flex flex-col flex-shrink-0">
            <div class="p-4 border-b border-slate-200 dark:border-slate-700 flex-shrink-0">
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white"><span class="nav-text">StreamService Pro</span></h1>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <a href="#dashboard" class="nav-link flex items-center px-3 py-2 rounded-md font-medium bg-slate-200 dark:bg-slate-700">
                    <svg class="h-6 w-6 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                    <span class="nav-text">Dashboard</span>
                </a>
                <a href="#services_dashboard" class="nav-link flex items-center px-3 py-2 rounded-md font-medium hover:bg-slate-200 dark:hover:bg-slate-700">
                    <svg class="h-6 w-6 mr-3 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" />
                    </svg>
                    <span class="nav-text">Vista Servicios</span>
                </a>
                <a href="#clients" class="nav-link flex items-center px-3 py-2 rounded-md font-medium hover:bg-slate-200 dark:hover:bg-slate-700">
                     <svg class="h-6 w-6 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 006-6v-1a3 3 0 00-3-3H9a3 3 0 00-3 3v1a6 6 0 006 6z"/></svg>
                     <span class="nav-text">Clientes</span>
                </a>
                <a href="#settings" class="nav-link flex items-center px-3 py-2 rounded-md font-medium hover:bg-slate-200 dark:hover:bg-slate-700">
                    <svg class="h-6 w-6 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.370a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.370a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.370a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.370.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    <span class="nav-text">Ajustes</span>
                </a>
            </nav>
            <div class="p-4 border-t border-slate-200 dark:border-slate-700 space-y-4 flex-shrink-0">
                 <button id="sidebar-toggle" class="w-full flex items-center px-3 py-2 rounded-md font-medium text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700">
                     <svg id="sidebar-toggle-icon" class="h-6 w-6 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" /></svg>
                     <span class="sidebar-toggle-text">Contraer</span>
                 </button>
                <label for="dark-mode-toggle" class="flex items-center cursor-pointer">
                    <div class="relative">
                        <input type="checkbox" id="dark-mode-toggle" class="sr-only">
                        <div class="block bg-slate-300 dark:bg-slate-600 w-14 h-8 rounded-full"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div>
                    </div>
                    <div class="ml-3 font-medium nav-text">Modo Oscuro</div>
                </label>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto">
            <!-- Vistas se renderizar√°n aqu√≠ -->
        </main>
    </div>

    <!-- Notificaci√≥n -->
    <div id="notificacion" class="fixed top-4 right-4 z-50"></div>
    
    <!-- Modales -->
    <div id="client-modal" class="fixed inset-0 z-40 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0"></div><div class="modal-content bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-md m-4 relative max-h-full overflow-y-auto"><form id="client-form" class="p-6"><h3 id="client-modal-title" class="text-xl font-semibold mb-4"></h3><div class="space-y-4"><div><label class="block text-sm font-medium mb-1">Nombre del Cliente</label><input type="text" name="name" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent" required></div><div><label class="block text-sm font-medium mb-1">WhatsApp (Ej: 5076...)</label><input type="tel" name="phone" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"></div><div><label class="block text-sm font-medium mb-1">Cr√©dito Previo ($)</label><input type="number" name="credit" value="0.00" step="0.01" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"></div><div><label class="block text-sm font-medium mb-1">Notas Adicionales</label><textarea name="notes" rows="3" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"></textarea></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">Estado</label><select name="status" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"><option value="activo">Activo</option><option value="moroso">Moroso</option><option value="suspendido">Suspendido</option></select></div><div><label class="block text-sm font-medium mb-1">Etiquetas (coma)</label><input type="text" name="tags" placeholder="VIP, prueba" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"></div></div><div><label class="block text-sm font-medium mb-1">Link de pago</label><input type="url" name="payment_link" placeholder="https://..." class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"></div></div><div class="flex justify-end gap-3 mt-6"><button type="button" id="modal-cancel-btn" class="bg-slate-200 dark:bg-slate-700 font-medium py-2 px-4 rounded-md">Cancelar</button><button type="submit" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-md">Guardar</button></div></form></div></div>
    <div id="service-modal" class="fixed inset-0 z-40 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0"></div><div class="modal-content bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-lg m-4 relative flex flex-col max-h-[90vh]"><div class="p-6 border-b border-slate-200 dark:border-slate-700 flex-shrink-0"><h3 class="text-xl font-semibold">A√±adir Servicio</h3></div><div class="flex-1 p-6 space-y-4 overflow-y-auto"><form id="service-form" class="space-y-4"><div><label class="block text-sm font-medium mb-1">Servicio</label><select name="serviceId" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent" required></select></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">Precio por Perfil ($)</label><input type="number" name="price" step="0.01" placeholder="0.00" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent" required></div><div><label class="block text-sm font-medium mb-1">Fecha de Inicio de Ciclo</label><input type="date" name="date" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent" required></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label class="block text-sm font-medium mb-1">Cantidad de perfiles</label><input type="number" name="qty_profiles" value="1" min="1" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"></div><div class="md:col-span-2"><label class="block text-sm font-medium mb-1">Distribuci√≥n</label><p class="text-xs text-slate-500">Se sugiere autom√°ticamente seg√∫n disponibilidad. Puedes ajustar por perfil.</p></div></div><div id="profiles-dynamic" class="mt-3 space-y-3"></div><div id="master-account-suggestion" class="hidden p-3 bg-slate-50 dark:bg-slate-900/40 border border-slate-200 dark:border-slate-700 rounded-md"><p class="text-sm font-medium mb-2">Cuentas disponibles por servicio:</p><div id="accounts-availability"></div></div></form></div><div class="flex justify-end gap-3 p-6 border-t border-slate-200 dark:border-slate-700 flex-shrink-0"><button type="button" id="service-modal-cancel-btn" class="bg-slate-200 dark:bg-slate-700 font-medium py-2 px-4 rounded-md">Cancelar</button><button type="submit" form="service-form" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-md">Guardar</button></div></div></div>
    <div id="message-modal" class="fixed inset-0 z-40 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0"></div><div class="modal-content bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-2xl m-4 relative max-h-full flex flex-col"><div class="p-6 border-b border-slate-200 dark:border-slate-700"><h3 id="message-modal-title" class="text-xl font-semibold"></h3></div><div class="p-6 flex-1 overflow-y-auto"><div id="message-modal-options" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"></div><div id="message-modal-result"><div class="flex justify-between items-center mb-2"><h4 class="font-semibold">Mensaje Generado</h4><div class="flex gap-2"><button id="copy-message-btn" class="bg-blue-500 text-white text-xs font-medium py-1 px-3 rounded hover:bg-blue-600">üìã Copiar</button><a id="whatsapp-message-btn" href="#" target="_blank" class="hidden bg-green-500 text-white text-xs font-medium py-1 px-3 rounded hover:bg-green-600">üì± WhatsApp</a></div></div><textarea id="generated-message-content" readonly class="w-full h-80 p-3 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-md text-sm resize-none"></textarea></div></div><div class="flex justify-end gap-3 p-6 border-t border-slate-200 dark:border-slate-700"><button type="button" id="message-modal-cancel-btn" class="bg-slate-200 dark:bg-slate-700 font-medium py-2 px-4 rounded-md">Cerrar</button><button id="message-modal-action-btn" class="bg-amber-500 text-white font-medium py-2 px-4 rounded-md">Generar</button></div></div></div>
    <div id="master-account-modal" class="fixed inset-0 z-40 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0"></div><div class="modal-content bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-md m-4 relative"><form id="master-account-form" class="p-6"><h3 id="master-account-modal-title" class="text-xl font-semibold mb-4"></h3><div class="space-y-4"><div><label class="block text-sm font-medium mb-1">Servicio</label><select name="serviceId" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent" required></select></div><div><label class="block text-sm font-medium mb-1">Email de la Cuenta</label><div class="relative"><input type="email" name="login_email" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent" required><button type="button" data-role="copy-email" class="absolute inset-y-0 right-0 px-3 flex items-center text-slate-500 hover:text-blue-600" title="Copiar email"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg></button></div></div><div><label class="block text-sm font-medium mb-1">Contrase√±a</label><div class="relative"><input type="password" name="password" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"><button type="button" data-role="toggle-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-slate-500 hover:text-blue-600" title="Mostrar contrase√±a"><svg class="w-5 h-5 eye-open" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg><svg class="w-5 h-5 eye-closed hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 1.274-4.057 5.064-7 9.542-7 .847 0 1.673.12 2.468.355M7.125 7.125A3 3 0 009 9m3 3a3 3 0 00-3-3m-3.875 5.25A10.025 10.025 0 0112 15c4.478 0 8.268-2.943 9.542-7a10.025 10.025 0 00-4.03-4.38M1 1l22 22"></path></svg></button></div><p class="text-xs text-slate-500 mt-1">La contrase√±a se muestra para tu referencia. Edita este campo para actualizarla.</p></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">Estado</label><select name="status" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"><option value="activa">Activa</option><option value="pausada">Pausada</option><option value="bloqueada">Bloqueada</option></select></div><div><label class="block text-sm font-medium mb-1">Plazas (override)</label><input type="number" name="seat_limit_override" min="0" placeholder="(Opcional)" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"></div></div></div><div class="flex justify-end gap-3 mt-6"><button type="button" id="master-account-modal-cancel-btn" class="bg-slate-200 dark:bg-slate-700 font-medium py-2 px-4 rounded-md">Cancelar</button><button type="submit" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-md">Guardar</button></div></form></div></div>
    <div id="invoice-view-modal" class="fixed inset-0 z-40 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0"></div><div class="modal-content bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-2xl m-4 relative max-h-full flex flex-col"><div class="p-6 border-b border-slate-200 dark:border-slate-700"><h3 class="text-xl font-semibold">Detalle de la Factura</h3></div><div class="p-6 flex-1 overflow-y-auto"><textarea id="invoice-view-content" readonly class="w-full h-96 p-3 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-md text-sm resize-none"></textarea></div><div class="flex justify-end gap-3 p-6 border-t border-slate-200 dark:border-slate-700"><button type="button" id="invoice-view-close-btn" class="bg-slate-200 dark:bg-slate-700 font-medium py-2 px-4 rounded-md">Cerrar</button></div></div></div>
    <div id="payment-modal" class="fixed inset-0 z-40 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0"></div><div class="modal-content bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-md m-4 relative"><form id="payment-form" class="p-6"><h3 class="text-xl font-semibold mb-4">Registrar Pago</h3><div class="space-y-4"><div><label class="block text-sm font-medium mb-1">Monto ($)</label><input type="number" name="amount" step="0.01" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent" required></div><div><label class="block text-sm font-medium mb-1">M√©todo de Pago</label><select name="method" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"><option>Yappy</option><option>ACH</option><option>Efectivo</option><option>Otro</option></select></div><div><label class="block text-sm font-medium mb-1">Referencia (Opcional)</label><input type="text" name="reference" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"></div></div><div class="flex justify-end gap-3 mt-6"><button type="button" id="payment-modal-cancel-btn" class="bg-slate-200 dark:bg-slate-700 font-medium py-2 px-4 rounded-md">Cancelar</button><button type="submit" class="bg-emerald-600 text-white font-medium py-2 px-4 rounded-md">Registrar</button></div></form></div></div>
    <div id="confirmation-modal" class="fixed inset-0 z-50 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0"></div><div class="modal-content bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-sm m-4 relative"><div class="p-6"><h3 id="confirmation-modal-title" class="text-lg font-semibold mb-2">Confirmar Acci√≥n</h3><p id="confirmation-modal-message" class="text-sm text-slate-600 dark:text-slate-300"></p></div><div class="flex justify-end gap-3 p-4 bg-slate-50 dark:bg-slate-700/50 rounded-b-lg"><button type="button" id="confirmation-cancel-btn" class="bg-slate-200 dark:bg-slate-600 font-medium py-2 px-4 rounded-md">Cancelar</button><button type="button" id="confirmation-confirm-btn" class="bg-red-600 text-white font-medium py-2 px-4 rounded-md">Confirmar</button></div></div></div>
    
    <!-- Modal Nueva Venta -->
    <div id="sale-modal" class="fixed inset-0 hidden items-center justify-center z-50"><div class="modal-backdrop absolute inset-0"></div><div class="relative bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-2xl m-4 p-6"><h3 class="text-xl font-semibold mb-4">Nueva venta</h3><form id="sale-form" class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="md:col-span-2"><label class="text-sm font-medium">Cliente</label><div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-1"><select id="sale-client-select" class="px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"><option value="__new__">+ Nuevo cliente‚Ä¶</option></select><input id="sale-phone" placeholder="WhatsApp (opcional)" class="px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent" /></div><div id="sale-new-client" class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2"><input id="sale-new-name" placeholder="Nombre completo" class="px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent" /><input id="sale-new-tags" placeholder="Etiquetas (coma)" class="px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent" /><input id="sale-new-credit" type="number" step="0.01" value="0" placeholder="Cr√©dito inicial" class="px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent" /></div></div><div><label class="text-sm font-medium">Servicio</label><select id="sale-service" class="mt-1 w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"></select></div><div><label class="text-sm font-medium">Perfiles</label><input id="sale-qty" type="number" min="1" value="1" class="mt-1 w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent" /></div><div><label class="text-sm font-medium">Precio por perfil ($)</label><input id="sale-price" type="number" step="0.01" class="mt-1 w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent" /></div><div><label class="text-sm font-medium">Inicio de ciclo</label><input id="sale-date" type="date" class="mt-1 w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent" /></div><div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-3"><label class="flex items-center gap-2"><input id="sale-generate-msg" type="checkbox" class="h-4 w-4 custom-checkbox" checked> <span>Generar mensaje de bienvenida</span></label><label class="flex items-center gap-2"><input id="sale-create-invoice" type="checkbox" class="h-4 w-4 custom-checkbox" checked> <span>Emitir factura de este ciclo</span></label></div><div class="md:col-span-2"><label class="text-sm font-medium">Link de pago (opcional, sobreescribe m√©todos guardados)</label><input id="sale-paylink" type="url" placeholder="https://‚Ä¶" class="mt-1 w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent" /></div><div class="md:col-span-2 flex justify-end gap-2 pt-2"><button type="button" id="sale-cancel" class="px-3 py-2 bg-slate-200 dark:bg-slate-700 rounded-md">Cancelar</button><button class="px-3 py-2 bg-blue-600 text-white rounded-md">Guardar Venta</button></div></form></div></div>

    <!-- Modal Editar Servicio del Cat√°logo -->
    <div id="service-catalog-modal" class="fixed inset-0 z-40 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0"></div><div class="modal-content bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-md m-4 relative"><form id="service-catalog-form" class="p-6"><h3 id="service-catalog-modal-title" class="text-xl font-semibold mb-4"></h3><div class="space-y-4"><div><label class="text-sm font-medium">Nombre del Servicio</label><input type="text" name="name" placeholder="Ej: Disney+" class="mt-1 w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent" required></div><div class="grid grid-cols-2 gap-4"><div><label class="text-sm font-medium">L√≠mite de Plazas</label><input type="number" name="seat_limit" value="1" min="1" class="mt-1 w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"></div><div><label class="text-sm font-medium">Longitud del PIN</label><input type="number" name="pin_length" value="4" min="0" class="mt-1 w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"></div><div><label class="text-sm font-medium">Costo por Perfil ($)</label><input type="number" name="cost_per_profile" step="0.01" value="0" class="mt-1 w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"></div><div><label class="text-sm font-medium">Ciclo (d√≠as)</label><input type="number" name="billing_cycle_days" value="30" class="mt-1 w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"></div></div><div><label class="flex items-center"><input type="checkbox" name="isNetflix" class="custom-checkbox mr-2"><span class="text-sm">Es Netflix (L√≥gica Especial)</span></label></div></div><div class="flex justify-end gap-3 mt-6"><button type="button" id="service-catalog-modal-cancel-btn" class="bg-slate-200 dark:bg-slate-700 font-medium py-2 px-4 rounded-md">Cancelar</button><button type="submit" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-md">Guardar Cambios</button></div></form></div></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, doc, onSnapshot, addDoc, setDoc, deleteDoc, updateDoc, arrayUnion, runTransaction, getDoc, getDocs, query, where, orderBy, limit, Timestamp, collectionGroup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBdIebzMYrtpo2ifcX3xcsqFVB8t4XCLeo",
      authDomain: "streamservice-pro.firebaseapp.com",
      projectId: "streamservice-pro",
      storageBucket: "streamservice-pro.firebasestorage.app",
      messagingSenderId: "574901627845",
      appId: "1:574901627845:web:8d104ae5c70aac59c8f9ac"
    };

    const app = {
        appId: typeof __app_id !== 'undefined' ? __app_id : 'default-app-id',
        currentView: 'dashboard',
        selectedClientId: null,
        clients: [],
        services: [],
        masterAccounts: [],
        paymentMethods: [],
        ui: {}
    };
    
    let confirmationCallback = null;
    let chartInstances = {};
    let selectedServiceCatalogId = null;

    function showFirebaseError(error) {
        console.error("Firebase Error:", error.message);
        const loader = document.getElementById('app-loader');
        if (loader) {
            loader.innerHTML = `<div class="text-center p-4"><svg class="mx-auto h-12 w-12 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><h3 class="mt-2 text-lg font-medium text-red-600 dark:text-red-400">Error de Conexi√≥n</h3><div class="mt-2 text-sm text-slate-600 dark:text-slate-400"><p>No se pudo conectar a Firebase.</p><p class="mt-1 font-mono bg-slate-200 dark:bg-slate-800 p-2 rounded text-xs">${error.message}</p></div><p class="mt-4 text-xs text-slate-500">Aseg√∫rate de que la configuraci√≥n de Firebase en el c√≥digo es correcta y que has habilitado el inicio de sesi√≥n an√≥nimo en tu proyecto.</p></div>`;
        }
        const appContent = document.getElementById('app-content');
        if (appContent) appContent.classList.add('hidden');
    }
    
    document.addEventListener('DOMContentLoaded', async () => {
        if (!firebaseConfig.apiKey) { showFirebaseError(new Error("Missing Firebase config")); return; }
        try {
            app.firebaseApp = initializeApp(firebaseConfig);
            app.auth = getAuth(app.firebaseApp);
            app.db = getFirestore(app.firebaseApp);
            
            const authUser = await new Promise((resolve, reject) => {
                const unsubscribe = onAuthStateChanged(app.auth, async (user) => {
                    unsubscribe();
                    if (user) return resolve(user);
                    try {
                        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        const creds = token ? await signInWithCustomToken(app.auth, token).catch(e => {
                            if (e.code === 'auth/custom-token-mismatch') return signInAnonymously(app.auth);
                            throw e;
                        }) : await signInAnonymously(app.auth);
                        resolve(creds.user);
                    } catch (e) { reject(e); }
                });
            });

            if (authUser) {
                app.userId = authUser.uid;
                initializeAppUI();
            } else { throw new Error("Authentication failed."); }
        } catch (error) { showFirebaseError(error); }
    });

    function initializeAppUI() {
        app.ui.mainContent = document.querySelector('main');
        setupNavigation();
        setupDarkMode();
        setupSidebar();
        setupClientModal();
        setupServiceModal();
        setupMessageModal();
        setupMasterAccountModal();
        setupInvoiceViewModal();
        setupPaymentModal();
        setupConfirmationModal();
        setupSaleModal();
        setupServiceCatalogModal();
        setupRealtimeListeners();
        setupGlobalEventListeners();
        
        renderView('dashboard');

        document.getElementById('app-loader').classList.add('opacity-0');
        document.getElementById('app-content').classList.remove('opacity-0');
        setTimeout(() => document.getElementById('app-loader').style.display = 'none', 300);
    }
    
    // --- VISTAS Y NAVEGACI√ìN ---
    function setupNavigation() {
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const viewName = link.getAttribute('href').substring(1);
                renderView(viewName);
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('bg-slate-200', 'dark:bg-slate-700'));
                link.classList.add('bg-slate-200', 'dark:bg-slate-700');
            });
        });
    }
    
    function renderView(viewName, params = {}) {
        app.currentView = viewName;
        const contentWrapper = `<div class="max-w-7xl mx-auto p-6 lg:p-8"></div>`;
        app.ui.mainContent.innerHTML = contentWrapper;
        const container = app.ui.mainContent.firstChild;

        switch(viewName) {
            case 'dashboard':
                container.innerHTML = getDashboardViewHTML();
                attachDashboardEventListeners();
                updateDashboard();
                break;
            case 'services_dashboard':
                renderServicesDashboardView(container);
                break;
            case 'clients':
                app.selectedClientId = params.clientId || null;
                renderClientsView(container);
                break;
            case 'settings':
                container.innerHTML = getSettingsViewHTML();
                attachSettingsEventListeners();
                populateServicesSettings();
                populateMasterAccountsSettings();
                populatePaymentMethodsSettings();
                break;
        }
    }
    
    // --- DATOS (FIRESTORE) ---
    function setupRealtimeListeners() {
        onSnapshot(query(collection(app.db,'artifacts',app.appId,'users',app.userId,'clients'), orderBy('name')), (snapshot) => {
            app.clients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (app.currentView === 'dashboard') updateDashboard();
            if (app.currentView === 'clients') renderClientsView(app.ui.mainContent.firstChild);
            if (app.currentView === 'services_dashboard') renderServicesDashboardView(app.ui.mainContent.firstChild);
        });

        onSnapshot(collection(app.db, 'artifacts', app.appId, 'users', app.userId, 'services'), (snapshot) => {
            app.services = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (app.currentView === 'settings') renderView('settings');
            if (app.currentView === 'clients' && app.selectedClientId) renderClientsView(app.ui.mainContent.firstChild);
            if (app.currentView === 'services_dashboard') renderServicesDashboardView(app.ui.mainContent.firstChild);
        });

        onSnapshot(collection(app.db, 'artifacts', app.appId, 'users', app.userId, 'master_accounts'), (snapshot) => {
            app.masterAccounts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (app.currentView === 'settings') populateMasterAccountsSettings();
            if (app.currentView === 'services_dashboard') renderServicesDashboardView(app.ui.mainContent.firstChild);
        });

        onSnapshot(collection(app.db, 'artifacts', app.appId, 'users', app.userId, 'payment_methods'), (snapshot) => {
            app.paymentMethods = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (app.currentView === 'settings') populatePaymentMethodsSettings();
        });
    }
    
    // --- VISTA: DASHBOARD ---
    function getDashboardViewHTML() {
        return `
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold">Dashboard</h2>
            </div>
            <!-- Acciones r√°pidas -->
            <div class="flex flex-wrap gap-2 mb-6">
              <button id="qa-new-sale" class="px-3 py-2 bg-blue-600 text-white rounded-md font-medium text-sm">Nueva Venta</button>
              <button id="qa-new-client" class="px-3 py-2 bg-slate-200 dark:bg-slate-700 rounded-md font-medium text-sm">Nuevo Cliente</button>
              <button id="qa-register-payment" class="px-3 py-2 bg-emerald-600 text-white rounded-md font-medium text-sm">Registrar Pago</button>
            </div>
            <div id="db-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700"> <h3 class="text-lg font-medium text-slate-500 dark:text-slate-400">Clientes Activos</h3> <p id="db-active-clients" class="text-4xl font-bold mt-2">0</p> </div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700"> <h3 class="text-lg font-medium text-slate-500 dark:text-slate-400">Cuentas por Cobrar</h3> <p id="db-accounts-receivable" class="text-4xl font-bold mt-2">$0.00</p> </div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700"> <h3 class="text-lg font-medium text-slate-500 dark:text-slate-400">Cr√©dito a Favor</h3> <p id="db-credit-to-return" class="text-4xl font-bold mt-2">$0.00</p> </div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700"> <h3 class="text-lg font-medium text-slate-500 dark:text-slate-400">Pr√≥ximos Vencimientos</h3> <p id="db-upcoming-renewals" class="text-4xl font-bold mt-2">0</p> </div>
            </div>
            <div class="mt-8 grid grid-cols-1 lg:grid-cols-5 gap-6">
                <div class="lg:col-span-3 bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700">
                    <h3 class="text-lg font-medium mb-4">Ingresos por Mes (√öltimos 6 meses)</h3>
                    <canvas id="income-chart"></canvas>
                </div>
                <div class="lg:col-span-2 bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700">
                    <h3 class="text-lg font-medium mb-4">Distribuci√≥n de Servicios Activos</h3>
                    <canvas id="services-chart"></canvas>
                </div>
            </div>
        `;
    }

    function attachDashboardEventListeners() {
        const qaNewSale = document.getElementById('qa-new-sale');
        if (qaNewSale) qaNewSale.onclick = openSaleModal;

        const qaNewClient = document.getElementById('qa-new-client');
        if (qaNewClient) qaNewClient.onclick = openClientModal;

        const qaRegisterPayment = document.getElementById('qa-register-payment');
        if (qaRegisterPayment) qaRegisterPayment.onclick = () => {
            if (!app.clients.length) { 
                mostrarNotificacion('Primero debes a√±adir un cliente.', true); 
                return; 
            }
            openQuickPaymentModal();
        };
    }

    async function updateDashboard() {
        if (app.currentView !== 'dashboard') return;
        const active = document.getElementById('db-active-clients');
        if (active) active.textContent = app.clients?.length || 0;

        const arEl = document.getElementById('db-accounts-receivable');
        if (arEl) arEl.textContent = `$${await computeAccountsReceivable()}`;

        const creditEl = document.getElementById('db-credit-to-return');
        if(creditEl) creditEl.textContent = `$${computeCreditToReturn()}`;

        const upEl = document.getElementById('db-upcoming-renewals');
        if (upEl) upEl.textContent = countUpcomingRenewals(7);
        
        renderDashboardCharts();
    }
    
    // --- VISTA: CLIENTES ---
    function renderClientsView(container) {
        if (app.selectedClientId) {
            renderClientProfileView(container, app.selectedClientId);
        } else {
            renderClientListView(container);
        }
    }
    
    function renderClientListView(container) {
        container.innerHTML = `<div class="flex justify-between items-center mb-6"> <h2 class="text-3xl font-bold">Clientes</h2><div class="flex gap-2"><button id="add-client-btn" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-md hover:bg-blue-700">A√±adir Cliente</button></div> </div> <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700"> <div class="p-4"><input type="text" id="client-search" placeholder="Buscar por nombre, tel, notas o etiqueta..." class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"></div> <div class="overflow-x-auto"> <table class="w-full text-left"> <thead class="bg-slate-50 dark:bg-slate-700/50"> <tr> <th class="p-4 font-semibold">Nombre</th> <th class="p-4 font-semibold">Contacto</th> <th class="p-4 font-semibold text-center">Servicios Activos</th> <th class="p-4 font-semibold">Pr√≥ximo Vencimiento</th> </tr> </thead> <tbody id="clients-table-body"></tbody> </table> </div> </div>`;
        document.getElementById('add-client-btn').addEventListener('click', () => openClientModal());
        document.getElementById('client-search').addEventListener('input', (e) => populateClientsTable(e.target.value));
        populateClientsTable();
    }

    function populateClientsTable(filter = '') {
        const tableBody = document.getElementById('clients-table-body');
        const lowerCaseFilter = filter.toLowerCase();
        const filteredClients = app.clients.filter(c => {
            const bag = [ c.name, c.phone, c.notes, ...(c.tags||[]) ].join(' ').toLowerCase();
            return bag.includes(lowerCaseFilter);
        });
        if (filteredClients.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-slate-500">No se encontraron clientes.</td></tr>`;
            return;
        }
        tableBody.innerHTML = filteredClients.map(client => {
            const serviceCount = client.services ? Object.keys(client.services).length : 0;
            let nextDueDate = 'N/A';
            if (serviceCount > 0) {
                const dates = [];
                Object.values(client.services).forEach(s_data => {
                    const groups = getServiceGroups(s_data);
                    groups.forEach(g => { if(g.date) dates.push(g.date) });
                });

                if (dates.length > 0) {
                    const nextDates = dates.map(d_str => {
                        let next = new Date(d_str + 'T00:00:00');
                        while (next < new Date()) next.setMonth(next.getMonth() + 1);
                        return next;
                    });
                    nextDueDate = formatDate(new Date(Math.min.apply(null, nextDates)));
                }
            }
            const chips = (client.tags||[]).slice(0,2).map(t=>`<span class="text-[10px] bg-slate-200 dark:bg-slate-700 px-2 py-0.5 rounded">${t}</span>`).join(' ');
            const statusChip = client.status==='moroso' ? 'bg-red-100 text-red-700' : client.status==='suspendido' ? 'bg-yellow-100 text-yellow-700' : 'bg-emerald-100 text-emerald-700';
            return `<tr class="border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50 cursor-pointer" data-id="${client.id}"> <td class="p-4 font-medium">${client.name} <span class="ml-2 text-[10px] ${statusChip} px-2 py-0.5 rounded">${client.status||'activo'}</span> <span class="ml-1">${chips}</span></td> <td class="p-4 text-slate-500">${client.phone || 'No registrado'}</td> <td class="p-4 text-slate-500 text-center">${serviceCount}</td> <td class="p-4 text-slate-500 font-mono">${nextDueDate}</td> </tr>`;
        }).join('');
        tableBody.querySelectorAll('tr').forEach(row => row.addEventListener('click', () => renderView('clients', {
            clientId: row.dataset.id
        })));
    }

    function renderClientProfileView(container, clientId) {
        const client = app.clients.find(c => c.id === clientId);
        if (!client) {
            renderView('clients');
            return;
        }
        container.innerHTML = `<div class="mb-6"> <button id="back-to-clients" class="text-sm font-medium text-blue-600 hover:underline">&larr; Volver</button> <div class="flex justify-between items-start mt-2"> <div> <h2 class="text-3xl font-bold">${client.name}</h2> <p class="text-slate-500">${client.phone || 'Sin WhatsApp'}</p> <p class="text-sm text-slate-500 mt-2 whitespace-pre-wrap">${client.notes || 'Sin notas.'}</p> </div><div class="flex items-center gap-2"><button type="button" data-role="quick-wa" class="bg-green-600 text-white font-medium py-2 px-3 rounded-md">WhatsApp</button><button type="button" data-role="toggle-suspend" class="bg-yellow-500 text-white font-medium py-2 px-3 rounded-md">Suspender/Reactivar</button><button id="edit-client-btn" class="bg-slate-200 dark:bg-slate-700 font-medium py-2 px-4 rounded-md">Editar</button> <button id="delete-client-btn" class="bg-red-600 text-white font-medium py-2 px-4 rounded-md">Eliminar</button></div></div> </div> <div class="grid grid-cols-1 lg:grid-cols-3 gap-6"> <div class="lg:col-span-2 space-y-6"> <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-6"> <div class="flex justify-between items-center mb-4"> <h3 class="text-xl font-semibold">Servicios Contratados</h3> <div class="flex gap-2"><button id="send-all-credentials-btn" class="text-sm bg-sky-100 text-sky-700 dark:bg-sky-900/50 dark:text-sky-300 font-medium py-1 px-3 rounded-md">Enviar Todas las Credenciales</button><button id="add-service-to-client-btn" class="text-sm bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300 font-medium py-1 px-3 rounded-md">A√±adir Servicio</button></div> </div> <div id="client-services-list" class="space-y-3"></div> </div> <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-6"> <h3 class="text-xl font-semibold mb-4">Facturaci√≥n y Notificaciones</h3> <div class="flex flex-wrap gap-2"><button id="generate-special-invoice-btn" class="bg-amber-500 text-white font-medium py-2 px-4 rounded-md">Generar Factura</button> <button id="notify-balance-btn" class="bg-sky-500 text-white font-medium py-2 px-4 rounded-md hidden">Notificar Saldo Pendiente</button></div></div> </div> <div class="space-y-6"> <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-6"> <h3 class="text-xl font-semibold mb-4">Historial de Facturas</h3> <div id="client-invoice-history" class="max-h-96 overflow-y-auto"></div> </div> </div> </div>`;
        document.getElementById('back-to-clients').addEventListener('click', () => renderView('clients'));
        document.getElementById('edit-client-btn').addEventListener('click', () => openClientModal(client));
        document.getElementById('delete-client-btn').addEventListener('click', () => {
            openConfirmationModal(`¬øEst√°s seguro de que quieres eliminar a ${client.name}? Esta acci√≥n no se puede deshacer.`, () => handleDeleteClient(client));
        });
        document.getElementById('add-service-to-client-btn').addEventListener('click', () => openServiceModal(client));
        document.getElementById('send-all-credentials-btn').addEventListener('click', () => handleGenerateCombinedWelcomeMessage(client));
        document.getElementById('generate-special-invoice-btn').addEventListener('click', () => openInvoiceModal(client));
        
        const notifyBtn = document.getElementById('notify-balance-btn');
        if (client.pending_ar_cents && client.pending_ar_cents > 0) {
            notifyBtn.classList.remove('hidden');
            notifyBtn.addEventListener('click', () => handleNotifyBalance(client));
        }

        populateClientServices(client);
        populateClientInvoices(client);
        const statementBox = document.createElement('div');
        statementBox.className = 'mt-6';
        container.querySelector('.lg\\:col-span-2').appendChild(statementBox);
        renderClientStatement(statementBox, client);
    }

    async function handleDeleteClient(client) {
        await deleteDoc(doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'clients', client.id));
        renderView('clients');
    }
    
    function populateClientServices(client) {
        const container = document.getElementById('client-services-list');
        const clientServices = client.services || {};
        if (Object.keys(clientServices).length === 0) {
            container.innerHTML = `<p class="text-center text-slate-500 py-4">Sin servicios activos.</p>`;
            return;
        }

        let finalHTML = '';
        for (const [serviceId, serviceData] of Object.entries(clientServices)) {
            const serviceInfo = app.services.find(s => s.id === serviceId);
            if (!serviceInfo) continue;

            const groups = getServiceGroups(serviceData);
            
            finalHTML += `
            <div class="border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden">
                <button data-role="toggle-accordion" class="w-full flex items-center justify-between p-3 bg-slate-100 dark:bg-slate-700/50 hover:bg-slate-200 dark:hover:bg-slate-700">
                    <span class="font-medium">${serviceInfo.name}</span>
                    <div class="flex items-center gap-2">
                        <button type="button" data-role="remove-client-service" data-service-id="${serviceId}" class="text-red-500 hover:text-red-700 text-xl font-bold" aria-label="Quitar servicio completo" title="Quitar servicio completo">&times;</button>
                        <svg class="w-4 h-4 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </div>
                </button>
                <div class="accordion-content p-3 space-y-3">
                ${groups.map(group => {
                    const profiles = Array.isArray(group.profiles) ? group.profiles : [];
                    const profilesHTML = profiles.length ? `
                    <div class="mt-2 space-y-2">
                        ${profiles.map(p => `
                        <div class="flex items-center justify-between p-2 rounded bg-white/50 dark:bg-slate-800/30 border border-slate-200 dark:border-slate-700">
                            <div class="min-w-0">
                            <p class="text-sm font-medium truncate">${p.profile_name || 'Perfil'}</p>
                            <p class="text-xs text-slate-500">Cuenta: ${p.login_email} ‚Ä¢ PIN: ${p.pin || 'N/A'}</p>
                            </div>
                            <div class="flex items-center gap-2">
                            <button type="button" data-role="remove-client-profile"
                                data-service-id="${serviceId}" data-group-id="${group.groupId}" data-profile-id="${p.profile_id}"
                                class="text-red-500 hover:text-red-700 text-sm font-medium">Quitar</button>
                            </div>
                        </div>
                        `).join('')}
                    </div>` : `<p class="text-xs text-slate-500 mt-1">Sin perfiles asignados.</p>`;

                    return `<div class="p-2 border-t border-slate-200 dark:border-slate-600">
                            <div class="flex items-center justify-between">
                                <p class="text-sm text-slate-500">
                                Compra del ${group.date || 'N/A'} |
                                Precio: $${(group.price||0).toFixed(2)} |
                                Perfiles: ${profiles.length}
                                </p>
                                <button type="button" data-role="generate-welcome" data-service-id="${serviceId}" data-group-id="${group.groupId}" class="text-sm bg-sky-100 text-sky-700 dark:bg-sky-900/50 dark:text-sky-300 font-medium py-1 px-3 rounded-md">Enviar Credenciales</button>
                            </div>
                        ${profilesHTML}
                        </div>`
                }).join('')}
                </div>
            </div>`;
        }
        container.innerHTML = finalHTML;
    }
    
    async function populateClientInvoices(client) {
        const container = document.getElementById('client-invoice-history');
        const invoices = await listInvoices(client.id);
        if (invoices.length === 0) {
            container.innerHTML = `<p class="text-center text-slate-500 py-4">Sin historial.</p>`;
            return;
        }
        container.innerHTML = invoices.map((inv, idx) => {
            return `
            <div class="flex items-center justify-between p-2 border-b border-slate-200 dark:border-slate-700">
            <div>
                <p class="text-sm font-medium">${inv.issued_at?.toDate().toLocaleString('es-PA') || ''} ‚Äî <span class="uppercase text-xs">${inv.status}</span></p>
                <p class="text-xs text-slate-500 mt-1 whitespace-pre-wrap line-clamp-2">${inv.content}</p>
            </div>
            <div class="flex gap-2">
                ${inv.payment_link ? `<a href="${inv.payment_link}" target="_blank" class="text-xs bg-emerald-600 text-white py-1 px-2 rounded">Pagar</a>` : ''}
                <button type="button" data-role="view-invoice" data-invoice-id="${inv.id}" class="text-sm bg-slate-200 dark:bg-slate-700 font-medium py-1 px-3 rounded-md">Ver</button>
                <button type="button" data-role="delete-invoice" data-invoice-id="${inv.id}" class="text-sm bg-red-600 hover:bg-red-700 text-white font-medium py-1 px-3 rounded-md">Eliminar</button>
            </div>
            </div>`;
        }).join('');
    }
    
    // --- VISTA: AJUSTES ---
    function getSettingsViewHTML() {
        return `<div class="flex justify-between items-center mb-6"> <h2 class="text-3xl font-bold">Ajustes del Negocio</h2></div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Cat√°logo de Servicios -->
                <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700">
                    <div class="p-6 border-b border-slate-200 dark:border-slate-700">
                        <h3 class="text-xl font-semibold">Cat√°logo de Servicios</h3>
                        <p class="text-sm text-slate-500 mt-1">Define los tipos de servicios que ofreces y sus reglas.</p>
                    </div>
                    <div id="services-settings-list" class="p-6 space-y-3"></div>
                    <form id="add-service-form" class="p-6 border-t border-slate-200 dark:border-slate-700 space-y-4">
                        <h4 class="font-semibold">A√±adir Nuevo Servicio al Cat√°logo</h4>
                        <div><label class="text-sm font-medium">Nombre del Servicio</label><input type="text" name="name" placeholder="Ej: Disney+" class="mt-1 w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent" required></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-sm font-medium">L√≠mite de Plazas</label><input type="number" name="seat_limit" value="1" min="1" class="mt-1 w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"></div>
                            <div><label class="text-sm font-medium">Longitud del PIN</label><input type="number" name="pin_length" value="4" min="0" class="mt-1 w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"></div>
                            <div><label class="text-sm font-medium">Costo por Perfil ($)</label><input type="number" name="cost_per_profile" step="0.01" value="0" class="mt-1 w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"></div>
                            <div><label class="text-sm font-medium">Ciclo (d√≠as)</label><input type="number" name="billing_cycle_days" value="30" class="mt-1 w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"></div>
                        </div>
                        <div><label class="flex items-center"><input type="checkbox" name="isNetflix" class="custom-checkbox mr-2"><span class="text-sm">Es Netflix (L√≥gica Especial)</span></label></div>
                        <button type="submit" class="w-full bg-blue-600 text-white font-medium py-2 px-4 rounded-md hover:bg-blue-700">A√±adir al Cat√°logo</button>
                    </form>
                </div>

                <!-- Inventario de Cuentas Maestras -->
                <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700">
                     <div class="p-6 border-b border-slate-200 dark:border-slate-700">
                         <h3 class="text-xl font-semibold">Inventario de Cuentas Maestras</h3>
                         <p class="text-sm text-slate-500 mt-1">Registra tus cuentas principales y sus credenciales.</p>
                     </div>
                    <div id="master-accounts-list"></div>
                     <div class="p-6 border-t border-slate-200 dark:border-slate-700">
                         <button id="add-master-account-btn" class="w-full bg-green-600 text-white font-medium py-2 px-4 rounded-md hover:bg-green-700">A√±adir Cuenta Maestra</button>
                     </div>
                </div>
            </div>
            <!-- M√©todos de Pago -->
            <div class="mt-8 bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700">
                <div class="p-6 border-b border-slate-200 dark:border-slate-700">
                    <h3 class="text-xl font-semibold">M√©todos de Pago</h3>
                    <p class="text-sm text-slate-500 mt-1">Define la informaci√≥n que ver√°n tus clientes para pagarte.</p>
                </div>
                <div id="payment-methods-list" class="p-6 space-y-3"></div>
                <form id="add-payment-method-form" class="p-6 border-t border-slate-200 dark:border-slate-700 space-y-4">
                    <h4 class="font-semibold">A√±adir Nuevo M√©todo de Pago</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="text-sm font-medium">Nombre del M√©todo</label><input type="text" name="name" placeholder="Ej: Yappy, Nequi, ACH" class="mt-1 w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent" required></div>
                        <div><label class="text-sm font-medium">Instrucciones / Datos</label><input type="text" name="details" placeholder="Ej: 6123-4567 / A nombre de..." class="mt-1 w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent" required></div>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-medium py-2 px-4 rounded-md hover:bg-indigo-700">Guardar M√©todo</button>
                </form>
            </div>
            `;
    }
    
    function attachSettingsEventListeners() {
        document.getElementById('add-service-form').addEventListener('submit', handleAddService);
        document.getElementById('add-master-account-btn').addEventListener('click', () => openMasterAccountModal());
        document.getElementById('add-payment-method-form').addEventListener('submit', handleAddPaymentMethod);
    }

    async function handleAddService(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const name = formData.get('name').trim();
        if (name) {
            await addDoc(collection(app.db, 'artifacts', app.appId, 'users', app.userId, 'services'), { 
                name: name,
                seat_limit: parseInt(formData.get('seat_limit')) || 1,
                pin_length: parseInt(formData.get('pin_length')) || 0,
                cost_per_profile_cents: toCents(formData.get('cost_per_profile')),
                billing_cycle_days: parseInt(formData.get('billing_cycle_days')) || 30,
                isNetflix: formData.get('isNetflix') === 'on'
            });
            e.target.reset();
        }
    }

    async function handleAddPaymentMethod(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const name = formData.get('name').trim();
        const details = formData.get('details').trim();
        if (name && details) {
            await addDoc(collection(app.db, 'artifacts', app.appId, 'users', app.userId, 'payment_methods'), {
                name,
                details
            });
            e.target.reset();
            mostrarNotificacion("M√©todo de pago guardado.");
        }
    }

    function populateServicesSettings() {
        const container = document.getElementById('services-settings-list');
        if (app.services.length === 0) {
            container.innerHTML = `<p class="text-center text-slate-500 py-4">A√∫n no has definido servicios en tu cat√°logo.</p>`; return;
        }
        container.innerHTML = app.services.map(service => `
            <div class="flex items-center justify-between p-3 rounded-md bg-slate-100 dark:bg-slate-700/50">
                <div>
                    <p class="font-medium">${service.name} ${service.isNetflix ? '<span class="text-xs text-red-500">(Netflix)</span>' : ''}</p>
                    <p class="text-sm text-slate-500">Plazas: ${service.seat_limit} | PIN: ${service.pin_length} | Costo: $${fromCents(service.cost_per_profile_cents)} | Ciclo: ${service.billing_cycle_days || 30}d</p>
                </div>
                <div class="flex items-center gap-2">
                    <button type="button" data-role="edit-service-type" data-id="${service.id}" class="text-blue-600 hover:text-blue-800 text-sm font-medium">Editar</button>
                    <button type="button" data-role="delete-service-type" data-id="${service.id}" class="text-red-500 hover:text-red-700 text-xl font-bold" aria-label="Eliminar servicio del cat√°logo" title="Eliminar servicio del cat√°logo">&times;</button>
                </div>
            </div>
        `).join('');
    }
    
    function populateMasterAccountsSettings() {
        const container = document.getElementById('master-accounts-list');
        if (!app.masterAccounts.length) {
            container.innerHTML = `<p class="text-center text-slate-500 p-6">No has registrado ninguna cuenta maestra.</p>`;
            return;
        }

        const svcById = {};
        app.services.forEach(s => svcById[s.id] = s);

        const groups = {};
        for (const acc of app.masterAccounts) {
            const sid = acc.serviceId || 'unknown';
            if (!groups[sid]) groups[sid] = [];
            groups[sid].push(acc);
        }

        const searchBoxId = 'master-acc-search';
        const searchHTML = `<div class="p-4"><input type="text" id="${searchBoxId}" placeholder="Buscar por email o estado..." class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"></div>`;

        let html = searchHTML + '<div class="px-4 pb-4">';

        Object.entries(groups).forEach(([serviceId, accounts], idx) => {
            const svc = svcById[serviceId];
            const title = svc ? svc.name : 'Servicio desconocido';
            const groupId = `acc-group-${serviceId}`;
            const limitSum = accounts.reduce((a,acc) => a + effectiveSeatLimit(acc, svc), 0);
            const usedSum  = accounts.reduce((a,acc) => a + (acc.seats_used || 0), 0);

            html += `
            <div class="rounded-lg border border-slate-200 dark:border-slate-700 overflow-hidden mb-3">
                <button type="button" data-role="toggle-acc-group" data-target="${groupId}" class="w-full flex items-center justify-between px-4 py-3 bg-slate-100 dark:bg-slate-700/50 hover:bg-slate-200 dark:hover:bg-slate-700">
                    <span class="font-semibold">${title}</span>
                    <div class="flex items-center gap-4">
                        <span class="text-xs text-slate-500">${usedSum}/${limitSum} ocupadas</span>
                        <span class="chev transition-transform">&#9656;</span>
                    </div>
                </button>
                <div id="${groupId}" class="hidden">
                <div class="p-3 space-y-2">
                    ${accounts.map(acc => {
                        const limit = effectiveSeatLimit(acc, svc);
                        const used  = acc.seats_used || 0;
                        const pct   = limit ? Math.min(100, Math.round((used / limit) * 100)) : 0;
                        const color = pct > 80 ? 'bg-red-500' : (pct > 50 ? 'bg-yellow-500' : 'bg-green-500');
                        const statusChip = acc.status === 'pausada' ? 'bg-yellow-600' : acc.status === 'bloqueada' ? 'bg-red-600' : 'bg-emerald-600';
                        return `
                        <div class="flex items-center justify-between p-3 rounded-md bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 acc-item"
                            data-search="${(acc.login_email||'').toLowerCase()} ${acc.status||''}">
                        <div class="min-w-0">
                            <p class="font-medium truncate">
                            ${acc.login_email}
                            <span class="text-[10px] text-white ${statusChip} px-2 py-0.5 rounded-full ml-2 uppercase">${acc.status||'activa'}</span>
                            </p>
                            <div class="flex items-center gap-2 mt-1">
                            <div class="w-28 h-2 bg-slate-300 dark:bg-slate-600 rounded-full">
                                <div class="${color} h-2 rounded-full" style="width:${pct}%"></div>
                            </div>
                            <p class="text-xs text-slate-500">${used} / ${limit} plazas</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                            <button type="button" data-role="edit-master-account" data-id="${acc.id}" class="text-blue-600 hover:text-blue-800 text-sm font-medium">Editar</button>
                            <button type="button" data-role="delete-master-account" data-id="${acc.id}" class="text-red-500 hover:text-red-700 text-xl font-bold" aria-label="Eliminar">&times;</button>
                        </div>
                        </div>`;
                    }).join('')}
                </div>
                </div>
            </div>
            `;
        });
        html += '</div>';
        container.innerHTML = html;

        const search = document.getElementById(searchBoxId);
        if (search) {
            search.addEventListener('input', () => {
            const q = search.value.trim().toLowerCase();
            container.querySelectorAll('.acc-item').forEach(el => {
                const bag = (el.getAttribute('data-search') || '');
                el.style.display = bag.includes(q) ? 'flex' : 'none';
            });
            });
        }
    }

    function populatePaymentMethodsSettings() {
        const container = document.getElementById('payment-methods-list');
        if (!container) return;
        if (app.paymentMethods.length === 0) {
            container.innerHTML = `<p class="text-center text-slate-500 py-4">No has a√±adido m√©todos de pago.</p>`;
            return;
        }
        container.innerHTML = app.paymentMethods.map(method => `
            <div class="flex items-center justify-between p-3 rounded-md bg-slate-100 dark:bg-slate-700/50">
                <div>
                    <p class="font-medium">${method.name}</p>
                    <p class="text-sm text-slate-500">${method.details}</p>
                </div>
                <button type="button" data-role="delete-payment-method" data-id="${method.id}" class="text-red-500 hover:text-red-700 text-xl font-bold" aria-label="Eliminar m√©todo de pago" title="Eliminar m√©todo de pago">&times;</button>
            </div>
        `).join('');
    }


    // --- MODALES ---
    let selectedMasterAccountId = null;

    function setupClientModal() { app.ui.clientModal = document.getElementById('client-modal'); app.ui.clientModal.querySelector('.modal-backdrop').addEventListener('click', closeClientModal); document.getElementById('modal-cancel-btn').addEventListener('click', closeClientModal); document.getElementById('client-form').addEventListener('submit', handleClientFormSubmit); }
    async function handleClientFormSubmit(e) { e.preventDefault(); const d = new FormData(e.target); const tagsStr = d.get('tags') || ''; const cd = {name:d.get('name'),phone:d.get('phone'),credit:toCents(d.get('credit')),notes:d.get('notes'),status:d.get('status')||'activo',tags:tagsStr?tagsStr.split(',').map(t=>t.trim()).filter(Boolean):[],payment_link: d.get('payment_link') || null,}; try{if(app.selectedClientId){ await updateDoc(doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'clients', app.selectedClientId), cd);}else{cd.services={};cd.invoices=[];await addDoc(collection(app.db, 'artifacts', app.appId, 'users', app.userId, 'clients'), cd);} closeClientModal();}catch(err){console.error(err);}}
    function openClientModal(c=null) { app.selectedClientId = c?c.id:null; const f = document.getElementById('client-form'); f.reset(); document.getElementById('client-modal-title').textContent = c?'Editar Cliente':'A√±adir Cliente'; if(c){f.elements.name.value=c.name;f.elements.phone.value=c.phone||'';f.elements.credit.value=fromCents(c.credit);f.elements.notes.value=c.notes||''; f.elements.status.value = c.status || 'activo'; f.elements.tags.value = Array.isArray(c.tags) ? c.tags.join(', ') : ''; f.elements.payment_link.value = c.payment_link || '';} app.ui.clientModal.classList.remove('hidden'); app.ui.clientModal.classList.add('flex');}
    function closeClientModal() { app.ui.clientModal.classList.add('hidden'); app.ui.clientModal.classList.remove('flex');}

    function setupServiceModal() { app.ui.serviceModal = document.getElementById('service-modal'); app.ui.serviceModal.querySelector('.modal-backdrop').addEventListener('click', closeServiceModal); document.getElementById('service-modal-cancel-btn').addEventListener('click', closeServiceModal); document.getElementById('service-form').addEventListener('submit', handleServiceFormSubmit); }
    async function handleServiceFormSubmit(e) {
        e.preventDefault();
        const submitter = document.querySelector('#service-modal button[type="submit"]');
        setLoading(submitter, true);
        try {
            const client = app.clients.find(cl => cl.id === app.selectedClientId);
            if (!client) throw new Error("Cliente no encontrado.");
            const formData = new FormData(e.target);
            const serviceId = formData.get('serviceId');
            const price = parseFloat(formData.get('price'));
            const date = formData.get('date');
            const serviceInfo = app.services.find(s => s.id === serviceId);
            if (!serviceInfo) throw new Error("Servicio no encontrado.");
            const names = formData.getAll('profile_name[]');
            const pins = formData.getAll('profile_pin[]');
            const accs = formData.getAll('profile_account[]');
            const profilesRequested = names.map((nm, i) => ({ name: (nm || `Perfil ${i + 1}`).trim(), pin: (pins[i] || '').trim(), accountId: accs[i] || null }));
            if (!profilesRequested.length) throw new Error("Debes crear al menos 1 perfil.");

            const activeAccounts = app.masterAccounts.filter(ma => ma.serviceId === serviceId && ma.status === 'activa');
            const totalAvailableSeats = activeAccounts.reduce((sum, acc) => sum + freeSeatsForAccount(acc, serviceInfo), 0);

            if (totalAvailableSeats < profilesRequested.length) {
                throw new Error(`¬°Capacidad insuficiente!\n\nSolicitaste ${profilesRequested.length} perfiles, pero solo hay ${totalAvailableSeats} plazas libres.`);
            }
            
            const pool = activeAccounts.map(a => ({ id: a.id, free: freeSeatsForAccount(a, serviceInfo) })).filter(x => x.free > 0);
            for (const p of profilesRequested) { if (!p.accountId) { pool.sort((a, b) => a.free - b.free); const choice = pool.find(acc => acc.free > 0); if (choice) { p.accountId = choice.id; choice.free--; } } }
            if (profilesRequested.some(p => !p.accountId)) { throw new Error("No se pudieron asignar todos los perfiles a una cuenta."); }

            const clientRef = doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'clients', client.id);
            const usedAccountIds = [...new Set(profilesRequested.map(p => p.accountId))];
            const accRefs = usedAccountIds.map(id => doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'master_accounts', id));

            await runTransaction(app.db, async (tx) => {
                const clientSnap = await tx.get(clientRef);
                const clientData = clientSnap.data() || {};
                
                const accSnaps = await Promise.all(accRefs.map(r => tx.get(r)));
                const accMap = {};
                accSnaps.forEach(s => { if (!s.exists()) throw new Error("Una cuenta maestra ya no existe."); accMap[s.id] = s.data(); });
                
                const needByAcc = {};
                for (const p of profilesRequested) needByAcc[p.accountId] = (needByAcc[p.accountId] || 0) + 1;
                for (const [accId, need] of Object.entries(needByAcc)) { const acc = accMap[accId]; const limit = effectiveSeatLimit(acc, serviceInfo); const used = acc.seats_used || 0; if (used + need > limit) throw new Error(`Capacidad insuficiente en ${acc.login_email}.`); }

                const newProfilesForGroup = [];
                const newSeatsByAcc = {};

                for (const p of profilesRequested) {
                    const accId = p.accountId;
                    if (!newSeatsByAcc[accId]) newSeatsByAcc[accId] = [];
                    
                    let finalPin = p.pin;
                    if (!finalPin && (serviceInfo.pin_length || 0) > 0) finalPin = generatePin(serviceInfo.pin_length);
                    
                    const allSeatsForAcc = (Array.isArray(accMap[accId].seats) ? accMap[accId].seats : []).concat(newSeatsByAcc[accId]);
                    if (finalPin && allSeatsForAcc.some(s => s.pin === finalPin)) finalPin = generatePin(serviceInfo.pin_length || 4);

                    const seat_uid = `${client.id}-${serviceId}-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
                    
                    newSeatsByAcc[accId].push({ seat_uid, clientId: client.id, serviceId, assigned_at: new Date().toISOString(), pin: finalPin || null, profile: p.name });
                    newProfilesForGroup.push({ profile_id: seat_uid, profile_name: p.name, master_account_id: accId, login_email: accMap[accId].login_email, pin: finalPin || null, assigned_at: new Date().toISOString() });
                }

                for (const [accId, newSeats] of Object.entries(newSeatsByAcc)) {
                    const acc = accMap[accId];
                    const existingSeats = Array.isArray(acc.seats) ? acc.seats : [];
                    tx.update(doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'master_accounts', accId), {
                        seats_used: (acc.seats_used || 0) + newSeats.length,
                        seats: existingSeats.concat(newSeats)
                    });
                }

                const newServices = { ...(clientData.services || {}) };
                const serviceNode = newServices[serviceId] || { groups: [] };
                if (!Array.isArray(serviceNode.groups)) serviceNode.groups = getServiceGroups(serviceNode);
                
                serviceNode.groups.push({
                    groupId: `group-${Date.now()}`,
                    price: price,
                    date: date,
                    profiles: newProfilesForGroup
                });
                newServices[serviceId] = serviceNode;
                tx.update(clientRef, { services: newServices });
            });

            mostrarNotificacion("Perfiles asignados correctamente.");
            closeServiceModal();
        } catch (err) {
            mostrarNotificacion(err.message || "Error al asignar perfiles.", true);
        } finally {
            setLoading(submitter, false);
        }
    }
    function openServiceModal(client) {
        app.selectedClientId = client.id;
        const form = document.getElementById('service-form');
        form.reset();
        form.elements.date.valueAsDate = new Date();
        form.elements.serviceId.innerHTML = app.services.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        const svcSelect = form.elements.serviceId;
        const qtyInput  = form.elements.qty_profiles;
        function refresh() {
            const svcId   = svcSelect.value;
            const service = app.services.find(s => s.id === svcId);
            if (!service) { document.getElementById('profiles-dynamic').innerHTML = ''; return; }
            const accounts = app.masterAccounts.filter(ma => ma.serviceId === svcId);
            const n = Math.max(1, parseInt(qtyInput.value,10) || 1);
            renderProfileForms(n, accounts, service);
        }
        svcSelect.addEventListener('change', refresh);
        qtyInput.addEventListener('input', refresh);
        refresh();
        app.ui.serviceModal.classList.remove('hidden');
        app.ui.serviceModal.classList.add('flex');
    }
    function closeServiceModal() { app.ui.serviceModal.classList.add('hidden'); app.ui.serviceModal.classList.remove('flex');}

    function setupMessageModal() {
        app.ui.messageModal = document.getElementById('message-modal');
        app.ui.messageModal.querySelector('.modal-backdrop').addEventListener('click', closeMessageModal);
        document.getElementById('message-modal-cancel-btn').addEventListener('click', closeMessageModal);
        document.getElementById('message-modal-action-btn').addEventListener('click', handleGenerateInvoiceAction);
        document.getElementById('copy-message-btn').addEventListener('click', () => {
            document.getElementById('generated-message-content').select();
            document.execCommand('copy');
            mostrarNotificacion("Mensaje copiado.");
        });
    }

    function openMessageModal(config) {
        const { title, content, showOptions, showGenerateButton } = config;
        document.getElementById('message-modal-title').textContent = title;
        const optionsContainer = document.getElementById('message-modal-options');
        const resultContainer = document.getElementById('message-modal-result');
        const actionButton = document.getElementById('message-modal-action-btn');

        if (showOptions) {
            optionsContainer.innerHTML = `<label class="flex items-center"><input type="checkbox" id="inv-explicacion" class="custom-checkbox mr-2"><span class="text-sm">Incluir explicaci√≥n de cese</span></label><label class="flex items-center"><input type="checkbox" id="inv-netflix-cobro" class="custom-checkbox mr-2"><span class="text-sm">Netflix: No Pag√≥ (Cobro)</span></label><label class="flex items-center"><input type="checkbox" id="inv-netflix-recordatorio" class="custom-checkbox mr-2"><span class="text-sm">Netflix: Recordatorio (Dev.)</span></label><label class="flex items-center"><input type="checkbox" id="inv-netflix-prorrateo" class="custom-checkbox mr-2"><span class="text-sm">Netflix: Prorratear si &lt; 66%</span></label>`;
            optionsContainer.classList.remove('hidden');
        } else {
            optionsContainer.classList.add('hidden');
        }

        if (content) {
            document.getElementById('generated-message-content').value = content;
            resultContainer.classList.remove('hidden');
        } else {
            resultContainer.classList.add('hidden');
        }

        actionButton.style.display = showGenerateButton ? 'block' : 'none';
        
        app.ui.messageModal.classList.remove('hidden');
        app.ui.messageModal.classList.add('flex');
    }
    
    function closeMessageModal() {
        app.ui.messageModal.classList.add('hidden');
        app.ui.messageModal.classList.remove('flex');
    }

    function openInvoiceModal(c) {
        app.selectedClientId = c.id;
        openMessageModal({
            title: 'Generar Factura de Liquidaci√≥n',
            showOptions: true,
            showGenerateButton: true
        });
    }
    
    function setupInvoiceViewModal() {
        app.ui.invoiceViewModal = document.getElementById('invoice-view-modal');
        app.ui.invoiceViewModal.querySelector('.modal-backdrop').addEventListener('click', closeInvoiceViewModal);
        document.getElementById('invoice-view-close-btn').addEventListener('click', closeInvoiceViewModal);
    }
    function openInvoiceViewModal(invoiceContent) {
        document.getElementById('invoice-view-content').value = invoiceContent;
        app.ui.invoiceViewModal.classList.remove('hidden');
        app.ui.invoiceViewModal.classList.add('flex');
    }
    function closeInvoiceViewModal() {
        app.ui.invoiceViewModal.classList.add('hidden');
        app.ui.invoiceViewModal.classList.remove('flex');
    }
    
    function setupMasterAccountModal() { app.ui.masterAccountModal = document.getElementById('master-account-modal'); app.ui.masterAccountModal.querySelector('.modal-backdrop').addEventListener('click', closeMasterAccountModal); document.getElementById('master-account-modal-cancel-btn').addEventListener('click', closeMasterAccountModal); document.getElementById('master-account-form').addEventListener('submit', handleMasterAccountFormSubmit); }
    async function handleMasterAccountFormSubmit(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const payload = {
            serviceId: formData.get('serviceId'),
            login_email: formData.get('login_email'),
            status: formData.get('status') || 'activa',
        };
        const override = parseInt(formData.get('seat_limit_override'), 10);
        if (!isNaN(override) && override > 0) payload.seat_limit_override = override;

        const pwd = formData.get('password');
        if (pwd) payload.password = pwd;

        if (selectedMasterAccountId) {
            const accRef = doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'master_accounts', selectedMasterAccountId);
            await runTransaction(app.db, async (tx) => {
                const snap = await tx.get(accRef);
                if (!snap.exists()) throw new Error("La cuenta maestra ya no existe.");
                const prev = snap.data();
                payload.seats = Array.isArray(prev.seats) ? prev.seats : [];
                payload.seats_used = prev.seats_used || 0;
                const svc = app.services.find(s => s.id === payload.serviceId);
                const effLimit = effectiveSeatLimit(payload, svc);
                if (effLimit < payload.seats_used) {
                    throw new Error(`No puedes reducir plazas a ${effLimit} si ya hay ${payload.seats_used} ocupadas.`);
                }
                tx.update(accRef, payload);
            });
            mostrarNotificacion("Cuenta maestra actualizada.");
        } else {
            payload.seats = [];
            payload.seats_used = 0;
            payload.created_at = new Date().toISOString();
            await addDoc(collection(app.db, 'artifacts', app.appId, 'users', app.userId, 'master_accounts'), payload);
            mostrarNotificacion("Cuenta maestra a√±adida.");
        }
        closeMasterAccountModal();
    }
    function openMasterAccountModal(account = null) {
        const form = document.getElementById('master-account-form');
        form.reset();
        form.elements.serviceId.innerHTML = app.services.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

        if (account) {
            selectedMasterAccountId = account.id;
            document.getElementById('master-account-modal-title').textContent = "Editar Cuenta Maestra";
            form.elements.serviceId.value = account.serviceId || '';
            form.elements.login_email.value = account.login_email || '';
            form.elements.password.value = account.password || ''; // SHOW PASSWORD
            form.elements.status.value = account.status || 'activa';
            form.elements.seat_limit_override.value = account.seat_limit_override || '';
        } else {
            selectedMasterAccountId = null;
            document.getElementById('master-account-modal-title').textContent = "A√±adir Cuenta Maestra";
        }
        
        const passwordInput = form.elements.password;
        const toggleBtn = passwordInput.nextElementSibling;
        passwordInput.type = 'password';
        toggleBtn.querySelector('.eye-open').classList.remove('hidden');
        toggleBtn.querySelector('.eye-closed').classList.add('hidden');

        app.ui.masterAccountModal.classList.remove('hidden');
        app.ui.masterAccountModal.classList.add('flex');
    }
    function closeMasterAccountModal() { app.ui.masterAccountModal.classList.add('hidden'); app.ui.masterAccountModal.classList.remove('flex');}

    function setupPaymentModal() {
        app.ui.paymentModal = document.getElementById('payment-modal');
        app.ui.paymentModal.querySelector('.modal-backdrop').addEventListener('click', closePaymentModal);
        document.getElementById('payment-modal-cancel-btn').addEventListener('click', closePaymentModal);
        document.getElementById('payment-form').addEventListener('submit', handlePaymentFormSubmit);
    }
    function openPaymentModal() {
        document.getElementById('payment-form').reset();
        app.ui.paymentModal.classList.remove('hidden');
        app.ui.paymentModal.classList.add('flex');
    }
    function closePaymentModal() {
        app.ui.paymentModal.classList.add('hidden');
        app.ui.paymentModal.classList.remove('flex');
    }
    async function handlePaymentFormSubmit(e) {
        e.preventDefault();
        const client = app.clients.find(c => c.id === app.selectedClientId);
        if (!client) return;
        const form = e.target;
        try {
            await addPaymentAndAllocate(client.id, {
                amount_cents: toCents(form.elements.amount.value),
                method: form.elements.method.value,
                reference: form.elements.reference.value || '',
                received_at: Timestamp.now(),
                applies_to: 'auto'
            });
            mostrarNotificacion("Pago registrado y aplicado.");
            closePaymentModal();
        } catch (err) {
            mostrarNotificacion(err.message || 'Error al registrar el pago', true);
        }
    }

    // --- L√ìGICA DE FACTURACI√ìN Y NOTIFICACIONES ---
    function handleNotifyBalance(client) {
        const balance = fromCents(client.pending_ar_cents);
        let message = `¬°Hola ${client.name}! üòÉ\n\nTe escribimos para recordarte que tienes un saldo pendiente de $${balance} con StreamService.`;
        
        if (app.paymentMethods.length > 0) {
            message += `\n\nPuedes realizar tu pago a trav√©s de:\n`;
            app.paymentMethods.forEach(pm => {
                message += `‚Ä¢ ${pm.name}: ${pm.details}\n`;
            });
        } else if (client.payment_link) {
            message += `\n\nPuedes realizar tu pago c√≥modamente a trav√©s del siguiente enlace:\n${client.payment_link}`;
        }

        message += `\n\nSi ya realizaste el pago, por favor ignora este mensaje. ¬°Gracias!`;
        
        openMessageModal({
            title: 'Notificar Saldo Pendiente',
            content: message,
            showOptions: false,
            showGenerateButton: false,
        });

        const whatsappBtn = document.getElementById('whatsapp-message-btn');
        if (client.phone) {
            whatsappBtn.href = `https://wa.me/${client.phone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
            whatsappBtn.classList.remove('hidden');
        } else {
            whatsappBtn.classList.add('hidden');
        }
    }

    async function handleGenerateInvoiceAction() {
        const client = app.clients.find(c => c.id === app.selectedClientId);
        if (!client) return;
        const options = {
            explicacion: document.getElementById('inv-explicacion').checked,
            cobro: document.getElementById('inv-netflix-cobro').checked,
            recordatorio: document.getElementById('inv-netflix-recordatorio').checked,
            prorrateo: document.getElementById('inv-netflix-prorrateo').checked
        };
        
        const { invoiceObject, message } = generateCombinedInvoice(client, options);
        await addInvoice(client.id, invoiceObject);

        document.getElementById('message-modal-result').classList.remove('hidden');
        document.getElementById('generated-message-content').value = message;
        const whatsappBtn = document.getElementById('whatsapp-message-btn');
        if (client.phone) {
            whatsappBtn.href = `https://wa.me/${client.phone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
            whatsappBtn.classList.remove('hidden');
        } else {
            whatsappBtn.classList.add('hidden');
        }
        
        mostrarNotificacion("Factura generada y guardada.");
    }

    function generateCombinedInvoice(client, options) {
        let message = `**Este es un mensaje generado autom√°ticamente por el sistema de notificaciones de StreamService.**\n\nEstimado/a ${client.name},\n\n`;
        if (options.explicacion) {
            message += `Como es de su conocimiento, el pasado 17 de agosto Netflix realiz√≥ cambios que nos impidieron continuar ofreciendo el servicio, oblig√°ndonos a cesar las operaciones. Le agradecemos sinceramente por haber sido parte de StreamService.\n\n`;
        }
        let totalGeneralCents = 0;
        const bloques = [];
        const invoiceItems = [];
        const clientServices = client.services || {};

        for (const serviceId in clientServices) {
            const serviceData = clientServices[serviceId];
            const serviceInfo = app.services.find(s => s.id === serviceId);
            if (!serviceInfo) continue;
            
            const groups = getServiceGroups(serviceData);
            
            groups.forEach(group => {
                const groupData = { price: group.price, date: group.date, profiles: group.profiles };

                let result;
                if (serviceInfo.isNetflix) {
                    result = processNetflixLogic(groupData, options);
                } else {
                    result = processOtherServiceLogic(serviceInfo, groupData);
                }
                
                if(result.bloqueStr) bloques.push(result.bloqueStr);
                totalGeneralCents += result.deuda;
                if(result.deuda > 0) {
                    invoiceItems.push({
                        serviceId: serviceId,
                        groupId: group.groupId,
                        qty: group.profiles.length,
                        unit_price_cents: toCents(group.price),
                        description: `${serviceInfo.name} - ${group.profiles.length} perfiles`
                    });
                }
            });
        }

        message += bloques.join('');
        message += `--- RESUMEN FINAL DE FACTURACI√ìN ---\n`;
        message += `Subtotal Servicios: $${fromCents(totalGeneralCents)}\n`;
        
        let totalAPagarCents = totalGeneralCents;
        if (client.credit && client.credit > 0) {
            totalAPagarCents = Math.max(0, totalGeneralCents - client.credit);
            message += `Cr√©dito Previo Aplicado: -$${fromCents(client.credit)}\n`;
        }
        message += `--------------------------------\n`;
        message += `**Total a Pagar: $${fromCents(totalAPagarCents)}**\n`;
        message += `--------------------------------\n\n`;
        
        if (app.paymentMethods.length > 0) {
            message += `Puedes realizar tu pago a trav√©s de:\n`;
            app.paymentMethods.forEach(pm => {
                message += `‚Ä¢ ${pm.name}: ${pm.details}\n`;
            });
            message += `\n`;
        } else if (client.payment_link) {
            message += `Puedes realizar tu pago c√≥modamente a trav√©s del siguiente enlace:\n${client.payment_link}\n\n`;
        }

        message += `Quedamos atentos para coordinar el pago o la devoluci√≥n, seg√∫n corresponda. ¬°Gracias!`;
        
        const dueDate = new Date();
        dueDate.setDate(dueDate.getDate() + 7);

        const invoiceObject = {
            amount_cents: totalAPagarCents,
            due_date: Timestamp.fromDate(dueDate),
            issued_at: Timestamp.now(),
            status: 'pendiente',
            items: invoiceItems,
            payments_total_cents: 0,
            content: message,
            payment_link: client.payment_link || null
        };

        return { invoiceObject, message };
    }

    function processNetflixLogic(serviceData, options){
      const FECHA_BLOQUEO = new Date('2025-08-17T00:00:00');
      const precio = serviceData.price || 0;
      const profiles = Array.isArray(serviceData.profiles)? serviceData.profiles : [];
      const k = profiles.length;
      const fechaCiclo = new Date(serviceData.date+'T00:00:00');
      if(!precio || !k || isNaN(fechaCiclo)) return { bloqueStr:'', deuda:0 };

      const cicloFin = new Date(fechaCiclo); cicloFin.setMonth(cicloFin.getMonth()+1);
      const periodoInicio = fechaCiclo;
      const periodoFin = cicloFin < FECHA_BLOQUEO ? cicloFin : FECHA_BLOQUEO;

      let diasTot = Math.max(1, Math.round((cicloFin - fechaCiclo)/86400000));
      let diasUsados = Math.max(0, Math.round((periodoFin - periodoInicio)/86400000));
      diasUsados = Math.min(diasUsados, diasTot);

      let subtotal = toCents(precio * k); // mes completo
      if(options.prorrateo && diasUsados/diasTot < 0.66){
        subtotal = Math.round(subtotal * (diasUsados/diasTot));
      }

      let bloqueStr = `--- Resumen: Netflix ---\n`;
      if(options.cobro){
        bloqueStr += `‚ñ™Ô∏è Ciclo ${formatDate(fechaCiclo)} a ${formatDate(cicloFin)} (${diasUsados}/${diasTot} d√≠as) ‚Äî $${precio.toFixed(2)} x ${k} perfiles`;
        if(options.prorrateo && diasUsados/diasTot < 0.66){ bloqueStr += ` (prorrateado)`; }
        bloqueStr += ` = $${fromCents(subtotal)}\n`;
      }
      if(options.recordatorio){
        bloqueStr += `‚ñ™Ô∏è Recordatorio/Devoluci√≥n pendiente.\n`;
      }
      bloqueStr += `Subtotal: $${fromCents(subtotal)}\n--------------------------------\n\n`;
      return { bloqueStr, deuda: subtotal };
    }

    function processOtherServiceLogic(serviceInfo, serviceData) {
        const FECHA_ACTUAL = new Date();
        const precio = serviceData.price || 0;
        const fechaCicloStr = serviceData.date;
        const profiles = Array.isArray(serviceData.profiles) ? serviceData.profiles : [];
        const perfilesCount = profiles.length;

        if (!precio || !fechaCicloStr || perfilesCount === 0) return { bloqueStr: '', subtotal: 0 };

        let fechaCicloActual = new Date(fechaCicloStr + 'T00:00:00');
        if (isNaN(fechaCicloActual.getTime()) || fechaCicloActual > FECHA_ACTUAL) return { bloqueStr: '', subtotal: 0 };
        
        let mesesFacturados = 0, detalleStr = "", subtotal = 0;
        while (fechaCicloActual < FECHA_ACTUAL) {
            let proximoCiclo = new Date(fechaCicloActual);
            proximoCiclo.setMonth(proximoCiclo.getMonth() + 1);
            const mesTotal = toCents(precio * perfilesCount);
            subtotal += mesTotal;
            detalleStr += `‚ñ™Ô∏è Per√≠odo (${formatDate(fechaCicloActual)} a ${formatDate(proximoCiclo)}): $${precio.toFixed(2)} x ${perfilesCount} perfiles = $${fromCents(mesTotal)}\n`;
            mesesFacturados++;
            fechaCicloActual.setMonth(fechaCicloActual.getMonth() + 1);
        }

        if (mesesFacturados > 0) {
            let bloqueStr = `--- Resumen: ${serviceInfo.name} (Inicio ${formatDate(new Date(fechaCicloStr + 'T00:00:00'))}) ---\n`;
            bloqueStr += detalleStr;
            bloqueStr += `Subtotal: $${fromCents(subtotal)}\n`;
            bloqueStr += `--------------------------------\n\n`;
            return { bloqueStr, deuda: subtotal };
        }
        return { bloqueStr: '', deuda: 0 };
    }
    
    // --- VISTA: DASHBOARD DE SERVICIOS ---
    function renderServicesDashboardView(container) {
        container.innerHTML = `<div class="flex justify-between items-center mb-6"> <h2 class="text-3xl font-bold">Vista de Servicios</h2> </div> <div id="services-dashboard-content" class="space-y-8"></div>`;
        const content = document.getElementById('services-dashboard-content');

        // 1. Build aggregated data structure
        const servicesViewData = {};
        app.services.forEach(svc => {
            servicesViewData[svc.id] = {
                serviceName: svc.name,
                accounts: {}
            };
        });

        app.masterAccounts.forEach(acc => {
            if (servicesViewData[acc.serviceId]) {
                const service = app.services.find(s => s.id === acc.serviceId);
                servicesViewData[acc.serviceId].accounts[acc.id] = {
                    accountEmail: acc.login_email,
                    limit: effectiveSeatLimit(acc, service),
                    used: acc.seats_used || 0,
                    clients: [] 
                };
            }
        });

        app.clients.forEach(client => {
            if (!client.services) return;
            Object.entries(client.services).forEach(([serviceId, serviceData]) => {
                const groups = getServiceGroups(serviceData);
                groups.forEach(group => {
                    (group.profiles || []).forEach(profile => {
                        const accId = profile.master_account_id;
                        if (servicesViewData[serviceId] && servicesViewData[serviceId].accounts[accId]) {
                            servicesViewData[serviceId].accounts[accId].clients.push({
                                clientId: client.id,
                                clientName: client.name,
                                profileName: profile.profile_name,
                                pin: profile.pin || 'N/A'
                            });
                        }
                    });
                });
            });
        });

        // 2. Render HTML from aggregated data
        let html = '';
        Object.values(servicesViewData).filter(s => Object.keys(s.accounts).length > 0).forEach(s => {
            html += `<div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700">
                <div class="p-4 border-b border-slate-200 dark:border-slate-700"><h3 class="text-xl font-semibold">${s.serviceName}</h3></div>
                <div class="p-4 space-y-4">
            `;
            Object.values(s.accounts).forEach(acc => {
                const pct = acc.limit ? Math.min(100, Math.round((acc.used / acc.limit) * 100)) : 0;
                const color = pct > 80 ? 'bg-red-500' : (pct > 50 ? 'bg-yellow-500' : 'bg-green-500');
                
                html += `<div class="p-4 rounded-md bg-slate-50 dark:bg-slate-900/40 border border-slate-200 dark:border-slate-700">
                    <div class="flex justify-between items-center mb-3">
                        <p class="font-semibold text-lg">${acc.accountEmail}</p>
                        <p class="font-mono text-sm">${acc.used} / ${acc.limit} plazas</p>
                    </div>
                    <div class="w-full h-2 bg-slate-300 dark:bg-slate-600 rounded-full mb-4">
                        <div class="${color} h-2 rounded-full" style="width:${pct}%"></div>
                    </div>
                    <div class="max-h-60 overflow-y-auto pr-2">
                        ${acc.clients.length > 0 ? acc.clients.map(c => `
                            <div class="flex justify-between items-center p-2 border-b border-slate-200 dark:border-slate-700">
                                <div>
                                    <a href="#" data-role="go-to-client" data-client-id="${c.clientId}" class="font-medium text-blue-600 dark:text-blue-400 hover:underline">${c.clientName}</a>
                                    <p class="text-xs text-slate-500">${c.profileName} (PIN: ${c.pin})</p>
                                </div>
                            </div>
                        `).join('') : '<p class="text-center text-sm text-slate-500 py-4">Sin perfiles asignados</p>'}
                    </div>
                </div>`;
            });
            html += `</div></div>`;
        });
        content.innerHTML = html || '<p class="text-center text-slate-500">No hay servicios con cuentas maestras para mostrar.</p>';
    }

    // --- UTILIDADES ---
    function toCents(v){ return Math.round(Number(v||0)*100); }
    function fromCents(c){ return (Number(c||0)/100).toFixed(2); }
    function daysPastDue(ts){
        if(!ts) return 0;
        const d = ts.toDate ? ts.toDate() : new Date(ts);
        const today = new Date(); today.setHours(0,0,0,0);
        const diff = (today - d) / (1000*60*60*24);
        return Math.floor(diff);
    }
    function agingBuckets(pendingInvoices){
        const b = { '0-7':0, '8-30':0, '31-60':0, '60+':0 };
        pendingInvoices.forEach(inv=>{
            const days = daysPastDue(inv.due_date);
            const due = inv.amount_cents - (inv.payments_total_cents||0);
            if(days<=7) b['0-7'] += due;
            else if(days<=30) b['8-30'] += due;
            else if(days<=60) b['31-60'] += due;
            else b['60+'] += due;
        });
        return b;
    }

    function getServiceGroups(serviceData) {
        if (!serviceData) return [];
        if (Array.isArray(serviceData.groups) && serviceData.groups.length > 0) {
            return serviceData.groups; 
        }
        if (Array.isArray(serviceData.profiles) && serviceData.profiles.length > 0) {
            return [{
                groupId: 'legacy-group',
                price: serviceData.price || 0,
                date: serviceData.date || null,
                profiles: serviceData.profiles
            }];
        }
        return [];
    }

    function setLoading(button, isLoading, originalText = 'Guardar') {
        if (isLoading) {
            button.disabled = true;
            button.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Procesando...`;
        } else {
            button.disabled = false;
            button.innerHTML = originalText;
        }
    }

    function generatePin(length = 0) {
        if (!length || length <= 0) return "";
        let s = "";
        for (let i = 0; i < length; i++) s += Math.floor(Math.random() * 10);
        return s;
    }

    function rankMasterAccounts(accounts, service) {
        return accounts
            .filter(a => a.status === 'activa' && freeSeatsForAccount(a, service) > 0)
            .sort((a, b) => {
                const freeA = freeSeatsForAccount(a, service);
                const freeB = freeSeatsForAccount(b, service);
                if (freeA !== freeB) return freeA - freeB; 
                const occA = a.seats_used || 0, occB = b.seats_used || 0;
                if (occA !== occB) return occB - occA; 
                return (a.created_at || 0) - (b.created_at || 0);
            });
    }
    
    function freeSeatsForAccount(acc, service) {
        const limit = effectiveSeatLimit(acc, service);
        const used  = acc.seats_used || 0;
        return Math.max(0, limit - used);
    }

    function distributeProfiles(accounts, service, count) {
        const dist = {}; 
        if (count <= 0) return dist;
        const pool = accounts.map(a => ({ id:a.id, free: freeSeatsForAccount(a, service), acc:a }))
                            .filter(x => x.free > 0);
        if (pool.length === 0) return dist;
        for (let i=0; i<count; i++) {
            pool.sort((x,y)=> y.free - x.free);
            if (!pool[0] || pool[0].free <= 0) break;
            dist[pool[0].id] = (dist[pool[0].id] || 0) + 1;
            pool[0].free -= 1;
        }
        return dist;
    }

    function renderAccountsAvailability(container, accounts, service) {
        container.innerHTML = accounts.map(a => {
            const free = freeSeatsForAccount(a, service);
            const limit = effectiveSeatLimit(a, service);
            const pct   = limit? Math.round(((limit - free)/limit)*100) : 0;
            const bar = pct>80?'bg-red-500':pct>50?'bg-yellow-500':'bg-green-500';
            return `<div class="flex items-center justify-between p-2 rounded border border-slate-200 dark:border-slate-700 mb-2"><div class="min-w-0"><p class="text-sm font-medium truncate">${a.login_email}</p><div class="flex items-center gap-2 mt-1"><div class="w-28 h-2 bg-slate-300 dark:bg-slate-600 rounded-full"><div class="${bar} h-2 rounded-full" style="width:${pct}%"></div></div><p class="text-xs text-slate-500">${limit - free} / ${limit} usadas ¬∑ libres: ${free}</p></div></div>${free<=1?`<span class="text-xs text-red-600">‚ö†Ô∏é al l√≠mite</span>`:''}</div>`;
        }).join('');
    }

    function renderProfileForms(n, accounts, service) {
        const container = document.getElementById('profiles-dynamic');
        const ranked = rankMasterAccounts(accounts, service);
        const dist   = distributeProfiles(accounts, service, n);
        const optionsHTML = ranked.map(a => `<option value="${a.id}">${a.login_email} ‚Äî libres: ${freeSeatsForAccount(a, service)}</option>`).join('');
        container.innerHTML = '';
        let cursor = [];
        Object.entries(dist).forEach(([accId, k]) => { for (let i=0;i<k;i++) cursor.push(accId); });
        while (cursor.length < n) cursor.push('');
        for (let i=0;i<n;i++) {
            const suggested = cursor[i] || '';
            const suggestedPin = (service.pin_length > 0) ? generatePin(service.pin_length) : '';
            container.insertAdjacentHTML('beforeend', `<div class="p-3 rounded-md bg-slate-100 dark:bg-slate-700/40"><div class="grid grid-cols-1 md:grid-cols-4 gap-3"><div class="md:col-span-2"><label class="block text-xs mb-1">Nombre del perfil</label><input type="text" name="profile_name[]" placeholder="Perfil ${i+1}" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"></div><div><label class="block text-xs mb-1">PIN (Sugerido)</label><input type="text" name="profile_pin[]" value="${suggestedPin}" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent" maxlength="10"></div><div><label class="block text-xs mb-1">Cuenta maestra</label><select name="profile_account[]" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent"><option value="">(Autom√°tico)</option>${optionsHTML}</select></div></div></div>`);
            const selects = container.querySelectorAll('select[name="profile_account[]"]');
            const sel = selects[selects.length-1];
            if (suggested) sel.value = suggested;
        }
        const availBox = document.getElementById('accounts-availability');
        const suggBox  = document.getElementById('master-account-suggestion');
        renderAccountsAvailability(availBox, ranked, service);
        suggBox.classList.toggle('hidden', ranked.length===0);
    }

    async function handleRemoveClientProfile(serviceId, groupId, profileId) {
        const client = app.clients.find(cl => cl.id === app.selectedClientId);
        if (!client) return;

        const svcData = (client.services||{})[serviceId];
        const groups = getServiceGroups(svcData);
        const group = groups.find(g => g.groupId === groupId);
        const profile = group?.profiles.find(p => p.profile_id === profileId);
        if (!profile) return;
        
        const accRef = doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'master_accounts', profile.master_account_id);
        const clientRef = doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'clients', client.id);

        await runTransaction(app.db, async (tx) => {
            const [accSnap, clientSnap] = await Promise.all([tx.get(accRef), tx.get(clientRef)]);
            if (accSnap.exists()) {
                 const acc = accSnap.data();
                 tx.update(accRef, { 
                     seats_used: Math.max(0, (acc.seats_used || 0) - 1), 
                     seats: (acc.seats || []).filter(s => s.seat_uid !== profileId) 
                });
            }
            const cd = clientSnap.data() || {};
            const serviceNode = { ...(cd.services?.[serviceId] || {}) };
            const currentGroups = getServiceGroups(serviceNode);

            const updatedGroups = currentGroups.map(g => {
                if (g.groupId === groupId) {
                    g.profiles = g.profiles.filter(p => p.profile_id !== profileId);
                }
                return g;
            }).filter(g => g.profiles.length > 0); 

            const newServices = { ...(cd.services || {}) };
            if(updatedGroups.length === 0) {
                delete newServices[serviceId];
            } else {
                serviceNode.groups = updatedGroups;
                newServices[serviceId] = serviceNode;
            }
            tx.update(clientRef, { services: newServices });
        });
        mostrarNotificacion("Perfil eliminado.");
    }

    async function handleRemoveServiceById(serviceIdToRemove) {
        const client = app.clients.find(cl => cl.id === app.selectedClientId);
        const serviceInfo = app.services.find(s => s.id === serviceIdToRemove);
        if (!client || !serviceInfo) return;
        
        const serviceData = (client.services || {})[serviceIdToRemove];
        const allProfilesToRemove = getServiceGroups(serviceData).flatMap(g => g.profiles || []);

        if (allProfilesToRemove.length === 0) {
            const updatedServices = { ...(client.services || {}) };
            delete updatedServices[serviceIdToRemove];
            await updateDoc(doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'clients', client.id), { services: updatedServices });
            mostrarNotificacion("Servicio (sin perfiles) eliminado.");
            return;
        }
        
        const profilesByAcc = {};
        allProfilesToRemove.forEach(p => {
            if (p.master_account_id) {
                if (!profilesByAcc[p.master_account_id]) profilesByAcc[p.master_account_id] = [];
                profilesByAcc[p.master_account_id].push(p.profile_id);
            }
        });

        const clientRef = doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'clients', client.id);
        const accRefs = Object.keys(profilesByAcc).map(id => doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'master_accounts', id));

        await runTransaction(app.db, async (tx) => {
            const accSnaps = await Promise.all(accRefs.map(r => tx.get(r)));
            const clientSnap = await tx.get(clientRef);

            for (const snap of accSnaps) {
                if (!snap.exists()) continue;
                const acc = snap.data();
                const profileIdsToRemove = profilesByAcc[snap.id];
                tx.update(snap.ref, {
                    seats_used: Math.max(0, (acc.seats_used || 0) - profileIdsToRemove.length),
                    seats: (acc.seats || []).filter(s => !profileIdsToRemove.includes(s.seat_uid))
                });
            }
            
            const clientData = clientSnap.data();
            const updatedServices = { ...(clientData.services || {}) };
            delete updatedServices[serviceIdToRemove];
            tx.update(clientRef, { services: updatedServices });
        });

        mostrarNotificacion("Servicio y todos sus perfiles han sido eliminados.");
    }

    async function handleDeleteServiceType(serviceDocId) {
        const inUse = app.clients.some(c => c.services && c.services[serviceDocId]);
        if (inUse) { return mostrarNotificacion("No puedes eliminar: hay clientes usando este servicio.", true); }
        await deleteDoc(doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'services', serviceDocId));
        mostrarNotificacion("Servicio eliminado del cat√°logo.");
    }
    async function handleDeleteMasterAccount(masterAccId) {
        const acc = app.masterAccounts.find(a => a.id === masterAccId);
        if (acc && (acc.seats_used || 0) > 0) {
            return mostrarNotificacion(`No se puede eliminar: La cuenta ${acc.login_email} tiene perfiles asignados.`, true);
        }
        await deleteDoc(doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'master_accounts', masterAccId));
        mostrarNotificacion("Cuenta maestra eliminada.");
    }
    async function handleDeletePaymentMethod(methodId) {
        await deleteDoc(doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'payment_methods', methodId));
        mostrarNotificacion("M√©todo de pago eliminado.");
    }
    function effectiveSeatLimit(account, service) {
        return account?.seat_limit_override > 0 ? account.seat_limit_override : (service?.seat_limit || 0);
    }
    function formatDate(date) {
        if (!date || isNaN(date.getTime())) return 'N/A';
        const d = date.getDate().toString().padStart(2, '0');
        const m = (date.getMonth() + 1).toString().padStart(2, '0');
        const y = date.getFullYear();
        return `${d}/${m}/${y}`;
    }
    function setupSidebar() {
        const s = document.getElementById('sidebar');
        const t = document.getElementById('sidebar-toggle');
        if (localStorage.getItem('sidebarCollapsed') === 'true') s.classList.add('collapsed');
        t.addEventListener('click', () => { s.classList.toggle('collapsed'); localStorage.setItem('sidebarCollapsed', s.classList.contains('collapsed')); });
    }

    function setupDarkMode() {
        const t = document.getElementById('dark-mode-toggle');
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            t.checked = true;
        }
        t.addEventListener('change', () => { document.documentElement.classList.toggle('dark'); localStorage.theme = t.checked ? 'dark' : 'light'; });
    }
    function mostrarNotificacion(m, e = false) {
        const c = document.getElementById('notificacion');
        const b = e ? 'bg-red-500' : 'bg-green-600';
        const el = document.createElement('div');
        el.className = `${b} text-white px-4 py-2 rounded-lg shadow-lg flex items-start text-sm animate-pulse max-w-sm`;
        el.innerHTML = `<span class="mt-1">${e ? '‚ùå' : '‚úÖ'}</span><span class="ml-2 whitespace-pre-wrap">${m}</span>`;
        c.appendChild(el);
        setTimeout(() => {
            el.classList.remove('animate-pulse');
            setTimeout(() => el.remove(), 5000);
        }, 500);
    }
    
    function invoicesColRef(clientId) { return collection(app.db, 'artifacts', app.appId, 'users', app.userId, 'clients', clientId, 'invoices'); }
    async function addInvoice(clientId, invoice) {
        const clientRef = doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'clients', clientId);
        const newInvoiceRef = doc(invoicesColRef(clientId));

        await runTransaction(app.db, async (tx) => {
            const clientSnap = await tx.get(clientRef);
            if (!clientSnap.exists()) {
                throw new Error("Cliente no encontrado.");
            }
            const clientData = clientSnap.data();
            const currentAR = clientData.pending_ar_cents || 0;
            const newAR = currentAR + invoice.amount_cents;

            tx.set(newInvoiceRef, invoice);
            tx.update(clientRef, { pending_ar_cents: newAR });
        });
    }
    async function listInvoices(clientId, max=50) {
        const qRef = query(invoicesColRef(clientId), orderBy('issued_at','desc'), limit(max));
        const snap = await getDocs(qRef);
        return snap.docs.map(d => ({ id:d.id, ...d.data() }));
    }
    async function computeAccountsReceivable() {
        let total = 0;
        for (const c of app.clients) {
           total += c.pending_ar_cents || 0;
        }
        return fromCents(total);
    }
    function computeCreditToReturn() { return fromCents(app.clients.reduce((total, client) => total + (client.credit || 0), 0)); }
    function countUpcomingRenewals(days=7){
        const today = new Date(); today.setHours(0,0,0,0);
        const horizon = new Date(today); horizon.setDate(horizon.getDate()+days);
        let count = 0;
        for (const c of app.clients) {
            if(!c.services) continue;
            for (const s_data of Object.values(c.services)) {
                let upcoming = false;
                const groups = getServiceGroups(s_data);
                for(const g of groups) {
                    if(!g.date) continue;
                    let next = new Date(g.date+'T00:00:00');
                    while (next < today) next.setMonth(next.getMonth()+1);
                    if (next <= horizon) { upcoming = true; break; }
                }
                if(upcoming) { count++; break; }
            }
        }
        return count;
    }

    async function addPaymentAndAllocate(clientId, payload) {
        const clientRef = doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'clients', clientId);
        const paysCol = collection(app.db, 'artifacts', app.appId, 'users', app.userId, 'clients', clientId, 'payments');
        const invCol = (cid) => collection(app.db, 'artifacts', app.appId, 'users', app.userId, 'clients', cid, 'invoices');

        await runTransaction(app.db, async (tx) => {
            const clientSnap = await tx.get(clientRef);
            if (!clientSnap.exists()) throw new Error("Cliente no existe.");

            const q = query(invCol(clientId), where('status', 'in', ['pendiente', 'parcial']));
            const pendingInvoicesSnap = await getDocs(q); 

            const invoiceRefs = pendingInvoicesSnap.docs.map(d => d.ref);
            const invoiceSnaps = await Promise.all(invoiceRefs.map(ref => tx.get(ref)));
            const sortedInvoices = invoiceSnaps
                .map(snap => ({ id: snap.id, ref: snap.ref, ...snap.data() }))
                .sort((a, b) => (a.due_date?.toMillis() || 0) - (b.due_date?.toMillis() || 0));

            let remaining = payload.amount_cents;
            const payRef = doc(paysCol);
            tx.set(payRef, { ...payload, created_at: Timestamp.now() });

            let pendingTotalCentsAfterPayment = 0;
            
            const allInvoicesQuery = query(invCol(clientId));
            const allInvoicesDocs = (await getDocs(allInvoicesQuery)).docs;
            const otherInvoices = allInvoicesDocs
                .filter(doc => !sortedInvoices.find(inv => inv.id === doc.id))
                .map(doc => doc.data());

            for (const inv of otherInvoices) {
                 if (inv.status !== 'pagado') {
                     pendingTotalCentsAfterPayment += (inv.amount_cents || 0) - (inv.payments_total_cents || 0);
                 }
            }

            for (const inv of sortedInvoices) {
                if (remaining <= 0) {
                    pendingTotalCentsAfterPayment += (inv.amount_cents || 0) - (inv.payments_total_cents || 0);
                    continue;
                }

                const paid = inv.payments_total_cents || 0;
                const due = (inv.amount_cents || 0) - paid;
                const applied = Math.min(due, remaining);
                const newPaid = paid + applied;
                const newStatus = newPaid >= (inv.amount_cents || 0) ? 'pagado' : 'parcial';
                
                tx.update(inv.ref, {
                    payments_total_cents: newPaid,
                    status: newStatus,
                    last_payment_id: payRef.id
                });
                remaining -= applied;

                if (newStatus !== 'pagado') {
                    pendingTotalCentsAfterPayment += (inv.amount_cents || 0) - newPaid;
                }
            }
            
            const currentCredit = clientSnap.data().credit || 0;
            tx.update(clientRef, { 
                pending_ar_cents: pendingTotalCentsAfterPayment,
                credit: currentCredit + remaining
            });
        });
    }
    
    async function renderClientStatement(container, client){
        container.id = 'client-statement-container';
        const invSnap = await getDocs(query(invoicesColRef(client.id), orderBy('issued_at','asc')));
        const invoices = invSnap.docs.map(d=>({ id:d.id, type:'invoice', ...d.data() }));
        
        const paysCol = collection(app.db,'artifacts',app.appId,'users',app.userId,'clients',client.id,'payments');
        const paySnap = await getDocs(query(paysCol, orderBy('received_at','asc')));
        const payments = paySnap.docs.map(d=>({ id:d.id, type: 'payment', ...d.data() }));

        const rows = [...invoices, ...payments].sort((a,b)=> (a.issued_at || a.received_at).toMillis() - (b.issued_at || b.received_at).toMillis());

        let runningBalance = 0;
        const htmlRows = rows.map(r=>{
            let debit = 0, credit = 0;
            let date = new Date();
            let desc = '';
            let rowId = '';
            let rowType = '';

            if (r.type === 'invoice') {
                debit = r.amount_cents;
                date = r.issued_at?.toDate();
                desc = `Factura #${r.id.substring(0,5)}`;
                rowId = r.id;
                rowType = 'invoice';
            } else if (r.type === 'payment') {
                credit = r.amount_cents;
                date = r.received_at?.toDate();
                desc = `Pago (${r.method}) ${r.reference||''}`;
                rowId = r.id;
                rowType = 'payment';
            }
            
            runningBalance += (debit - credit);

            return `<tr>
              <td class="p-2 text-sm">${formatDate(date)}</td>
              <td class="p-2 text-sm">${desc}</td>
              <td class="p-2 text-sm text-right">$${fromCents(debit)}</td>
              <td class="p-2 text-sm text-right text-green-600 dark:text-green-400">-$${fromCents(credit)}</td>
              <td class="p-2 text-sm text-right font-mono">$${fromCents(runningBalance)}</td>
               <td class="p-2 text-right">
                ${rowType === 'payment' ? `<button data-role="delete-payment" data-payment-id="${rowId}" class="text-red-500 hover:text-red-700 text-xs">Eliminar</button>` : ''}
               </td>
            </tr>`;
        }).join('');

        const pending = invoices.filter(i=>['pendiente','parcial'].includes(i.status));
        const b = agingBuckets(pending);
        const totalDue = client.pending_ar_cents || 0;

        container.innerHTML = `
          <div class="bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 p-6">
            <h3 class="text-xl font-semibold mb-4">Estado de cuenta</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
              <div class="p-3 rounded bg-slate-50 dark:bg-slate-900/40"><p class="text-xs text-slate-500">Cuentas por cobrar</p><p class="text-2xl font-bold">$${fromCents(totalDue)}</p></div>
              <div class="p-3 rounded bg-slate-50 dark:bg-slate-900/40"><p class="text-xs text-slate-500">0‚Äì7 d√≠as</p><p class="text-xl">$${fromCents(b['0-7'])}</p></div>
              <div class="p-3 rounded bg-slate-50 dark:bg-slate-900/40"><p class="text-xs text-slate-500">8‚Äì30 d√≠as</p><p class="text-xl">$${fromCents(b['8-30'])}</p></div>
              <div class="p-3 rounded bg-slate-50 dark:bg-slate-900/40"><p class="text-xs text-slate-500">31+ d√≠as</p><p class="text-xl">$${fromCents(b['31-60'] + b['60+'])}</p></div>
            </div>
            <div class="overflow-x-auto border rounded-lg">
              <table class="w-full text-left">
                <thead class="bg-slate-50 dark:bg-slate-700/40">
                  <tr><th class="p-2 font-semibold">Fecha</th><th class="p-2 font-semibold">Concepto</th><th class="p-2 font-semibold text-right">D√©bito</th><th class="p-2 font-semibold text-right">Cr√©dito</th><th class="p-2 font-semibold text-right">Saldo</th><th class="p-2"></th></tr>
                </thead>
                <tbody>${htmlRows || '<tr><td class="p-4 text-center text-slate-500" colspan="6">Sin movimientos</td></tr>'}</tbody>
              </table>
            </div>
            <div class="mt-4 flex gap-2">
              <button type="button" data-role="register-payment" class="bg-emerald-600 text-white px-3 py-2 rounded-md font-medium text-sm">Registrar pago</button>
            </div>
          </div>
          `;
    }

    async function handleDeleteInvoice(invoiceId) {
        const clientId = app.selectedClientId;
        if (!clientId) return;
        const clientRef = doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'clients', clientId);
        const invoiceRef = doc(invoicesColRef(clientId), invoiceId);

        try {
            await runTransaction(app.db, async (tx) => {
                const invoiceSnap = await tx.get(invoiceRef);
                if (!invoiceSnap.exists()) return; 
                
                const invoiceData = invoiceSnap.data();
                const amountToAdjust = (invoiceData.amount_cents || 0) - (invoiceData.payments_total_cents || 0);

                const clientSnap = await tx.get(clientRef);
                const clientData = clientSnap.data();
                const currentAR = clientData.pending_ar_cents || 0;
                const newAR = Math.max(0, currentAR - amountToAdjust);

                tx.delete(invoiceRef);
                tx.update(clientRef, { pending_ar_cents: newAR });
            });
            
            mostrarNotificacion("Factura eliminada correctamente.");
        } catch (error) {
            console.error("Error al eliminar la factura:", error);
            mostrarNotificacion("No se pudo eliminar la factura.", true);
        }
    }

    async function handleDeletePayment(paymentId) {
        const clientId = app.selectedClientId;
        if (!clientId) return;

        const clientRef = doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'clients', clientId);
        const paymentToDeleteRef = doc(collection(clientRef, 'payments'), paymentId);
        
        await runTransaction(app.db, async (tx) => {
            const allInvoicesSnap = await getDocs(query(collection(clientRef, 'invoices')));
            const allPaymentsSnap = await getDocs(query(collection(clientRef, 'payments')));
            const clientSnap = await tx.get(clientRef);
            
            if (!clientSnap.exists()) throw new Error("Client not found");

            const remainingPayments = allPaymentsSnap.docs
                .filter(doc => doc.id !== paymentId)
                .map(doc => ({ id: doc.id, ...doc.data() }))
                .sort((a, b) => (a.received_at?.toMillis() || 0) - (b.received_at?.toMillis() || 0));

            let invoices = allInvoicesSnap.docs
                .map(doc => ({ id: doc.id, ref: doc.ref, ...doc.data() }))
                .sort((a, b) => (a.due_date?.toMillis() || 0) - (b.due_date?.toMillis() || 0));

            invoices.forEach(inv => {
                inv.payments_total_cents = 0;
                inv.status = 'pendiente';
            });

            let totalCreditFromPayments = 0;
            for (const payment of remainingPayments) {
                let remainingAmount = payment.amount_cents;
                for (const inv of invoices) {
                    if (remainingAmount <= 0) break;
                    const due = (inv.amount_cents || 0) - (inv.payments_total_cents || 0);
                    if (due > 0) {
                        const applied = Math.min(due, remainingAmount);
                        inv.payments_total_cents += applied;
                        remainingAmount -= applied;
                        inv.status = inv.payments_total_cents >= inv.amount_cents ? 'pagado' : 'parcial';
                    }
                }
                totalCreditFromPayments += remainingAmount;
            }
            
            let newPendingTotalCents = 0;
            invoices.forEach(inv => {
                if (inv.status !== 'pagado') {
                    newPendingTotalCents += (inv.amount_cents || 0) - (inv.payments_total_cents || 0);
                }
            });
            
            tx.delete(paymentToDeleteRef);
            invoices.forEach(inv => {
                tx.update(inv.ref, { 
                    payments_total_cents: inv.payments_total_cents, 
                    status: inv.status 
                });
            });
            tx.update(clientRef, { 
                pending_ar_cents: newPendingTotalCents,
                credit: totalCreditFromPayments
            });
        });

        mostrarNotificacion("Pago eliminado y saldos recalculados.");
    }

    function setupConfirmationModal() {
        app.ui.confirmationModal = document.getElementById('confirmation-modal');
        app.ui.confirmationModal.querySelector('.modal-backdrop').addEventListener('click', closeConfirmationModal);
        document.getElementById('confirmation-cancel-btn').addEventListener('click', closeConfirmationModal);
        document.getElementById('confirmation-confirm-btn').addEventListener('click', () => {
            if (typeof confirmationCallback === 'function') {
                confirmationCallback();
            }
            closeConfirmationModal();
        });
    }

    function openConfirmationModal(message, onConfirm) {
        document.getElementById('confirmation-modal-message').textContent = message;
        confirmationCallback = onConfirm;
        app.ui.confirmationModal.classList.remove('hidden');
        app.ui.confirmationModal.classList.add('flex');
    }

    function closeConfirmationModal() {
        app.ui.confirmationModal.classList.add('hidden');
        app.ui.confirmationModal.classList.remove('flex');
        confirmationCallback = null;
    }

    function generateWelcomeMessageText(data) {
        const { cliente, pago, servicios } = data;
        let message = '';
        const formatDateLocal = (dateStr) => {
            if (!dateStr) return 'N/A';
            const [y, m, d] = dateStr.split('-');
            return `${d}/${m}/${y}`;
        }

        message += `¬°Nos llena de orgullo darte la bienvenida, ${cliente.nombre}! üëã\n\n`;
        message += `A partir de hoy, tu entretenimiento est√° en nuestras manos. Nuestro compromiso es ofrecerte una experiencia de streaming sin interrupciones y un soporte que realmente te escuche.\n\n`;
        
        const totalProfiles = servicios.reduce((acc, s) => acc + (s.perfiles ? s.perfiles.length : 0), 0);
        message += `Hemos activado ${totalProfiles} perfil(es) para ti desde el ${formatDateLocal(servicios[0]?.inicio_ciclo)}.\n\n`;

        servicios.forEach(s => {
            message += `‚Äî‚Äî‚Äî ${s.nombre} ‚Äî‚Äî‚Äî\n`;
            message += `‚Ä¢ Cuenta: ${s.cuenta_maestra.correo || '(pendiente)'}\n`;
            message += `‚Ä¢ Contrase√±a: ${s.cuenta_maestra.contrase√±a || '(pendiente)'}\n`;
            if (s.perfiles && s.perfiles.length > 0) {
                message += `‚Ä¢ Perfiles:\n`;
                s.perfiles.forEach(p => {
                    message += `  - ${p.nombre_perfil} (PIN: ${p.pin || 'N/A'})\n`;
                });
            } else {
                message += `‚Ä¢ Perfiles: Sin perfiles asignados (pendiente)\n`;
            }
            message += `\n`;
        });
        
        message += `‚Äî‚Äî‚Äî Reglas de Uso ‚Äî‚Äî‚Äî\n`;
        message += `‚Ä¢ No compartas tus credenciales fuera de tu hogar.\n`;
        message += `‚Ä¢ No cambies correo, contrase√±a ni PIN de otros perfiles.\n`;
        message += `‚Ä¢ No borres ni edites perfiles que no te pertenezcan.\n`;
        message += `‚Ä¢ Evita reproducir en m√°s de 2 dispositivos a la vez.\n`;
        message += `‚Ä¢ Reporta cualquier problema por WhatsApp antes de 24h.\n\n`;
        
        if (app.paymentMethods.length > 0) {
            message += `‚Äî‚Äî‚Äî M√©todos de Pago ‚Äî‚Äî‚Äî\n`;
            app.paymentMethods.forEach(pm => {
                message += `‚Ä¢ ${pm.name}: ${pm.details}\n`;
            });
            message += `\n`;
        } else if (pago && pago.link) {
            message += `Puedes realizar tu pago aqu√≠:\n${pago.link}\n\n`;
        }

        if (cliente.telefono) {
            message += `Estamos aqu√≠ para lo que necesites. ¬°No dudes en escribirnos!\n`;
        }
        
        message += `¬°Gracias por elegirnos y disfruta al m√°ximo tu entretenimiento!`;
        
        return message;
    }

    async function handleGenerateWelcomeMessage(serviceId, groupId) {
        const client = app.clients.find(c => c.id === app.selectedClientId);
        if (!client) return;

        const serviceInfo = app.services.find(s => s.id === serviceId);
        const group = getServiceGroups((client.services || {})[serviceId]).find(g => g.groupId === groupId);

        if (!serviceInfo || !group) return mostrarNotificacion("No se encontraron datos del servicio.", true);
        
        // Group profiles by master account
        const profilesByAccount = group.profiles.reduce((acc, profile) => {
            const accId = profile.master_account_id;
            if (!acc[accId]) {
                acc[accId] = [];
            }
            acc[accId].push(profile);
            return acc;
        }, {});

        const servicePayloads = Object.entries(profilesByAccount).map(([masterAccountId, profiles]) => {
            const masterAccount = app.masterAccounts.find(ma => ma.id === masterAccountId);
            return {
                id: serviceId,
                nombre: serviceInfo.name,
                cuenta_maestra: {
                    correo: masterAccount?.login_email || '(desconocido)',
                    contrase√±a: masterAccount?.password || '(desconocido)',
                },
                perfiles: profiles.map(p => ({
                    nombre_perfil: p.profile_name,
                    pin: p.pin,
                })),
                inicio_ciclo: group.date,
                precio_por_perfil: group.price
            };
        });
        
        const payload = {
            cliente: { nombre: client.name, telefono: client.phone },
            canal: "whatsapp",
            pago: { link: client.payment_link },
            servicios: servicePayloads,
        };
        
        const message = generateWelcomeMessageText(payload);
        
        openMessageModal({
            title: `Credenciales para ${serviceInfo.name}`,
            content: message,
            showOptions: false,
            showGenerateButton: false
        });

        const whatsappBtn = document.getElementById('whatsapp-message-btn');
        if (client.phone) {
            whatsappBtn.href = `https://wa.me/${client.phone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
            whatsappBtn.classList.remove('hidden');
        } else {
            whatsappBtn.classList.add('hidden');
        }
    }
    
    async function handleGenerateCombinedWelcomeMessage(client) {
        if (!client || !client.services || Object.keys(client.services).length === 0) {
            return mostrarNotificacion("Este cliente no tiene servicios activos para notificar.", true);
        }

        let allServicePayloads = [];
        let earliestStartDate = null;

        for (const [serviceId, serviceData] of Object.entries(client.services)) {
            const serviceInfo = app.services.find(s => s.id === serviceId);
            if (!serviceInfo) continue;
            
            const groups = getServiceGroups(serviceData);

            for (const group of groups) {
                if (!earliestStartDate || new Date(group.date) < new Date(earliestStartDate)) {
                    earliestStartDate = group.date;
                }

                const profilesByAccount = group.profiles.reduce((acc, profile) => {
                    const accId = profile.master_account_id;
                    if (!acc[accId]) acc[accId] = [];
                    acc[accId].push(profile);
                    return acc;
                }, {});

                Object.entries(profilesByAccount).forEach(([masterAccountId, profiles]) => {
                    const masterAccount = app.masterAccounts.find(ma => ma.id === masterAccountId);
                    allServicePayloads.push({
                        id: serviceId,
                        nombre: serviceInfo.name,
                        cuenta_maestra: {
                            correo: masterAccount?.login_email || '(desconocido)',
                            contrase√±a: masterAccount?.password || '(desconocido)',
                        },
                        perfiles: profiles.map(p => ({
                            nombre_perfil: p.profile_name,
                            pin: p.pin,
                        })),
                        inicio_ciclo: group.date,
                        precio_por_perfil: group.price
                    });
                });
            }
        }
        
        // Consolidate payloads by service name and account
        const consolidatedPayloads = allServicePayloads.reduce((acc, payload) => {
            const key = `${payload.nombre}-${payload.cuenta_maestra.correo}`;
            if (!acc[key]) {
                acc[key] = { ...payload, perfiles: [] };
            }
            acc[key].perfiles.push(...payload.perfiles);
            return acc;
        }, {});

        const finalPayloads = Object.values(consolidatedPayloads);
        if(finalPayloads.length > 0) {
            finalPayloads[0].inicio_ciclo = earliestStartDate;
        }


        const payload = {
            cliente: { nombre: client.name, telefono: client.phone },
            canal: "whatsapp",
            pago: { link: client.payment_link },
            servicios: finalPayloads,
        };

        const message = generateWelcomeMessageText(payload);
        
        openMessageModal({
            title: `Credenciales para todos los servicios`,
            content: message,
            showOptions: false,
            showGenerateButton: false
        });

        const whatsappBtn = document.getElementById('whatsapp-message-btn');
        if (client.phone) {
            whatsappBtn.href = `https://wa.me/${client.phone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
            whatsappBtn.classList.remove('hidden');
        } else {
            whatsappBtn.classList.add('hidden');
        }
    }

    function setupGlobalEventListeners() {
        document.addEventListener('click', async (e) => {
            const btn = e.target.closest('[data-role]');
            if (!btn) return;
            const role = btn.getAttribute('data-role');
            try {
                if (role === 'remove-client-profile') {
                    e.preventDefault(); e.stopPropagation();
                    openConfirmationModal("¬øQuitar este perfil?", () => {
                         handleRemoveClientProfile(btn.dataset.serviceId, btn.dataset.groupId, btn.dataset.profileId);
                    });
                }
                else if (role === 'remove-client-service') {
                    e.preventDefault(); e.stopPropagation();
                     openConfirmationModal("¬øQuitar este servicio y todos sus perfiles asociados?", () => {
                        handleRemoveServiceById(btn.dataset.serviceId);
                    });
                }
                else if (role === 'delete-service-type') {
                    e.preventDefault(); e.stopPropagation();
                    openConfirmationModal("¬øEliminar este servicio del cat√°logo? No podr√°s asignarlo a nuevos clientes.", () => {
                        handleDeleteServiceType(btn.dataset.id);
                    });
                }
                else if (role === 'edit-service-type') {
                    e.preventDefault(); e.stopPropagation();
                    openServiceCatalogModal(app.services.find(s => s.id === btn.dataset.id));
                }
                else if (role === 'delete-master-account') {
                    e.preventDefault(); e.stopPropagation();
                     openConfirmationModal("¬øEliminar esta cuenta maestra? Aseg√∫rate de que no tenga perfiles asignados.", () => {
                        handleDeleteMasterAccount(btn.dataset.id);
                    });
                }
                else if (role === 'delete-payment-method') {
                    e.preventDefault(); e.stopPropagation();
                    openConfirmationModal("¬øEliminar este m√©todo de pago?", () => {
                        handleDeletePaymentMethod(btn.dataset.id);
                    });
                }
                else if (role === 'edit-master-account') {
                    e.preventDefault(); e.stopPropagation();
                    openMasterAccountModal(app.masterAccounts.find(a => a.id === btn.getAttribute('data-id')));
                }
                else if (role === 'toggle-acc-group' || role === 'toggle-accordion') {
                    e.preventDefault(); e.stopPropagation();
                    const content = btn.nextElementSibling;
                    const icon = btn.querySelector('svg:last-child, .chev');
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                        icon?.classList.remove('rotate-180');
                    } else {
                        content.style.maxHeight = content.scrollHeight + "px";
                        icon?.classList.add('rotate-180');
                    }
                }
                else if (role === 'toggle-password') {
                    e.preventDefault(); e.stopPropagation();
                    const input = btn.previousElementSibling;
                    const eyeOpen = btn.querySelector('.eye-open');
                    const eyeClosed = btn.querySelector('.eye-closed');
                    if (input.type === 'password') { input.type = 'text'; eyeOpen.classList.add('hidden'); eyeClosed.classList.remove('hidden'); } 
                    else { input.type = 'password'; eyeOpen.classList.remove('hidden'); eyeClosed.classList.add('hidden'); }
                }
                 else if (role === 'copy-email') {
                    e.preventDefault(); e.stopPropagation();
                    navigator.clipboard.writeText(btn.previousElementSibling.value).then(() => mostrarNotificacion("Email copiado."));
                } else if (role === 'view-invoice') {
                    e.preventDefault(); e.stopPropagation();
                    const client = app.clients.find(c => c.id === app.selectedClientId);
                    if (!client) return;
                    const invoices = await listInvoices(client.id);
                    const invoice = invoices.find(i => i.id === btn.getAttribute('data-invoice-id'));
                    if (invoice) openInvoiceViewModal(invoice.content);
                } else if (role === 'quick-wa') {
                    const c = app.clients.find(x=>x.id===app.selectedClientId);
                    if(!c?.phone) return mostrarNotificacion("Sin WhatsApp.", true);
                    window.open(`https://wa.me/${c.phone.replace(/\D/g,'')}?text=${encodeURIComponent(`Hola ${c.name}, ¬øen qu√© puedo ayudarte?`)}`, '_blank');
                } else if (role === 'toggle-suspend') {
                    const c = app.clients.find(x=>x.id===app.selectedClientId);
                    if(!c) return;
                    const next = (c.status==='suspendido')?'activo':'suspendido';
                    await updateDoc(doc(app.db,'artifacts',app.appId,'users',app.userId,'clients',c.id),{ status: next });
                    mostrarNotificacion(`Cliente ${next}.`);
                } else if (role === 'go-to-client') {
                    e.preventDefault();
                    const clientId = btn.dataset.clientId;
                    renderView('clients', { clientId });
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('bg-slate-200', 'dark:bg-slate-700'));
                    document.querySelector('a[href="#clients"]').classList.add('bg-slate-200', 'dark:bg-slate-700');
                } else if(role === 'register-payment') {
                    openPaymentModal();
                } else if (role === 'delete-invoice') {
                    e.preventDefault(); e.stopPropagation();
                    openConfirmationModal("¬øEst√°s seguro de que quieres eliminar esta factura? Esta acci√≥n es irreversible.", () => {
                        handleDeleteInvoice(btn.dataset.invoiceId);
                    });
                } else if (role === 'delete-payment') {
                    e.preventDefault(); e.stopPropagation();
                    openConfirmationModal("¬øEst√°s seguro de que quieres eliminar este pago? Los saldos se recalcular√°n.", () => {
                       handleDeletePayment(btn.dataset.paymentId);
                    });
                } else if (role === 'generate-welcome') {
                    e.preventDefault(); e.stopPropagation();
                    handleGenerateWelcomeMessage(btn.dataset.serviceId, btn.dataset.groupId);
                }
            } catch(err) {
                console.error(err);
                mostrarNotificacion(err.message || 'Acci√≥n fallida', true);
            }
        });
    }

    // ======= Quick Actions: Nueva venta =======
    function setupSaleModal() {
        document.getElementById('sale-cancel').onclick = closeSaleModal;
        document.getElementById('sale-modal').querySelector('.modal-backdrop').onclick = closeSaleModal;
        document.getElementById('sale-client-select').addEventListener('change', (e) => {
            const isNew = e.target.value === '__new__';
            document.getElementById('sale-new-client').style.display = isNew ? 'grid' : 'none';
        });
        document.getElementById('sale-form').addEventListener('submit', handleSaleFormSubmit);
    }

    function openSaleModal(){
      const modal = document.getElementById('sale-modal');
      const sel = document.getElementById('sale-client-select');
      sel.innerHTML = '<option value="__new__">+ Nuevo cliente‚Ä¶</option>' + 
        app.clients.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
      const svcSel = document.getElementById('sale-service');
      svcSel.innerHTML = app.services.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
      document.getElementById('sale-date').valueAsDate = new Date();
      document.getElementById('sale-price').value = fromCents(app.services[0]?.cost_per_profile_cents || 0);
      document.getElementById('sale-new-client').style.display = 'grid';
      modal.classList.remove('hidden'); modal.classList.add('flex');
    }
    function closeSaleModal(){ const m=document.getElementById('sale-modal'); m.classList.add('hidden'); m.classList.remove('flex'); }
    
    async function handleSaleFormSubmit(e) {
        e.preventDefault();
        const submitter = e.target.querySelector('button[type="submit"]');
        setLoading(submitter, true, 'Guardar Venta');

        try {
            const sel = document.getElementById('sale-client-select');
            const isNew = sel.value === '__new__';
            let clientId = sel.value;
            let clientData;

            if (isNew) {
                const name = document.getElementById('sale-new-name').value.trim();
                if (!name) throw new Error('Ingresa el nombre del nuevo cliente');
                
                const newClientPayload = {
                    name,
                    phone: document.getElementById('sale-phone').value.trim(),
                    status: 'activo',
                    tags: (document.getElementById('sale-new-tags').value || '').split(',').map(x => x.trim()).filter(Boolean),
                    credit: toCents(document.getElementById('sale-new-credit').value || 0),
                    services: {},
                    pending_ar_cents: 0,
                };
                const docRef = await addDoc(collection(app.db, 'artifacts', app.appId, 'users', app.userId, 'clients'), newClientPayload);
                clientId = docRef.id;
                clientData = { id: clientId, ...newClientPayload };
            } else {
                clientData = app.clients.find(c => c.id === clientId);
            }

            if (!clientData) throw new Error("Cliente no encontrado.");

            const serviceId = document.getElementById('sale-service').value;
            const qty = Math.max(1, parseInt(document.getElementById('sale-qty').value || '1', 10));
            const price = parseFloat(document.getElementById('sale-price').value || 0);
            const date = document.getElementById('sale-date').value;
            const createInvoice = document.getElementById('sale-create-invoice').checked;
            const genMsg = document.getElementById('sale-generate-msg').checked;
            const paylink = document.getElementById('sale-paylink').value.trim();
            
            if (paylink) {
                clientData.payment_link = paylink; // Update local object
                await updateDoc(doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'clients', clientId), { payment_link: paylink });
            }

            // A bit of a hack, but re-use the service form logic
            // This is a simplified version for quick sales
            const mockServiceForm = new FormData();
            mockServiceForm.append('serviceId', serviceId);
            mockServiceForm.append('price', price);
            mockServiceForm.append('date', date);
            for(let i=0; i<qty; i++) {
                mockServiceForm.append('profile_name[]', `Perfil ${i+1}`);
                mockServiceForm.append('profile_pin[]', '');
                mockServiceForm.append('profile_account[]', '');
            }
            app.selectedClientId = clientId; // Set context for service handler
            await handleServiceFormSubmit({ preventDefault: () => {}, target: { elements: { serviceId: {value: serviceId}, price: {value: price}, date: {value: date} }, getElementsByTagName:()=>[], querySelectorAll:()=>[], getAttribute:()=>null, dataset:{}, ...Object.fromEntries(mockServiceForm) }});
            
            if (createInvoice) {
                const total = price * qty;
                const invoice = {
                    amount_cents: toCents(total),
                    issued_at: Timestamp.fromDate(new Date(date)),
                    due_date: Timestamp.fromDate(new Date(date)),
                    status: 'pendiente',
                    payments_total_cents: 0,
                    content: `Factura por ${qty} perfil(es) de ${app.services.find(s=>s.id===serviceId).name}.`
                };
                await addInvoice(clientId, invoice);
            }

            if (genMsg) {
                // We need to refetch the client data to get the newly added service profiles
                const freshClientDoc = await getDoc(doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'clients', clientId));
                const freshClientData = {id: freshClientDoc.id, ...freshClientDoc.data()};
                await handleGenerateCombinedWelcomeMessage(freshClientData);
            }

            mostrarNotificacion('Venta registrada correctamente.');
            closeSaleModal();
            renderView('clients', { clientId: clientId });
        } catch (error) {
            console.error("Error en venta:", error);
            mostrarNotificacion(error.message || "Error al procesar la venta.", true);
        } finally {
            setLoading(submitter, false, 'Guardar Venta');
        }
    }

    // --- Charts ---
    function renderDashboardCharts() {
        renderServicesChart();
        renderIncomeChart();
    }

    function renderServicesChart() {
        const ctx = document.getElementById('services-chart')?.getContext('2d');
        if (!ctx) return;
        
        const serviceCounts = app.clients.reduce((acc, client) => {
            if (client.services) {
                Object.keys(client.services).forEach(serviceId => {
                    acc[serviceId] = (acc[serviceId] || 0) + 1;
                });
            }
            return acc;
        }, {});

        const labels = Object.keys(serviceCounts).map(id => app.services.find(s => s.id === id)?.name || 'Desconocido');
        const data = Object.values(serviceCounts);
        
        if (chartInstances.services) chartInstances.services.destroy();
        chartInstances.services = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Clientes por Servicio',
                    data: data,
                    backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#6366f1'],
                    hoverOffset: 4
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }
    
    async function renderIncomeChart() {
         const ctx = document.getElementById('income-chart')?.getContext('2d');
        if (!ctx) return;

        const paymentsByMonth = {};
        const months = Array.from({length: 6}, (_, i) => {
            const d = new Date();
            d.setMonth(d.getMonth() - i);
            return { key: `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`, label: d.toLocaleString('es-PA', { month: 'short' }) };
        }).reverse();

        months.forEach(m => paymentsByMonth[m.key] = 0);

        const allPayments = (await Promise.all(
            app.clients.map(c => getDocs(collection(app.db, 'artifacts', app.appId, 'users', app.userId, 'clients', c.id, 'payments')))
        )).flatMap(snap => snap.docs.map(d => d.data()));

        allPayments.forEach(payment => {
            const date = payment.received_at.toDate();
            const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            if (paymentsByMonth.hasOwnProperty(key)) {
                paymentsByMonth[key] += (payment.amount_cents || 0);
            }
        });

        const labels = months.map(m => m.label);
        const data = months.map(m => fromCents(paymentsByMonth[m.key]));

        if (chartInstances.income) chartInstances.income.destroy();
        chartInstances.income = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Ingresos Registrados',
                    data: data,
                    backgroundColor: 'rgba(59, 130, 246, 0.5)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, ticks: { callback: value => '$' + value } } }
            }
        });
    }
    function setupServiceCatalogModal() {
        app.ui.serviceCatalogModal = document.getElementById('service-catalog-modal');
        app.ui.serviceCatalogModal.querySelector('.modal-backdrop').addEventListener('click', closeServiceCatalogModal);
        document.getElementById('service-catalog-modal-cancel-btn').addEventListener('click', closeServiceCatalogModal);
        document.getElementById('service-catalog-form').addEventListener('submit', handleServiceCatalogFormSubmit);
    }
    function openServiceCatalogModal(service = null) {
        const form = document.getElementById('service-catalog-form');
        form.reset();
        selectedServiceCatalogId = service ? service.id : null;
        document.getElementById('service-catalog-modal-title').textContent = service ? 'Editar Servicio del Cat√°logo' : 'A√±adir Servicio al Cat√°logo';
        
        if (service) {
            form.elements.name.value = service.name || '';
            form.elements.seat_limit.value = service.seat_limit || 1;
            form.elements.pin_length.value = service.pin_length || 0;
            form.elements.cost_per_profile.value = fromCents(service.cost_per_profile_cents);
            form.elements.billing_cycle_days.value = service.billing_cycle_days || 30;
            form.elements.isNetflix.checked = service.isNetflix || false;
        }
        
        app.ui.serviceCatalogModal.classList.remove('hidden');
        app.ui.serviceCatalogModal.classList.add('flex');
    }
    function closeServiceCatalogModal() {
        app.ui.serviceCatalogModal.classList.add('hidden');
        app.ui.serviceCatalogModal.classList.remove('flex');
        selectedServiceCatalogId = null;
    }
    async function handleServiceCatalogFormSubmit(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const payload = {
            name: formData.get('name').trim(),
            seat_limit: parseInt(formData.get('seat_limit')) || 1,
            pin_length: parseInt(formData.get('pin_length')) || 0,
            cost_per_profile_cents: toCents(formData.get('cost_per_profile')),
            billing_cycle_days: parseInt(formData.get('billing_cycle_days')) || 30,
            isNetflix: formData.get('isNetflix') === 'on'
        };

        if (selectedServiceCatalogId) {
            await updateDoc(doc(app.db, 'artifacts', app.appId, 'users', app.userId, 'services', selectedServiceCatalogId), payload);
            mostrarNotificacion("Servicio actualizado.");
        } else {
            // This case is handled by the other form, but kept for safety
            await addDoc(collection(app.db, 'artifacts', app.appId, 'users', app.userId, 'services'), payload);
            mostrarNotificacion("Servicio a√±adido.");
        }
        closeServiceCatalogModal();
    }


</script>
</body>
</html>

